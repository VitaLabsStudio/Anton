# docker/docker-compose.prod.yml - Production Overrides
#
# Adds resource limits, security hardening, and production optimizations.
#
# Usage:
#   docker-compose -f docker/docker-compose.yml -f docker/docker-compose.prod.yml up -d

services:
  # PostgreSQL with resource limits
  postgres:
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '0.5'
    logging:
      driver: 'json-file'
      options:
        max-size: '100m'
        max-file: '5'

  # Backend API with production settings
  backend-api:
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: 'json-file'
      options:
        max-size: '50m'
        max-file: '3'
    # Don't expose port externally in production (use cloudflared)
    ports: []
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  # Backend Worker with production settings
  backend-worker:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
    logging:
      driver: 'json-file'
      options:
        max-size: '50m'
        max-file: '3'
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  # Dashboard with production settings
  dashboard:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.1'
    logging:
      driver: 'json-file'
      options:
        max-size: '50m'
        max-file: '3'
    # Don't expose port externally in production (use cloudflared)
    ports: []
    security_opt:
      - no-new-privileges:true

  # Cloudflared enabled in production
  cloudflared:
    profiles: [] # Remove profile restriction - always run in prod
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
