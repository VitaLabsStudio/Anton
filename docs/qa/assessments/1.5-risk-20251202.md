# **Enhanced** Risk Profile: Story 1.5: Reddit API Authentication

**Date**: 2025-12-02  
**Reviewer**: Quinn (Senior Test Architect)  
**Status**: Updated & Finalized for Architect Review

## 1. Executive Summary

This enhanced risk profile for Story 1.5 addresses the Reddit API integration. The initial assessment correctly identified a **critical performance flaw** (`TECH-001`) and the reuse of a **flawed architectural pattern** (`OPS-001`). This update provides the **exact, prescriptive code-level mitigations** required to fix these issues.

The most severe risks are **Credential Leakage (SEC-001, CRITICAL)** and two major implementation flaws that would render the service non-functional: making N requests instead of 1 for subreddit searches and reusing a blocking rate limiter. This assessment provides the complete, corrected code for the Architect Agent to integrate into the story's `Dev Notes`.

- **Total Risks Identified**: 5
- **Critical Risks (Score 9)**: 1
- **High Risks (Score 6-8)**: 3
- **Medium Risks (Score 4-5)**: 1
- **Overall Assessment**: **NO-GO**. The story is critically flawed as written and requires the Architect Agent to implement these detailed mitigations.

## 2. Detailed Risk Register

| Risk ID | Description | Category | Probability (1-3) | Impact (1-3) | Score (PÃ—I) | Priority |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **SEC-001** | **Leaked Reddit Refresh Token via Git Commit** | Security | 3 (High) | 3 (High) | **9** | **CRITICAL** |
| **TECH-001**| **10x API Over-use due to Inefficient Search Loop**| Performance| 3 (High) | 2 (Medium) | **6** | **HIGH** |
| **OPS-001** | **Server Hang due to Reusing Flawed Rate Limiter** | Operational | 3 (High) | 2 (Medium) | **6** | **HIGH** |
| **BUS-001** | **Account Ban due to Violating Subreddit Rules** | Business | 2 (Medium) | 3 (High) | **6** | **HIGH** |
| **TECH-002**| **Service Outage on Refresh Token Expiration** | Technical | 1 (Low) | 3 (High) | **3** | **MEDIUM** |

---

## 3. Actionable Mitigation & Implementation Plan

**This section is for the Architect Agent.** Copy the following subsections directly into the `Dev Notes` of `1.5.story.md`, replacing the existing `Risk Mitigation Strategies` section.

---

### **CRITICAL RISK: Credential Leakage (SEC-001)**
**Problem**: A leaked Reddit `refresh_token` provides an attacker with permanent access to the account until it's manually revoked.

**Mitigation & Implementation**:
1.  **Use Centralized Secret Management**: Covered in Story 1.3, but must be reinforced here.
2.  **Implement Reddit-Specific Secret Scanning**: Add a `gitleaks` rule to specifically detect the format of Reddit refresh tokens.
    *   **Action**: Add this rule to `.gitleaks.toml`:
        ```toml
        [[rules]]
        id = "reddit-refresh-token"
        description = "Reddit Refresh Token"
        # Catches the long, URL-safe base64 string characteristic of refresh tokens
        regex = '''[a-zA-Z0-9_-]{20,}_[a-zA-Z0-9_-]{20,}'''
        tags = ["key", "reddit", "token"]
        # Keywords to reduce false positives
        keywords = ["refreshToken", "reddit"]
        ```
3.  **Create a Secure Auth Module**: Validate credentials on startup and never log the full tokens.
    *   **Action**: Create `backend/src/platforms/reddit/auth.ts`:
        ```typescript
        import { logger } from '../../utils/logger';
        
        export function validateRedditCredentials() {
          const { REDDIT_CLIENT_ID, REDDIT_CLIENT_SECRET, REDDIT_REFRESH_TOKEN } = process.env;
          if (!REDDIT_CLIENT_ID || !REDDIT_CLIENT_SECRET || !REDDIT_REFRESH_TOKEN) {
            throw new Error('FATAL: Missing required Reddit credentials.');
          }
          logger.info('Reddit credentials validated successfully.');
          return {
            clientId: REDDIT_CLIENT_ID,
            clientSecret: REDDIT_CLIENT_SECRET,
            refreshToken: REDDIT_REFRESH_TOKEN,
          };
        }
        
        export const redditCredentials = validateRedditCredentials();
        ```

### **HIGH RISK: Inefficient Subreddit Searching (TECH-001)**
**Problem**: The original design makes one API request *per subreddit*, which is massively inefficient and will exhaust the rate limit almost instantly. Searching 10 subreddits would make 10 API calls instead of 1.

**Mitigation & Implementation**:
1.  **Refactor to Use Multi-Subreddit Queries**: The Reddit API allows searching multiple subreddits in a single call by joining their names with a `+`. The `snoowrap` library supports this directly.
    *   **Action**: The `searchSubreddits` method in the `RedditClient` class **MUST** be implemented as follows:
        ```typescript
        // In RedditClient class
        async searchSubreddits(subreddits: string[], query: string): Promise<Snoowrap.Submission[]> {
          // Join subreddits for a single, efficient API call. E.g., "hangover+nutrition"
          const subredditQuery = subreddits.join('+');
          
          logger.info({ subredditQuery, query }, 'Executing multi-subreddit search.');

          return redditRateLimiter.scheduleRead(() => 
            this.circuitBreaker.execute(() => 
              this.client.getSubreddit(subredditQuery).search({
                query,
                time: 'day',
                sort: 'new',
                limit: 100, // Max per request
              })
            )
          );
        }
        ```

### **HIGH RISK: Reusing Flawed Rate Limiter (OPS-001)**
**Problem**: The story assumes reuse of the flawed, `sleep()`-based rate limiter from the original Story 1.4, which would block the server.

**Mitigation & Implementation**:
1.  **Use the Correct, Non-Blocking Rate Limiter**: This story must use the `bottleneck`-based `RateLimiter` class defined in the updated Story 1.4 assessment.
2.  **Instantiate a Reddit-Specific Limiter**: Create a new instance of the `RateLimiter` configured for Reddit's limits.
    *   **Action**: Add this to `backend/src/utils/rate-limiter.ts`:
        ```typescript
        // At the bottom of rate-limiter.ts, after the twitterRateLimiter export

        export const redditRateLimiter = new RateLimiter({
          // Reddit API allows 60 requests per minute
          read: { maxRequests: 60, windowMs: 60 * 1000 },
          // Use a more conservative limit for writes
          write: { maxRequests: 30, windowMs: 60 * 1000 },
        });
        ```
    *   **Action**: Ensure the `RedditClient` imports and uses `redditRateLimiter`, not `twitterRateLimiter`.

### **HIGH RISK: Banned for Violating Subreddit Rules (BUS-001)**
**Problem**: Each subreddit has its own rules. Automated posting without respecting these rules will get the bot's account (`u/antone_vita`) banned, damaging the brand.

**Mitigation & Implementation**:
1.  **Implement a Subreddit Allowlist**: Create a configuration file that acts as a gate, ensuring no action is taken in a subreddit until its rules have been manually reviewed and approved.
    *   **Action**: Create `backend/src/platforms/reddit/subreddit.config.ts`:
        ```typescript
        import { logger } from '../../utils/logger';

        interface SubredditConfig {
          rulesReviewed: boolean;
          allowComments: boolean;
          // Add other specific rules, e.g., required comment length, etc.
        }

        // Default to everything being disabled.
        const SubredditAllowlist: Record<string, SubredditConfig> = {
          'hangover': { rulesReviewed: true, allowComments: true },
          'askreddit': { rulesReviewed: true, allowComments: false }, // Example: read-only
        };

        export function isActionAllowed(subreddit: string, action: 'comment' | 'search'): boolean {
          const config = SubredditAllowlist[subreddit.toLowerCase()];
          if (!config?.rulesReviewed) {
            logger.warn({ subreddit, action }, 'Action blocked: subreddit not reviewed.');
            return false;
          }
          if (action === 'comment' && !config.allowComments) {
            logger.warn({ subreddit, action }, 'Action blocked: commenting disabled for subreddit.');
            return false;
          }
          return true;
        }
        ```
    *   **Action**: All methods in `RedditClient` (like `searchSubreddits` and `comment`) must call `isActionAllowed` before making an API request.

### **MEDIUM RISK: Service Outage on Token Expiration (TECH-002)**
**Problem**: While `snoowrap` handles token refreshes, the underlying refresh token can be revoked or expire, causing all subsequent API calls to fail permanently until manual intervention.

**Mitigation & Implementation**:
1.  **Create a Global Auth Error Handler**: Wrap API calls in a try/catch block that specifically looks for authentication-related errors and can disable the client to prevent cascading failures.
    *   **Action**: Add this private method to the `RedditClient` class:
        ```typescript
        // In RedditClient class
        private handleAuthError(error: any): never {
          // "invalid_grant" is the OAuth error for an expired/revoked refresh token
          if (error?.message?.includes('invalid_grant') || error.statusCode === 401) {
            logger.fatal({ error }, 'CRITICAL: Reddit refresh token is invalid. Disabling Reddit client. Manual re-authentication is required.');
            // This would disable the client, preventing further calls.
            // A more robust implementation could emit an event.
            process.env.REDDIT_ENABLED = 'false';
          }
          throw error; // Re-throw the original error after logging
        }
        ```
    *   **Action**: All public methods in `RedditClient` should be wrapped in a `try...catch` that calls this handler.
        ```typescript
        async getKarma(): Promise<number> {
          try {
            // ... API call logic ...
          } catch (error) {
            this.handleAuthError(error);
          }
        }
        ```

---
## 4. Final Recommendation

Story 1.5 is **NO-GO**. The inefficient search logic is a critical performance bug that must be fixed. The Architect Agent must replace the `Dev Notes` in the story with the detailed mitigations from this assessment, focusing on the corrected `searchSubreddits` implementation and the integration of the subreddit allowlist.