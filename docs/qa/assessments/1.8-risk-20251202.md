# Enhanced Risk Profile: Story 1.8: Health Check & Monitoring

**Date**: 2025-12-02  
**Reviewer**: Quinn (Test Architect)  
**Status**: Updated & Finalized for Architect Review

## 1. Executive Summary

Story 1.8 (Health Check) proposes a monitoring endpoint that, while useful, introduces significant security and performance risks if implemented as a naive, real-time check. Exposing detailed internal state invites reconnaissance, and running heavy dependency checks on every HTTP request can degrade the system it is meant to monitor.

This assessment mandates a **cached, background-check architecture** and strict **access controls** to ensure the monitoring system is safe and scalable.

- **Total Risks Identified**: 5
- **High Risks (Score 6)**: 4
- **Low Risks (Score 3)**: 1
- **Overall Assessment**: **CONDITIONAL GO**. The story can proceed only if the architecture is updated to use caching and IP/Auth restrictions as defined below.

## 2. Detailed Risk Register

| Risk ID | Description | Category | Probability (1-3) | Impact (1-3) | Score (PÃ—I) | Priority |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **SEC-001** | **Information Leakage via Detailed Health Check** | Security | 3 (High) | 2 (Medium) | **6** | **HIGH** |
| **PERF-001** | **System Degradation from Live Checks** | Performance | 3 (High) | 2 (Medium) | **6** | **HIGH** |
| **TECH-001** | **False Negative Worker Health Status** | Reliability | 3 (High) | 2 (Medium) | **6** | **HIGH** |
| **TECH-002** | **Over-Complex Learning Metrics** | Complexity | 3 (High) | 2 (Medium) | **6** | **HIGH** |
| **PERF-002** | **Flawed Timeout Implementation** | Performance | 3 (High) | 1 (Low) | **3** | **LOW** |

---

## 3. Actionable Mitigation & Implementation Plan

**This section is for the Architect Agent.** The following architectural patterns and implementations must be integrated into the `Dev Notes` and `Tasks` of Story 1.8.

---

### **HIGH RISK: System Degradation from Live Checks (PERF-001)**
**Problem**: If the health endpoint triggers real DB queries and API calls on every request, a monitoring system polling every 5 seconds could saturate the database connection pool or rate limit the external APIs.

**Mitigation & Implementation**:
1.  **Decouple Checks from Requests (Caching)**: The `HealthCheckService` must run checks in the background on a timer (e.g., every 30-60 seconds) and store the result in memory. The HTTP endpoint simply serves the latest cached JSON.
    *   **Action**: Implement the "Background Refresh" pattern in `HealthCheckService`:
        ```typescript
        // backend/src/services/health-check.ts
        export class HealthCheckService {
          private lastResult: HealthCheckResult | null = null;
          private readonly REFRESH_INTERVAL = 60000; // 60 seconds

          constructor() {
            // Start background timer
            setInterval(() => this.runChecks(), this.REFRESH_INTERVAL);
            this.runChecks(); // Initial run
          }

          async getHealth(): Promise<HealthCheckResult> {
            if (!this.lastResult) {
               // Fallback for first boot
               await this.runChecks();
            }
            return this.lastResult!;
          }

          private async runChecks() {
             // ... perform heavy checks here ...
             this.lastResult = newResults;
          }
        }
        ```

### **HIGH RISK: Information Leakage (SEC-001)**
**Problem**: The `/health/detailed` endpoint exposes software versions, database latency, and internal component status. This is a goldmine for attackers performing reconnaissance.

**Mitigation & Implementation**:
1.  **Strict Access Control**:
    *   **Public Endpoint (`/health`)**: Returns ONLY `status: "ok"`. No versions, no details.
    *   **Private Endpoint (`/health/detailed`)**: Protected by **Authentication Middleware** AND **IP Whitelist** (optional but recommended).
    *   **Action**: Update the Hono route definition:
        ```typescript
        // backend/src/api/routes/health.ts
        
        // Public - Safe for load balancers
        app.get('/health', (c) => c.json({ status: 'ok' }));

        // Protected - For internal dashboards/SREs
        app.get('/health/detailed', authMiddleware, requireAdminRole, async (c) => {
          const result = await healthService.getHealth();
          return c.json(result);
        });
        ```

### **HIGH RISK: False Negative Worker Health (TECH-001)**
**Problem**: Relying solely on a `lastPollAt` timestamp is insufficient. A worker might update the timestamp but be stuck in a logic loop, processing zero records.

**Mitigation & Implementation**:
1.  **Heartbeat with Activity Metrics**: The worker must report *activity*, not just existence.
    *   **Action**: Update the worker to write a "heartbeat" record to Redis or DB that includes `posts_processed_last_minute`.
    *   **Action**: The Health Check should warn if `last_poll` is recent BUT `posts_processed` is 0 for an extended period (indicating a potential logic freeze or empty queue issue).

### **HIGH RISK: Over-Complex Learning Metrics (TECH-002)**
**Problem**: Trying to calculate "Meta-learning accuracy" or "Statistical power" in a real-time health check is computationally expensive and statistically noisy.

**Mitigation & Implementation**:
1.  **Simplify to Pipeline Health**:
    *   **Action**: Remove complex data science metrics from the health check.
    *   **Action**: Focus on **Data Pipeline Integrity**:
        *   "Are new rows being added to the `learning_events` table?"
        *   "Is the `weight_adjustments` table being updated daily?"
        *   "Are there any orphaned records?"
    *   Move the complex analysis to an offline Metabase/Grafana dashboard, not the operational health check.

---

## 4. Final Recommendation

Story 1.8 is **CONDITIONAL GO**. The Architect must modify the tasks to implement the **Background Refresh / Caching pattern** for the `HealthCheckService`. Without this, the health check itself becomes a denial-of-service vector. The security restrictions on the detailed endpoint are also mandatory.