# Test Design Document - Story 2.6
## Safety Protocol with Tiered Severity & Context Assessment

**Review Date:** 2025-12-06
**Reviewed By:** Quinn (Test Architect)
**Story:** 2.6 - Primary Safety Protocol
**Test Design Version:** 1.1 (Corrected)

---

## Executive Summary

### Test Coverage Status: ⚠️ CONCERNS

| Test Level | Coverage | Status | Critical Gaps |
|------------|----------|--------|---------------|
| Unit Tests | 60/70 scenarios | ✓ GOOD | Missing 10 edge cases from AC |
| LLM Integration | 0% (stubs only) | ⚠️ GAP | No real API validation |
| Integration Tests | 4/10 scenarios | ⚠️ PARTIAL | Missing full decision flow tests |
| E2E Tests | 0/5 scenarios | ⛔ MISSING | No end-to-end validation |
| Contract Tests | 0% | ⛔ MISSING | No API contract validation |

**Overall Test Quality:** ⚠️ CONCERNS - Good scenario coverage but critical gaps in real LLM validation

**Key Finding:** The system relies on external LLM APIs (DeepSeek, OpenAI) but lacks contract tests to verify these integrations. While the code is correct, this testing gap poses a risk for future API changes.

---

## 1. Current Test Coverage Analysis

### 1.1 Unit Tests - CRITICAL Tier

**File:** `backend/tests/unit/analysis/safety-protocol.test.ts`

#### Suicide/Self-Harm Detection ✓
**Coverage:** 10/10 scenarios (100%)

| Test Case | Content Example | Expected Outcome |
|-----------|----------------|------------------|
| Explicit intent | "I want to kill myself tonight" | CRITICAL, disengage |
| Thinking about | "Thinking about ending it all" | CRITICAL, disengage |
| Can't go on | "I can't go on anymore" | CRITICAL, disengage |
| Better off dead | "better off dead than this" | CRITICAL, disengage |
| No reason to live | "no reason to live today" | CRITICAL, disengage |
| Harm myself | "going to harm myself" | CRITICAL, disengage |
| Ending it all | "ending it all seems easiest" | CRITICAL, disengage |
| Want to hurt | "want to hurt myself over this" | CRITICAL, disengage |
| Not worth living | "my life is not worth living" | CRITICAL, disengage |
| Kill myself | "can't go on, will kill myself" | CRITICAL, disengage |

**Assessment:** ✓ EXCELLENT - All AC2a patterns covered

---

#### Alcohol Poisoning Detection ✓
**Coverage:** 10/10 scenarios (100%)

| Test Case | Content Example | Expected Outcome |
|-----------|----------------|------------------|
| Can't stop vomiting | "Can't stop vomiting after shots" | CRITICAL, disengage |
| Vomited blood | "vomited blood tonight" | CRITICAL, disengage |
| Blacked out | "blacked out on the floor" | CRITICAL, disengage |
| Passed out | "he passed out and is unconscious" | CRITICAL, disengage |
| Cold and clammy | "hands are cold and clammy" | CRITICAL, disengage |
| Slow breathing | "slow shallow breathing" | CRITICAL, disengage |
| Hypothermia | "signs of hypothermia from alcohol" | CRITICAL, disengage |
| Pale skin | "skin looks pale" | CRITICAL, disengage |
| Confused | "confused and can't stand up" | CRITICAL, disengage |
| Choked on vomit | "friend choked on vomit" | CRITICAL, disengage |

**Assessment:** ✓ EXCELLENT - All AC2b patterns covered

---

#### Medical Emergency Detection ✓
**Coverage:** 5/5 scenarios (100%)

| Test Case | Content Example | Expected Outcome |
|-----------|----------------|------------------|
| Calling 911 | "calling 911 because of this pain" | CRITICAL, disengage |
| Emergency room | "headed to the emergency room" | CRITICAL, disengage |
| Ambulance | "an ambulance is on the way" | CRITICAL, disengage |
| Chest pain | "severe chest pain after drinking" | CRITICAL, disengage |
| Can't breathe | "I can't breathe and feel faint" | CRITICAL, disengage |

**Assessment:** ✓ GOOD - All AC2c core patterns covered
**Gap:** Missing patterns for heart attack, stroke, internal bleeding (defined in AC but not tested)

---

#### Abnormal Severity Detection ✓
**Coverage:** 5/5 scenarios (100%)

| Test Case | Content Example | Expected Outcome |
|-----------|----------------|------------------|
| Day 4 | "this hangover has been 4 days now" | CRITICAL, disengage |
| Third day | "third day and worse than ever" | CRITICAL, disengage |
| Can't walk | "I can't walk or stand straight" | CRITICAL, disengage |
| Vision problems | "vision is blurry and seeing double" | CRITICAL, disengage |
| Hallucinating | "hallucinating and shaking" | CRITICAL, disengage |

**Assessment:** ✓ GOOD - Core AC2e patterns covered
**Gap:** Missing patterns for tremors, withdrawal (defined in AC but not tested)

---

#### Distress Probability Factors ✓
**Coverage:** 4/5 factors tested

| Factor | Test Coverage | Status |
|--------|--------------|--------|
| Factor 1: Severity-based base | Implicit in all CRITICAL tests | ✓ TESTED |
| Factor 2: Multiple flags | Explicit test (line 162-167) | ✓ TESTED |
| Factor 3: LLM assessment | Tested in llm.test.ts | ✓ TESTED |
| Factor 4: Intensifiers | Explicit test (line 190-196) | ✓ TESTED |
| Factor 5: Author history | Explicit test (line 169-178) | ✓ TESTED |

**Assessment:** ✓ EXCELLENT - All 5 factors have test coverage

---

### 1.2 Unit Tests - HIGH/MEDIUM Tier with LLM

**File:** `backend/tests/unit/analysis/safety-protocol.llm.test.ts`

#### Genuine Concern Cases ✓
**Coverage:** 10/10 scenarios (100%)

| Test Case | Content Example | Severity | LLM Response |
|-----------|----------------|----------|--------------|
| Pregnancy + drinking | "I'm pregnant and drank wine" | HIGH | A genuine concern |
| Breastfeeding | "breastfeeding and feel dizzy" | HIGH | A genuine concern |
| Warfarin interaction | "On warfarin and had shots" | HIGH | A genuine concern |
| Antidepressant | "Taking antidepressant, drank heavily" | HIGH | A genuine concern |
| Liver disease | "liver disease patient drank" | HIGH | A genuine concern |
| Kidney problems | "kidney problems and went hard" | HIGH | A genuine concern |
| Sobriety risk | "5 months sober, worried about relapse" | HIGH | A genuine concern |
| AA meeting | "going to AA meeting after binge" | HIGH | A genuine concern |
| In hospital | "in the hospital because of this" | MEDIUM | A genuine concern |
| Dying please help | "I'm dying please help" | MEDIUM | A genuine concern |

**Assessment:** ✓ EXCELLENT - Covers all HIGH/MEDIUM categories from AC

---

#### Hyperbole Cases ✓
**Coverage:** 10/10 scenarios (100%)

| Test Case | Content Example | Expected Classification |
|-----------|----------------|------------------------|
| Dying from hangover | "I'm dying from this hangover lol" | B HYPERBOLE |
| Feel like death | "feel like death after last night" | B HYPERBOLE |
| Killing me | "this is killing me slowly" | B HYPERBOLE |
| Funeral for liver | "funeral for my liver tomorrow" | B HYPERBOLE |
| High school cafeteria | "high school cafeteria food is killing me" | B HYPERBOLE |
| Nurse mention | "nurse said it was dehydration" | B HYPERBOLE |
| Doctor appointment | "doctor appointment next week" | B HYPERBOLE |
| High school reunion | "high school reunion hangover" | B HYPERBOLE |
| Freshman dorm | "college freshman dorm party jokes" | B HYPERBOLE |
| Killing liver joke | "just a joke about killing my liver" | B HYPERBOLE |

**Assessment:** ✓ EXCELLENT - Good coverage of false positive scenarios

---

#### Casual Mention Cases ✓
**Coverage:** 10/10 scenarios (100%)

| Test Case | Content Example | Expected Classification |
|-----------|----------------|------------------------|
| Wife pregnant | "My wife is pregnant and enjoyed mocktail" | C CASUAL_MENTION |
| Brother's insulin | "Brother on insulin years ago" | C CASUAL_MENTION |
| Grandma's history | "Grandma had liver disease, miss her" | C CASUAL_MENTION |
| Friend in rehab | "Friend in rehab years back" | C CASUAL_MENTION |
| Hospital cafeteria | "Hospital cafeteria coffee terrible" | C CASUAL_MENTION |
| Doctor on TV | "doctor on TV said stay hydrated" | C CASUAL_MENTION |
| Nurse costume | "nurse costume party last night" | C CASUAL_MENTION |
| High school reunion | "high school reunion last night" | C CASUAL_MENTION |
| Freshman memories | "freshman year memories hit hard" | C CASUAL_MENTION |
| Death kidding | "feels like death but just kidding" | C CASUAL_MENTION |

**Assessment:** ✓ EXCELLENT - Good coverage of third-party/historical mentions

---

### 1.3 Integration Tests

**File:** `backend/tests/integration/analysis/safety-protocol.integration.test.ts`

#### Current Coverage: 4 scenarios

| Test Case | What It Tests | Status |
|-----------|--------------|--------|
| LLM fallback failure | Conservative fallback when both LLMs fail | ✓ COVERED |
| Audit logging | Full audit log with reasoning | ✓ COVERED |
| Resources & disclaimer | CRITICAL tier includes resources | ✓ COVERED |
| Multiple categories | Highest severity wins | ✓ COVERED |

**Assessment:** ⚠️ PARTIAL - Basic integration covered, but missing:
- Full decision engine flow (safety → mode selection)
- Metrics emission validation
- Latency measurement
- Resource escalation for different categories
- Database persistence

---

### 1.4 E2E Tests

**Status:** ⛔ MISSING

**Required E2E Tests (from AC, lines 823-827):**
1. End-to-end decision flow with safety override
2. Dashboard displays safety flags
3. Audit trail searchable by safety category
4. Full integration with all signals
5. User-facing safety response

**Impact of Missing E2E:** Cannot verify that safety protocol works correctly in production environment

---

## 2. Critical Test Gaps

### 2.1 No Real LLM API Validation ⚠️ HIGH

**Issue:** All tests use `StubLlmClient` which returns predetermined responses.

**Evidence:**
```typescript
// safety-protocol.llm.test.ts:26-44
class StubLlmClient {
  async generate(): Promise<{ content: string; ... }> {
    return { content: this.response, ... };  // ❌ Always succeeds
  }
}
```

**What's NOT Tested:**
- DeepSeek API actually returns valid responses
- GPT-5 Nano model availability and connection
- API error handling (404, 500, timeout)
- Actual LLM response parsing
- Rate limiting behavior
- Network failures

**Impact:** **HIGH** - Risks API integration issues in production.

**Recommended Fix:**

**Option A: Contract Tests with Real APIs**
```typescript
describe('OpenAI Contract Tests', () => {
  it('should verify gpt-5-nano-2025-08-07 model works', async () => {
    const client = new OpenAIClient({ model: 'gpt-5-nano-2025-08-07' });
    const result = await client.generate('Test connection');
    expect(result.content).toBeTruthy();
  });
});
```

**Priority:** ⚠️ **HIGH** - Add before production to ensure reliability.

---

### 2.2 Missing Edge Case Tests ⚠️

**Gap 1: Minors Detection**
No tests for AC2d (clear minors) patterns:
- "I'm 16 and have a hangover"
- "13 year old at party"
- "underage drinking last night"
- "teenage party got wild"
- "middle school dance aftermath"

**Gap 2: Medical Emergency Patterns**
AC defines but tests don't cover:
- "heart attack" (line 99 of story)
- "stroke" (line 100)
- "internal bleeding" (line 103)

**Gap 3: Abnormal Severity Patterns**
AC defines but tests don't cover:
- "tremors" (line 127)
- "withdrawal" (line 129)

**Gap 4: Combination Scenarios**
No tests for:
- Multiple CRITICAL flags from different categories
- CRITICAL + HIGH/MEDIUM flags together
- All 7 intensifiers present

**Gap 5: Boundary Conditions**
No tests for:
- Empty string content
- Null content (handled in code line 323)
- 10,000 character post (regex performance)
- Unicode/emoji in keywords
- Case variations (regex is case-insensitive but not tested)

**Priority:** ⚠️ **HIGH** - Add before next release

---

### 2.3 Missing Performance Tests ⚠️

**No tests verify:**
- CRITICAL tier completes in < 10ms
- HIGH/MEDIUM tier LLM call completes in < 3000ms
- Regex performance on long posts
- Latency metrics are recorded correctly
- P95/P99 latencies under load

**Recommended Tests:**
```typescript
describe('Performance', () => {
  it('should process CRITICAL tier in < 10ms', async () => {
    const start = performance.now();
    await protocol.checkSafetyProtocol('calling 911 right now');
    const duration = performance.now() - start;
    expect(duration).toBeLessThan(10);
  });

  it('should handle 10K character post without timeout', async () => {
    const longPost = 'a'.repeat(10000) + ' doctor visit yesterday';
    await expect(protocol.checkSafetyProtocol(longPost))
      .resolves.toBeDefined();
  });
});
```

**Priority:** ⚠️ **MEDIUM** - Add for production monitoring

---

### 2.4 Missing Error Scenario Tests ⚠️

**Current Coverage:**
- ✓ Both LLMs fail (integration test line 81-99)
- ✗ DeepSeek timeout but GPT-5 works (not tested)
- ✗ Invalid LLM response format (not tested)
- ✗ LLM returns unexpected classification (not tested)
- ✗ Metrics collector unavailable (not tested)

**Recommended Tests:**
```typescript
describe('Error Scenarios', () => {
  it('should fallback to GPT-5 when DeepSeek times out', async () => {
    const protocol = new SafetyProtocol({
      deepseek: new StubLlmClient('', true),  // Throws
      openai: new StubLlmClient('B hyperbole', false),  // Works
      metrics,
    });

    const result = await protocol.checkSafetyProtocol("I'm dying lol");
    expect(result.llmAssessment?.model).toBe('gpt-5-nano-2025-08-07');
    expect(result.llmAssessment?.classification).toBe('HYPERBOLE');
  });

  it('should handle invalid LLM response gracefully', async () => {
    const protocol = new SafetyProtocol({
      deepseek: new StubLlmClient('XYZ invalid response'),
      metrics,
    });

    const result = await protocol.checkSafetyProtocol('hospital visit');
    expect(result.llmAssessment?.classification).toBe('GENUINE_CONCERN');
    expect(result.llmAssessment?.reasoning).toContain('conservative default');
  });
});
```

**Priority:** ⚠️ **HIGH** - Critical for reliability

---

## 3. Requirements Traceability Matrix

### Acceptance Criteria Coverage

| AC | Requirement | Test File | Test Count | Coverage | Gaps |
|----|------------|-----------|-----------|----------|------|
| **AC1** | Module structure with severity tiers | safety-protocol.test.ts | Implicit | ✓ 100% | None |
| **AC2a** | Suicide/self-harm keywords (8 patterns) | safety-protocol.test.ts | 10 tests | ✓ 125% | None |
| **AC2b** | Alcohol poisoning keywords (11 patterns) | safety-protocol.test.ts | 10 tests | ✓ 91% | Seizure pattern not tested |
| **AC2c** | Medical emergency keywords (9 patterns) | safety-protocol.test.ts | 5 tests | ⚠️ 56% | Heart attack, stroke, internal bleeding |
| **AC2d** | Clear minors keywords (6 patterns) | — | 0 tests | ⛔ 0% | All patterns missing |
| **AC2e** | Abnormal severity keywords (9 patterns) | safety-protocol.test.ts | 5 tests | ⚠️ 56% | Tremors, withdrawal |
| **AC2f** | Pregnancy keywords (5 patterns) | llm.test.ts | 2 tests | ✓ 40% | Adequate for HIGH tier |
| **AC2g** | Medication interaction (8 patterns) | llm.test.ts | 2 tests | ✓ 25% | Adequate for HIGH tier |
| **AC2h** | Chronic conditions (6 patterns) | llm.test.ts | 2 tests | ✓ 33% | Adequate for HIGH tier |
| **AC2i** | Addiction recovery (7 patterns) | llm.test.ts | 2 tests | ✓ 29% | Adequate for HIGH tier |
| **AC2j** | Death hyperbole (4 patterns) | llm.test.ts | 10 tests | ✓ 250% | Excellent |
| **AC2k** | Hospital mention (3 patterns) | llm.test.ts | 6 tests | ✓ 200% | Excellent |
| **AC2l** | Minors unclear (3 patterns) | llm.test.ts | 4 tests | ✓ 133% | Excellent |
| **AC3** | LLM context assessment | llm.test.ts | 30 tests | ⚠️ GAP | Real API tests needed |
| **AC4** | Distress probability (5 factors) | safety-protocol.test.ts | 5 tests | ✓ 100% | None |
| **AC5** | Decision override logic | Implicit | Implicit | ✓ 100% | None |
| **AC6** | Audit logging | integration.test.ts | 1 test | ✓ 100% | None |
| **AC7** | Medical disclaimer & resources | integration.test.ts | 1 test | ✓ 100% | None |

### Overall AC Coverage

- **Fully Covered (100%):** AC1, AC2a, AC4, AC5, AC6, AC7
- **Partially Covered (>50%):** AC2b, AC2e
- **Inadequately Covered (<50%):** AC2c
- **Not Covered (0%):** AC2d (Minors)

**Average Coverage:** ~75% (weighted by criticality)

**Critical Gaps:**
1. ⛔ AC2d: No minors detection tests
2. ⚠️ AC3: Real LLM validation needed
3. ⚠️ AC2c: Incomplete medical emergency tests

---

## 4. Test Quality Assessment

### 4.1 Test Design Quality ✓

**Strengths:**
- Data-driven tests using `.each()` for maintainability
- Clear test names describing expected behavior
- Reusable fixtures (buildAuthor, MetricsStub, StubLlmClient)
- Separation of concerns (unit vs integration vs LLM)

**Example of Good Test Design:**
```typescript
it.each([...suicideCases, ...alcoholPoisoningCases, ...])(
  'forces disengage for critical signal: %s',
  async ({ content, category }) => {
    const result = await protocol().checkSafetyProtocol(content);
    expect(result.shouldDisengage).toBe(true);
    expect(result.flags).toContain(category);
  },
);
```

**Assessment:** ✓ EXCELLENT

---

### 4.2 Test Assertions ✓

**Thoroughness of Assertions:**
```typescript
// Good: Checks all relevant fields
expect(result.shouldDisengage).toBe(true);
expect(result.severity).toBe(SafetySeverity.CRITICAL);
expect(result.flags).toContain(category);
expect(result.contextCheckPerformed).toBe(false);
expect(result.distressProbability).toBeGreaterThanOrEqual(0.7);
```

**Assessment:** ✓ EXCELLENT - Assertions validate behavior comprehensively

---

### 4.3 Test Independence ✓

**Isolation:**
- Each test uses fresh protocol instance
- Metrics stub is reset between tests (beforeEach)
- No shared state between tests

**Evidence:**
```typescript
beforeEach(() => {
  metrics.reset();  // ✓ Clean state
});
```

**Assessment:** ✓ EXCELLENT

---

### 4.4 Test Maintainability ✓

**Ease of Adding New Tests:**
```typescript
// Adding new suicide case is trivial:
const suicideCases = [
  // ... existing 10 cases
  { content: 'new pattern to test', category: 'SUICIDE_SELF_HARM' },  // ← Just add here!
];
```

**Assessment:** ✓ EXCELLENT - Very easy to extend test coverage

---

## 5. Recommended Test Improvements

### Priority 1: HIGH (Before Production)

#### T1.1: Add Real LLM Contract Tests ⚠️
**Effort:** 2-3 hours
**Impact:** HIGH - Verifies API connectivity

```typescript
// backend/tests/contract/llm-clients.test.ts (NEW FILE)
describe('DeepSeek Contract', () => {
  it('should verify deepseek-reasoner model works', async () => {
    const client = new DeepSeekClient({ model: 'deepseek-reasoner' });
    const result = await client.generate('Respond with: OK');
    expect(result.content).toBeTruthy();
  });
});

describe('OpenAI Contract', () => {
  it('should verify gpt-5-nano-2025-08-07 model works', async () => {
    const client = new OpenAIClient({ model: 'gpt-5-nano-2025-08-07' });
    const result = await client.generate('Respond with: OK');
    expect(result.content).toBeTruthy();
  });
});
```

---

#### T1.2: Add Minors Detection Tests ⛔
**Effort:** 30 minutes
**Impact:** HIGH - Critical safety category untested

```typescript
const minorsClearCases = [
  { content: "I'm 16 and have a brutal hangover", category: 'MINORS_CLEAR' },
  { content: "13 year old at the party last night", category: 'MINORS_CLEAR' },
  { content: "underage drinking at the beach", category: 'MINORS_CLEAR' },
  { content: "teenage party got out of hand", category: 'MINORS_CLEAR' },
  { content: "middle school dance aftermath", category: 'MINORS_CLEAR' },
  { content: "junior high reunion wild", category: 'MINORS_CLEAR' },
];

it.each(minorsClearCases)(
  'triggers CRITICAL for clear minor: %s',
  async ({ content, category }) => {
    const result = await protocol().checkSafetyProtocol(content);
    expect(result.shouldDisengage).toBe(true);
    expect(result.severity).toBe(SafetySeverity.CRITICAL);
    expect(result.flags).toContain(category);
  },
);
```

---

### Priority 2: HIGH (Before Next Release)

#### T2.1: Add Missing Medical Emergency Tests
**Effort:** 15 minutes

```typescript
const medicalEmergencyCases = [
  // ... existing 5 cases
  { content: 'having a heart attack after binge', category: 'MEDICAL_EMERGENCY' },
  { content: 'stroke symptoms after drinking', category: 'MEDICAL_EMERGENCY' },
  { content: 'internal bleeding from falling', category: 'MEDICAL_EMERGENCY' },
  { content: 'medical emergency call help', category: 'MEDICAL_EMERGENCY' },
];
```

---

#### T2.2: Add Error Scenario Tests
**Effort:** 1 hour

```typescript
describe('Error Handling', () => {
  it('should use GPT-5 when DeepSeek fails', async () => { ... });
  it('should handle invalid LLM response', async () => { ... });
  it('should handle LLM timeout gracefully', async () => { ... });
  it('should fall back conservatively when both fail', async () => { ... });
});
```

---

#### T2.3: Add Edge Case Tests
**Effort:** 1 hour

```typescript
describe('Edge Cases', () => {
  it('should handle empty content', async () => { ... });
  it('should handle very long posts (10K chars)', async () => { ... });
  it('should handle Unicode and emoji', async () => { ... });
  it('should handle multiple CRITICAL categories', async () => { ... });
  it('should handle all 7 intensifiers', async () => { ... });
});
```

---

### Priority 3: MEDIUM (Nice to Have)

#### T3.1: Add Performance Tests
**Effort:** 2 hours

```typescript
describe('Performance', () => {
  it('should process CRITICAL tier in < 10ms', async () => { ... });
  it('should process HIGH tier in < 3000ms', async () => { ... });
  it('should record latency metrics', async () => { ... });
});
```

---

#### T3.2: Add Full Integration Tests
**Effort:** 3 hours

```typescript
describe('Full Decision Flow', () => {
  it('should integrate with decision engine', async () => { ... });
  it('should persist safety flags to database', async () => { ... });
  it('should emit all required metrics', async () => { ... });
});
```

---

#### T3.3: Add E2E Tests
**Effort:** 4-5 hours

```typescript
describe('E2E Safety Protocol', () => {
  it('should block response for suicide mention', async () => { ... });
  it('should show safety resources in dashboard', async () => { ... });
  it('should make audit trail searchable', async () => { ... });
});
```

---

## 6. Test Maintenance Plan

### Continuous Improvement

**Weekly:**
- Review new safety patterns added
- Update test cases for new categories

**Monthly:**
- Analyze false positive metrics to add new hyperbole cases
- Review audit logs for missed safety triggers

**Quarterly:**
- Full regression suite execution
- Performance benchmark validation
- LLM contract test refresh (verify models still exist)

---

## 7. Test Metrics

### Current State

| Metric | Target | Actual | Status |
|--------|--------|--------|--------|
| Unit test coverage | 100% | ~85% | ⚠️ GAP |
| Integration test coverage | 100% | ~40% | ⚠️ GAP |
| E2E test coverage | 100% | 0% | ⛔ MISSING |
| Contract test coverage | 100% | 0% | ⛔ MISSING |
| Test execution time | < 30s | ~5s | ✓ EXCELLENT |
| Test maintenance time | Low | Low | ✓ GOOD |

### Recommended Targets After Improvements

| Metric | Current | After P1 Fixes | After All Fixes |
|--------|---------|---------------|----------------|
| AC coverage | ~75% | ~90% | 100% |
| Critical path coverage | 100% | 100% | 100% |
| Error scenario coverage | ~20% | ~80% | 100% |
| Real API validation | 0% | 100% | 100% |

---

## Summary & Recommendations

### Test Coverage Summary

**Strengths ✓:**
- Excellent CRITICAL tier coverage (suicide, alcohol poisoning)
- Good HIGH/MEDIUM tier scenario coverage
- Well-designed data-driven tests
- Comprehensive distress probability factor tests
- Good test maintainability

**Critical Gaps ⛔:**
- No real LLM API validation (Risk: API changes break production)
- Missing minors detection tests
- Missing E2E tests
- No contract tests

**Overall Assessment:** ⚠️ **CONCERNS** - Good scenario coverage but critical validation gaps

### Immediate Actions (Before Production)

1. ⚠️ Add LLM contract tests to verify model availability (2-3 hours)
2. ⛔ Add minors detection test cases (30 minutes)
3. ⚠️ Add missing medical emergency tests (15 minutes)
4. ⚠️ Add error scenario tests (1 hour)

**Total Effort:** 4-5 hours to achieve production readiness

---

## Appendix: Test Template for New Safety Patterns

```typescript
// When adding new safety patterns, use this template:

const newPatternCases = [
  { content: 'example content 1', category: 'CATEGORY_NAME' },
  { content: 'example content 2', category: 'CATEGORY_NAME' },
  // ... add 5-10 variations
];

it.each(newPatternCases)(
  'triggers [SEVERITY] for [CATEGORY]: %s',
  async ({ content, category }) => {
    const result = await protocol().checkSafetyProtocol(content);

    // For CRITICAL tier:
    expect(result.shouldDisengage).toBe(true);
    expect(result.severity).toBe(SafetySeverity.CRITICAL);
    expect(result.contextCheckPerformed).toBe(false);

    // For HIGH/MEDIUM tier:
    expect(result.contextCheckPerformed).toBe(true);
    expect(result.llmAssessment).toBeDefined();

    // Common checks:
    expect(result.flags).toContain(category);
    expect(result.distressProbability).toBeGreaterThanOrEqual(0);
  },
);
```
