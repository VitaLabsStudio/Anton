schema: 1
story: '2.5'
story_title: 'Decision Score Calculation & Mode Selection with Segmented Weights'
gate: FAIL
status_reason: 'Critical mathematical, statistical, and architectural flaws requiring fundamental redesign before implementation'
reviewer: 'Quinn (Test Architect)'
updated: '2025-12-06T00:00:00Z'

top_issues:
  - severity: critical
    category: mathematical
    id: MATH-001
    title: 'Weight normalization failure - no validation that weights sum to 1.0'
    description: 'Retrieved weights from database not validated, enabling composite scores >1.0 or <0.0'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::formatWeights'
      - 'backend/src/analysis/decision-engine.ts::calculateComposite'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#MATH-001'

  - severity: critical
    category: mathematical
    id: MATH-002
    title: 'EVS normalization loses critical information via linear capping'
    description: '10× viral post treated identically to 5× viral post due to min(ratio/5, 1) capping'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::calculateComposite'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#MATH-002'

  - severity: critical
    category: mathematical
    id: MATH-003
    title: 'No uncertainty quantification - all decisions are point estimates'
    description: 'Cannot express confidence, identify near-threshold decisions needing review, or support causal inference'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::analyzePost'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#MATH-003'

  - severity: critical
    category: statistical
    id: STAT-001
    title: 'Arbitrary thresholds (0.82, 0.55, 5.0, 2.0, 0.70, 50) lack statistical justification'
    description: 'All decision thresholds appear to be magic numbers without data-driven rationale or power analysis'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::selectMode'
      - 'backend/src/analysis/decision-engine.ts::getWeights'
    suggested_owner: sm
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#STAT-001'

  - severity: critical
    category: statistical
    id: STAT-002
    title: 'Sample size threshold of 50 lacks power analysis'
    description: 'No statistical power calculation to determine minimum sample size for reliable weight estimation'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::getWeights'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#STAT-002'

  - severity: critical
    category: architectural
    id: ARCH-001
    title: 'Linear combination ignores signal interaction effects'
    description: 'Assumes independence (SSS × w1 + ARS × w2 ...) but signals likely interact (e.g., high SSS + high ARS is multiplicatively valuable)'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::calculateComposite'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#ARCH-001'

  - severity: critical
    category: architectural
    id: ARCH-002
    title: 'Mode selection logic has overlapping/conflicting conditions and gaps'
    description: 'Power user logic only in mid-band, inconsistent EVS thresholds across SSS bands, missing low-SSS power user handling'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::selectMode'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#ARCH-002'

  - severity: high
    category: performance
    id: PERF-001
    title: 'No caching for weight retrieval - 3 DB queries per decision'
    description: 'Every decision queries database for weights, causing 200-300ms latency and excessive DB load'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::getWeights'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-nfr-20251206.md#Performance'

  - severity: high
    category: performance
    id: PERF-002
    title: 'Missing critical database indexes'
    description: 'segmented_weights lookup and decisions queries will degrade as data grows'
    affected_components:
      - 'database/prisma/schema.prisma'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-nfr-20251206.md#Performance'

  - severity: high
    category: reliability
    id: REL-001
    title: 'No error boundaries or fallback values for signal failures'
    description: 'Single signal analyzer failure crashes entire decision; no graceful degradation'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::analyzePost'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-nfr-20251206.md#Reliability'

  - severity: high
    category: reliability
    id: REL-002
    title: 'No circuit breakers for external dependencies'
    description: 'No protection against cascading failures from signal analyzers or database'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::analyzePost'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-nfr-20251206.md#Reliability'

  - severity: high
    category: data-quality
    id: DATA-001
    title: 'No validation that composite score stays in [0, 1]'
    description: 'Invalid weights could produce composite scores >1.0, breaking mode selection logic'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::calculateComposite'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#DATA-001'

  - severity: high
    category: data-quality
    id: DATA-002
    title: 'No handling of NaN/Infinity from API failures'
    description: 'Signal analyzers returning NaN or Infinity would crash composite calculation'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::calculateComposite'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-risk-20251206.md#DATA-002'

  - severity: medium
    category: security
    id: SEC-001
    title: 'Missing input validation at entry point'
    description: 'No schema validation for post/author inputs, enabling potential DoS via oversized content'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::analyzePost'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-nfr-20251206.md#Security'

  - severity: medium
    category: security
    id: SEC-002
    title: 'No rate limiting on decision engine invocations'
    description: 'Runaway process could invoke decision engine millions of times, causing cost explosion'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts::analyzePost'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-nfr-20251206.md#Security'

  - severity: medium
    category: maintainability
    id: MAINT-001
    title: 'Mathematical complexity undocumented'
    description: 'No JSDoc explaining threshold rationale, normalization formulas, or design trade-offs'
    affected_components:
      - 'backend/src/analysis/decision-engine.ts'
    suggested_owner: dev
    refs:
      - 'docs/qa/assessments/2.5-nfr-20251206.md#Maintainability'

waiver:
  active: false

quality_score: 21
expires: '2025-12-20T00:00:00Z'

evidence:
  tests_reviewed: 147
  risks_identified: 23
  trace:
    ac_covered: [1, 2, 3, 4, 5, 6, 7, 8, 9]
    ac_gaps: []

risk_summary:
  totals:
    critical: 7
    high: 6
    medium: 8
    low: 2
  highest:
    id: MATH-001
    score: 9
    title: 'Weight normalization failure'
  recommendations:
    must_fix:
      - 'Add weight validation (sum=1.0, non-negative) before using retrieved weights'
      - 'Replace linear EVS capping with logarithmic/sigmoid scaling or categorical approach'
      - 'Add Bayesian uncertainty quantification for composite scores and mode probabilities'
      - 'Conduct power analysis for sample size threshold or implement Bayesian shrinkage'
      - 'Add interaction terms (at minimum SSS×ARS) or use logistic regression model'
      - 'Refactor mode selection logic with clear priority ordering and consistent rules'
      - 'Implement weight caching with 10-minute TTL'
      - 'Add database indexes for segmented_weights and decisions tables'
      - 'Add error boundaries with fallback values for all signal fetches'
      - 'Implement circuit breakers for signal analyzers and database'
      - 'Add composite score range validation and NaN/Infinity handling'
    monitor:
      - 'Weight cache hit rate (target >90%)'
      - 'Decision latency P95 (target <500ms)'
      - 'Signal analyzer failure rates'
      - 'Composite score distribution (detect out-of-range values)'
      - 'Mode selection distribution (detect drift)'

nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: CONCERNS
    notes: 'Missing input validation and rate limiting; weight poisoning protection needed'
  performance:
    status: FAIL
    notes: 'No caching (200-300ms overhead), missing indexes, N+1 archetype queries; P95 latency 400-600ms vs 500ms target'
  reliability:
    status: FAIL
    notes: 'No error boundaries, circuit breakers, retry logic, or health checks; single point of failure in signal fetching'
  maintainability:
    status: CONCERNS
    notes: 'Mathematical formulas undocumented, no ADRs, no versioning strategy; test coverage 60-70% vs 90% target'

test_design:
  scenarios_total: 147
  by_level:
    unit: 89
    integration: 48
    e2e: 10
  by_priority:
    p0: 52
    p1: 63
    p2: 32
  coverage_gaps: []
  special_tests:
    - 'Property-based testing for mathematical invariants (fast-check)'
    - 'Exhaustive mode selection matrix: 4,480 combinations'
    - 'Chaos/failure injection for robustness'
    - 'Performance benchmarks for latency SLA'

recommendations:
  immediate:
    - action: 'Add mathematical validation layer (weights sum validation, score clamping, NaN handling)'
      refs: ['backend/src/analysis/decision-engine.ts']
      estimated_effort: '1 day'

    - action: 'Replace EVS linear capping with logarithmic scaling or categorical approach'
      refs: ['backend/src/analysis/decision-engine.ts::calculateComposite']
      estimated_effort: '0.5 day'

    - action: 'Add Bayesian uncertainty quantification (credible intervals, mode probabilities)'
      refs: ['backend/src/analysis/decision-engine.ts::analyzePost']
      estimated_effort: '2 days'

    - action: 'Document or make configurable all thresholds (0.82, 0.55, 5.0, 2.0, 0.70, 50)'
      refs: ['backend/src/analysis/decision-engine.ts::selectMode']
      estimated_effort: '1 day'

    - action: 'Add interaction terms (SSS×ARS minimum) or train logistic regression model'
      refs: ['backend/src/analysis/decision-engine.ts::calculateComposite']
      estimated_effort: '2 days'

    - action: 'Refactor mode selection logic with clear priority ordering'
      refs: ['backend/src/analysis/decision-engine.ts::selectMode']
      estimated_effort: '1 day'

    - action: 'Implement weight caching with node-cache (10-minute TTL)'
      refs: ['backend/src/analysis/decision-engine.ts::getWeights']
      estimated_effort: '0.25 day'

    - action: 'Add database indexes (segmented_weights, decisions)'
      refs: ['database/prisma/schema.prisma', 'database/migrations/']
      estimated_effort: '0.25 day'

    - action: 'Add error boundaries with fallback values for signal fetches'
      refs: ['backend/src/analysis/decision-engine.ts::analyzePost']
      estimated_effort: '0.5 day'

    - action: 'Implement circuit breakers using opossum library'
      refs: ['backend/src/analysis/decision-engine.ts']
      estimated_effort: '0.5 day'

    - action: 'Add property-based tests for mathematical invariants'
      refs: ['backend/tests/unit/analysis/decision-engine.test.ts']
      estimated_effort: '1 day'

    - action: 'Implement exhaustive mode selection test matrix (4,480 scenarios)'
      refs: ['backend/tests/unit/analysis/decision-engine.test.ts']
      estimated_effort: '0.5 day'

  future:
    - action: 'Consider replacing linear model with logistic regression or gradient boosting'
      refs: ['backend/src/analysis/decision-engine.ts']

    - action: 'Add comprehensive JSDoc with mathematical explanations and ADRs'
      refs: ['backend/src/analysis/decision-engine.ts', 'docs/adr/']

    - action: 'Implement A/B testing framework for threshold experimentation'
      refs: ['backend/src/analysis/decision-engine.ts', 'backend/src/services/experiment-service.ts']

    - action: 'Add decision logic versioning for fair comparison'
      refs: ['database/prisma/schema.prisma::Decision.decisionLogicVersion']

    - action: 'Implement query batching for multi-decision processing'
      refs: ['backend/src/analysis/decision-engine.ts::getWeights']

estimated_rework_effort: '10-15 days'

additional_resources:
  - title: 'Risk Profile (Full Analysis)'
    path: 'docs/qa/assessments/2.5-risk-20251206.md'
  - title: 'Test Design (147 Scenarios)'
    path: 'docs/qa/assessments/2.5-test-design-20251206.md'
  - title: 'NFR Assessment (Security/Performance/Reliability/Maintainability)'
    path: 'docs/qa/assessments/2.5-nfr-20251206.md'

gate_decision_rationale: |
  Story 2.5 represents a CRITICAL component of the system (the "brain" of the decision engine),
  but the current design contains fundamental flaws that make it unsuitable for production:

  MATHEMATICAL FAILURES (3 critical risks):
  - No validation that weights sum to 1.0 → invalid composite scores
  - EVS linear capping loses information → 10× viral = 5× viral
  - No uncertainty quantification → cannot identify low-confidence decisions

  STATISTICAL FAILURES (2 critical risks):
  - All thresholds arbitrary without justification
  - Sample size threshold lacks power analysis

  ARCHITECTURAL FAILURES (2 critical risks):
  - Linear model ignores signal interactions
  - Mode selection logic has gaps and inconsistencies

  NFR FAILURES (4 high risks):
  - No caching → 400-600ms latency
  - Missing indexes → will degrade at scale
  - No error boundaries → fragile system
  - No circuit breakers → cascading failures

  For a system required to be "almost infallible" and "God tier" (user's words), the current
  design scores 21/100 on our risk assessment. This is UNACCEPTABLE for a production-critical
  decision engine.

  REQUIRED ACTIONS:
  1. Implement ALL 7 critical risk mitigations (estimated 6-10 days)
  2. Address 6 high-priority risks (estimated 4-5 days)
  3. Achieve 90%+ test coverage with property-based tests (estimated 1-2 days)

  ESTIMATED TOTAL REWORK: 10-15 days before story is ready for implementation.

  RECOMMENDATION: **REVISE STORY** with improved mathematical foundations, statistical rigor,
  and architectural robustness before assigning to development.
