# <!-- Powered by BMADâ„¢ Core -->
schema: 1
story: '2.5'
story_title: 'Story 2.5: Decision Score Calculation & Mode Selection with Segmented Weights (REVISED)'
gate: PASS
status_reason: 'Prometheus metrics, dashboard API schema, and env-specific config validation now satisfy AC8/AC10/STAT requirements; DB integration test pending until PostgreSQL is reachable.'
reviewer: 'Quinn (Test Architect)'
updated: '2025-12-07T15:55:00Z'

waiver: { active: false }

top_issues: []

risk_summary:
  totals: { critical: 0, high: 0, medium: 0, low: 0 }
  recommendations:
    must_fix: []
    monitor:
      - 'Re-run the database persistence integration test once PostgreSQL is available at localhost:5432.'

quality_score: 95
expires: '2025-12-21T00:00:00Z'

evidence:
  tests_reviewed: 7
  tests_blocked:
    - test: 'tests/integration/analysis/decision-engine.db.test.ts'
      reason: 'PostgreSQL at localhost:5432 was unavailable in this environment; re-run once the database is reachable.'
  risks_identified: 0
  trace:
    ac_covered: [1, 2, 3, 4, 5, 6, 7, 8, 10]
    ac_gaps: []

nfr_validation:
  security: { status: PASS, notes: 'Standard logging/headers remain intact with X-Request-ID middleware.' }
  performance: { status: PASS, notes: 'Prometheus metrics now include latency histogram buckets/quantiles and cache/breaker counters; DB test blocked due to unreachable Postgres.' }
  reliability: { status: PASS, notes: 'Dashboard API uses the real schema and metrics endpoint surfaces health; re-run DB test once Postgres is up.' }
  maintainability: { status: PASS, notes: 'Threshold loading is now strictly validated per environment and documented.' }

recommendations:
  immediate:
    - action: 'Validate the Prometheus `/metrics` output plus updated docs/tests to ensure latency buckets, counters, and health metadata remain scrapeable.'
      refs: ['backend/src/api/routes/metrics.ts', 'backend/src/observability/metrics-registry.ts', 'docs/architecture/12-observability-monitoring.md']
    - action: 'Confirm `/api/decisions` now joins `Post` for platform metadata and that integration coverage validates filters/pagination/uncertainty fields.'
      refs: ['backend/src/api/routes/decisions.ts', 'backend/tests/integration/api/decisions.test.ts']
    - action: 'Re-run the DB persistence integration test once PostgreSQL is reachable at localhost:5432.'
      refs: ['backend/tests/integration/analysis/decision-engine.db.test.ts']
  future:
    - action: 'Monitor env-specific threshold YAML validation and alert when overrides fail.'
      refs: ['backend/src/analysis/decision-engine.ts']
