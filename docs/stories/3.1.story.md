# Story 3.1: Claims Library & Compliance Engine

## Status: Draft

## Story

**As a** legal/compliance officer,  
**I want** a centralized Claims Library with approved phrasing and prohibited terms,  
**so that** all bot-generated messages comply with regulatory requirements and avoid medical claims.

## Acceptance Criteria

1. Claims Library JSON file created at `@backend/data/claims-library.json`
2. Library structure defined:
   - `approved_phrases`: Array of pre-approved scientific statements
   - `prohibited_terms`: Array of banned words ("prevent", "cure", "treat", "clinically proven")
   - `soft_benefits`: Array of compliant positioning statements ("designed to support", "formulated to")
3. Compliance validation function at `@backend/compliance/validator.ts`
4. Function checks generated messages against prohibited terms (hard block)
5. Function validates scientific claims match approved phrases (fuzzy matching allowed)
6. Non-compliant messages rejected with specific violation logged
7. Unit tests with 50+ examples validate compliance rules
8. Dashboard endpoint `/api/compliance/library` allows viewing/editing Claims Library
9. All changes to Claims Library require legal team approval (manual workflow documented)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Claims Library Configuration** (AC: 1, 2)
  - [ ] Create `backend/src/data/claims-library.json`
  - [ ] Define approved_phrases array
  - [ ] Define prohibited_terms array
  - [ ] Define soft_benefits array
  - [ ] Add version field for tracking changes

- [ ] **Task 2: Create Compliance Validator** (AC: 3, 4, 5, 6)
  - [ ] Create `backend/src/compliance/validator.ts`
  - [ ] Implement validate(message) function
  - [ ] Check prohibited terms (exact match, case-insensitive)
  - [ ] Check scientific claims against approved phrases
  - [ ] Return validation result with violations array
  - [ ] Log violations for audit

- [ ] **Task 3: Implement Fuzzy Matching** (AC: 5)
  - [ ] Allow approved phrases with minor variations
  - [ ] Use Levenshtein distance for similarity
  - [ ] Threshold: 85% similarity accepted

- [ ] **Task 4: Create Dashboard API** (AC: 8)
  - [ ] Create `backend/src/api/routes/compliance.ts`
  - [ ] Implement GET /api/compliance/library
  - [ ] Implement PUT /api/compliance/library
  - [ ] Require admin auth for updates
  - [ ] Log all changes with actor

- [ ] **Task 5: Document Approval Workflow** (AC: 9)
  - [ ] Create docs/compliance-workflow.md
  - [ ] Define legal review process
  - [ ] Define change request format
  - [ ] Define approval requirements

- [ ] **Task 6: Write Unit Tests** (AC: 7)
  - [ ] Test 50+ example messages
  - [ ] Test prohibited terms detection
  - [ ] Test approved phrases validation
  - [ ] Test fuzzy matching
  - [ ] Test violation logging

---

## Dev Notes

### Claims Library Structure
```json
// backend/src/data/claims-library.json
{
  "version": "1.0",
  "lastUpdated": "2025-12-01",
  "approvedBy": "Legal Team",
  "approved_phrases": [
    "designed to support your body's natural recovery",
    "formulated to help replenish key nutrients",
    "contains B-vitamins and glutathione precursors",
    "transdermal delivery bypasses digestive system",
    "absorbed through the skin",
    "may help reduce discomfort",
    "supports hydration and vitamin levels",
    "used by thousands of customers",
    "based on peer-reviewed research on vitamin absorption"
  ],
  "prohibited_terms": [
    "cure",
    "prevent",
    "treat",
    "clinically proven",
    "FDA approved",
    "guaranteed",
    "medical grade",
    "prescription strength",
    "eliminates",
    "blocks hangovers",
    "stops hangovers",
    "cures hangovers"
  ],
  "soft_benefits": [
    "designed to support",
    "formulated to help",
    "may reduce",
    "can assist with",
    "helps replenish",
    "supports your body's",
    "works to deliver",
    "aims to provide"
  ],
  "prohibited_contexts": [
    "medical advice",
    "diagnosis",
    "treatment recommendation",
    "health condition cure",
    "replace medical care"
  ]
}
```

### Compliance Validator Implementation
```typescript
// backend/src/compliance/validator.ts

import claimsLibrary from '../data/claims-library.json';
import { logger } from '../utils/logger';
import { levenshteinDistance } from '../utils/string-similarity';

interface ValidationResult {
  valid: boolean;
  violations: string[];
  warnings: string[];
}

export class ComplianceValidator {
  private prohibitedTerms: string[];
  private approvedPhrases: string[];
  private softBenefits: string[];

  constructor() {
    this.prohibitedTerms = claimsLibrary.prohibited_terms;
    this.approvedPhrases = claimsLibrary.approved_phrases;
    this.softBenefits = claimsLibrary.soft_benefits;
  }

  validate(message: string): ValidationResult {
    const violations: string[] = [];
    const warnings: string[] = [];

    // Check prohibited terms (hard block)
    for (const term of this.prohibitedTerms) {
      const regex = new RegExp(`\\b${term}\\b`, 'i');
      if (regex.test(message)) {
        violations.push(`Prohibited term detected: "${term}"`);
      }
    }

    // Check if scientific claims match approved phrases
    const claims = this.extractClaims(message);
    for (const claim of claims) {
      if (!this.isApprovedClaim(claim)) {
        warnings.push(`Unverified claim: "${claim}"`);
      }
    }

    // Log violations
    if (violations.length > 0) {
      logger.warn('Compliance violation detected', {
        violations,
        message: message.substring(0, 100),
      });
    }

    return {
      valid: violations.length === 0,
      violations,
      warnings,
    };
  }

  private extractClaims(message: string): string[] {
    // Extract sentences that make claims about the product
    const claims: string[] = [];
    const sentences = message.split(/[.!?]+/);

    for (const sentence of sentences) {
      if (/vita|patch|transdermal/i.test(sentence)) {
        claims.push(sentence.trim());
      }
    }

    return claims;
  }

  private isApprovedClaim(claim: string): boolean {
    // Exact match
    if (this.approvedPhrases.includes(claim)) {
      return true;
    }

    // Fuzzy match (85% similarity)
    for (const approved of this.approvedPhrases) {
      const similarity = this.calculateSimilarity(claim, approved);
      if (similarity >= 0.85) {
        return true;
      }
    }

    // Check if uses soft benefits language
    for (const softBenefit of this.softBenefits) {
      if (claim.toLowerCase().includes(softBenefit.toLowerCase())) {
        return true;
      }
    }

    return false;
  }

  private calculateSimilarity(str1: string, str2: string): number {
    const distance = levenshteinDistance(str1.toLowerCase(), str2.toLowerCase());
    const maxLength = Math.max(str1.length, str2.length);
    return 1 - distance / maxLength;
  }
}

// Export singleton
export const complianceValidator = new ComplianceValidator();
```

### String Similarity Utility
```typescript
// backend/src/utils/string-similarity.ts

export function levenshteinDistance(str1: string, str2: string): number {
  const matrix: number[][] = [];

  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }

  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }

  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1, // substitution
          matrix[i][j - 1] + 1,     // insertion
          matrix[i - 1][j] + 1      // deletion
        );
      }
    }
  }

  return matrix[str2.length][str1.length];
}
```

### File Structure
```
backend/src/
├── data/
│   └── claims-library.json      # THIS STORY
├── compliance/
│   └── validator.ts             # THIS STORY
├── utils/
│   └── string-similarity.ts     # THIS STORY
└── api/
    └── routes/
        └── compliance.ts        # THIS STORY
```

---

## Testing

### Test File Location
- `backend/tests/unit/compliance/validator.test.ts`
- `backend/tests/unit/utils/string-similarity.test.ts`

### Testing Standards
- Test all prohibited terms
- Test approved phrases
- Test fuzzy matching
- Test edge cases

### Story-Specific Testing Requirements
1. 50+ test messages validate correctly
2. Prohibited terms always rejected
3. Approved phrases accepted
4. Fuzzy matching works (85% threshold)
5. Violations logged correctly
6. API allows viewing/editing library

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*





