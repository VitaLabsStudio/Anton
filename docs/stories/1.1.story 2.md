# Story 1.1: Project Setup & Monorepo Structure

## Status: Draft

## Story

**As a** developer,  
**I want** a well-organized monorepo with TypeScript, linting, build tooling, and advanced statistical libraries configured,  
**so that** the codebase is maintainable, type-safe, supports advanced learning algorithms, and is ready for multiple team members to contribute.

## Acceptance Criteria

1. Project initialized with `pnpm` workspaces for `/backend`, `/dashboard`, and `/shared`
2. TypeScript configured with strict mode and path aliases:
   - Base config: `tsconfig.base.json` with strict mode enabled
   - Target: ES2024, Module: NodeNext, ModuleResolution: NodeNext
   - Path aliases: `@/*` for local src, `@shared/*` for shared package
   - Backend tsconfig: extends base, `outDir: ./dist`, `rootDir: ./src`
   - Dashboard tsconfig: extends base, Next.js specific config
   - Shared tsconfig: exports types for consumption by other packages
   - Strict mode flags enabled in tsconfig.base.json:
     * `strict: true` (base strict flag)
     * `noImplicitAny: true`, `strictNullChecks: true`, `strictFunctionTypes: true`
     * `strictBindCallApply: true`, `strictPropertyInitialization: true`
     * `noImplicitThis: true`, `alwaysStrict: true`
     * `noUnusedLocals: true`, `noUnusedParameters: true`
     * `noImplicitReturns: true`, `noFallthroughCasesInSwitch: true`
     * `noUncheckedIndexedAccess: true`, `noImplicitOverride: true`
     * `noPropertyAccessFromIndexSignature: true`
3. ESLint and Prettier configured with consistent rules across all packages:
   - ESLint 9.15.x with TypeScript plugin, security plugin, import plugin
   - Key ESLint rules enforced:
     * `@typescript-eslint/explicit-function-return-type: error`
     * `@typescript-eslint/no-explicit-any: error`
     * `@typescript-eslint/no-floating-promises: error`, `await-thenable: error`
     * Import order with alphabetization and grouped imports (builtin â†’ external â†’ internal)
     * Security plugin: `detect-object-injection: warn`, `detect-non-literal-regexp: warn`
   - Prettier 3.4.x with 100 char line length, single quotes, semicolons
   - EditorConfig with LF line endings, 2-space indent
4. `package.json` scripts defined at root level:
   - Development: `dev`, `build`, `test`, `test:coverage`
   - Code Quality: `lint`, `lint:fix`, `format`, `format:check`, `typecheck`, `validate`
   - Database: `db:migrate`, `db:seed`, `db:studio`
   - Docker: `docker:dev`, `docker:prod`, `docker:down`
   - Git Hooks: `prepare` (husky install)
5. `.gitignore` configured to exclude `node_modules`, `.env`, build artifacts
6. README.md includes project overview, setup instructions, and architecture diagram
7. All packages build successfully with `pnpm build`
8. **Advanced Learning System Dependencies** (from Learning System Improvements doc):
   - `simple-statistics` (^7.8.3) - Statistical functions for robust statistics
   - `jstat` (^1.9.6) - Beta distribution, t-tests, and statistical inference
   - `seedrandom` (^3.0.5) - Reproducible random sampling for Thompson Sampling
   - `@types/simple-statistics` (^7.8.3) - TypeScript definitions
   - `@types/jstat` (^1.9.3) - TypeScript definitions
9. Configuration file created at `backend/src/config/learning.json` with:
   - Minimum sample sizes for all learning operations
   - Robust statistics settings (Winsorization percentiles)
   - Confidence interval parameters
   - Thompson Sampling configuration
   - Segmentation settings
   - Adaptive learning rate parameters
   - Causal inference settings
   - Meta-learning configuration
10. **Production Dependencies** installed with locked versions:
    - Runtime: Node.js **24.11.1** (LTS), TypeScript **5.9.3**
    - Package Manager: pnpm **10.0.0** (25% faster than 8.x)
    - Web Framework: `hono@^4.6.0`, `@hono/node-server@^1.13.0` (10x faster than Express)
    - Database: `@prisma/client@^7.0.1`, `prisma@^7.0.1` (devDependency) (40% faster queries)
    - Platform SDKs: `twitter-api-v2@^1.17.2`, `snoowrap@^1.23.0`, `axios@^1.7.9`
    - Validation: `zod@^3.24.1`
    - Logging: `pino@^9.5.0`, `pino-pretty@^12.0.0`
    - Utilities: `ioredis@^5.4.2`, `node-cron@^3.0.3`, `uuid@^11.0.3`, `dotenv@^16.4.7`
11. **Dashboard Dependencies** configured:
    - Framework: `next@^16.0.2` (Turbopack default), `react@^19.0.0`, `react-dom@^19.0.0`
    - Styling: `tailwindcss@^4.0.0` (Oxide engine, 10x faster builds)
    - Data Fetching: `@tanstack/react-query@^5.62.11`
    - Visualization: `recharts@^2.15.0`, `lucide-react@^0.468.0`
    - Utilities: `clsx@^2.1.1`, `tailwind-merge@^2.5.5`, `date-fns@^4.1.0`
    - Real-time: `socket.io-client@^4.8.1`
12. **Development Tooling** configured:
    - Git hooks: Husky 9.x with pre-commit (lint-staged + typecheck), pre-push (tests + build), commit-msg (commitlint)
    - CommitLint: Conventional commits format enforced (`@commitlint/config-conventional`)
    - EditorConfig: Consistent formatting rules (`.editorconfig`) - UTF-8, LF, 2-space indent
    - VS Code: Workspace settings with recommended extensions:
      - `.vscode/settings.json`: Format on save, ESLint auto-fix on save
      - `.vscode/extensions.json`: ESLint, Prettier, Tailwind CSS, Prisma, TypeScript, Error Lens, GitLens
      - `.vscode/launch.json`: Debug configurations for API, worker, and tests
    - Node version: `.nvmrc` file with version **24.11.1** (LTS until April 2027)
    - Ignore files: `.eslintignore`, `.prettierignore`, `.gitignore` properly configured
    - Testing: Vitest 2.1.x for unit and integration tests (faster than Jest)
    - Vitest configuration:
      * Coverage provider: v8 (faster than istanbul)
      * Coverage thresholds: 80% lines, 80% functions, 75% branches, 80% statements
      * Reporters: text (console), json, html (dashboard), lcov (CI)
      * Test file patterns: `**/*.{test,spec}.{ts,tsx}`

---

## Tasks / Subtasks

- [ ] **Task 1: Initialize pnpm Monorepo** (AC: 1)
  - [ ] Create root `package.json` with workspace configuration
  - [ ] Create `pnpm-workspace.yaml` defining workspaces: `["backend", "dashboard", "shared", "database"]`
  - [ ] Create empty workspace directories: `backend/`, `dashboard/`, `shared/`, `database/`
  - [ ] Run `pnpm install` to verify workspace setup

- [ ] **Task 2: Configure TypeScript with Strict Mode** (AC: 2)
  - [ ] Create `tsconfig.base.json` at root with all strict mode flags (see Dev Notes)
  - [ ] Create `backend/tsconfig.json` extending base with `outDir: ./dist`, `rootDir: ./src`
  - [ ] Create `dashboard/tsconfig.json` extending base with Next.js config
  - [ ] Create `shared/tsconfig.json` with declaration exports
  - [ ] Create `database/tsconfig.json` extending base
  - [ ] Configure path aliases: `@/*` for local src, `@shared/*` for shared package

- [ ] **Task 3: Configure ESLint** (AC: 3)
  - [ ] Create `.eslintrc.js` at root with TypeScript, security, and import plugins
  - [ ] Configure all required rules per architecture (explicit return types, no any, etc.)
  - [ ] Create `.eslintignore` for node_modules, dist, coverage
  - [ ] Add eslint packages to root devDependencies

- [ ] **Task 4: Configure Prettier** (AC: 3)
  - [ ] Create `.prettierrc` with 100 char line length, single quotes, semicolons
  - [ ] Create `.prettierignore` for node_modules, dist, coverage, pnpm-lock.yaml
  - [ ] Create `.editorconfig` with LF line endings, 2-space indent, UTF-8

- [ ] **Task 5: Create Root package.json with Scripts** (AC: 4, 10)
  - [ ] Define all workspace scripts (dev, build, test, lint, format, typecheck, validate)
  - [ ] Define database scripts (db:migrate, db:seed, db:studio)
  - [ ] Define docker scripts (docker:dev, docker:prod, docker:down)
  - [ ] Add all root devDependencies per architecture spec
  - [ ] Set `"packageManager": "pnpm@10.0.0"` and engines constraints

- [ ] **Task 6: Create Backend package.json** (AC: 10, 8)
  - [ ] Add all production dependencies per architecture (hono, prisma, platform SDKs, etc.)
  - [ ] Add statistical libraries: simple-statistics, jstat, seedrandom with types
  - [ ] Add devDependencies: vitest, tsx, ts-node, prisma CLI
  - [ ] Define scripts: dev, build, test, test:coverage, lint, typecheck
  - [ ] Create `backend/src/` directory structure

- [ ] **Task 7: Create Dashboard package.json** (AC: 11)
  - [ ] Add Next.js 16.x, React 19.x dependencies
  - [ ] Add styling: tailwindcss 4.x, autoprefixer, postcss
  - [ ] Add data fetching: @tanstack/react-query, recharts, lucide-react
  - [ ] Add utilities: clsx, tailwind-merge, date-fns, socket.io-client
  - [ ] Define scripts: dev, build, start, lint, typecheck
  - [ ] Create `dashboard/src/app/` directory with placeholder page.tsx

- [ ] **Task 8: Create Shared package.json** (AC: 1)
  - [ ] Configure as internal package for types and constants
  - [ ] Create `shared/src/types/` directory with placeholder index.ts
  - [ ] Create `shared/src/constants/` directory
  - [ ] Create `shared/src/schemas/` directory
  - [ ] Export all modules from main index.ts

- [ ] **Task 9: Create Database package.json** (AC: 1)
  - [ ] Configure for Prisma schema and migrations
  - [ ] Create `database/prisma/` directory
  - [ ] Create placeholder `schema.prisma` file
  - [ ] Define scripts: db:migrate, db:seed, db:studio, db:generate

- [ ] **Task 10: Configure Git Hooks with Husky** (AC: 12)
  - [ ] Initialize husky: `pnpm exec husky init`
  - [ ] Create `.husky/pre-commit` with lint-staged and typecheck
  - [ ] Create `.husky/pre-push` with test and build
  - [ ] Create `.husky/commit-msg` with commitlint
  - [ ] Add `lint-staged` config to root package.json
  - [ ] Add `@commitlint/cli` and `@commitlint/config-conventional`
  - [ ] Create `commitlint.config.js`

- [ ] **Task 11: Configure VS Code Workspace** (AC: 12, DEV-001, TECH-003)
  - [ ] Create `.vscode/settings.json` with format on save (Prettier), then ESLint fix on save
  - [ ] Create `.vscode/extensions.json` with recommended extensions (ESLint, Prettier, Tailwind, Prisma, Vitest)
  - [ ] Create `.vscode/launch.json` with debug configurations
  - [ ] Ensure formatter precedence: Prettier first, ESLint second

- [ ] **Task 12: Create Node Version and Ignore Files** (AC: 5, 12, DEV-001)
  - [ ] Create `.nvmrc` with `24.11.1`
  - [ ] Create `.npmrc` with `engine-strict=true` to enforce Node/pnpm versions
  - [ ] Create comprehensive `.gitignore` (node_modules, .env, dist, coverage, etc.)

- [ ] **Task 13: Create Learning Configuration** (AC: 9)
  - [ ] Create `backend/src/config/learning.json` with all parameters
  - [ ] Include: minimum sample sizes, Winsorization percentiles, confidence intervals
  - [ ] Include: Thompson Sampling config, segmentation settings, adaptive rates
  - [ ] Include: causal inference and meta-learning configuration

- [ ] **Task 14: Configure Vitest** (AC: 12, TECH-006)
  - [ ] Create `vitest.config.ts` at root
  - [ ] Add `vitest-tsconfig-paths` plugin to read path aliases from tsconfig
  - [ ] Configure coverage provider: v8
  - [ ] Set coverage thresholds: 80/80/75/80
  - [ ] Configure reporters: text, json, html, lcov
  - [ ] Set test file patterns
  - [ ] Add comments explaining configuration choices

- [ ] **Task 15: Create README.md** (AC: 6)
  - [ ] Write project overview (Antone V1 - Autonomous AI Social Media Manager)
  - [ ] Include setup instructions (prerequisites, installation, development)
  - [ ] Include architecture diagram reference
  - [ ] Document available scripts

- [ ] **Task 16: Create Risk Mitigation Scripts** (TECH-001, OPS-002)
  - [ ] Create `scripts/verify-workspace.ts` to test cross-package imports (@shared/constants, @shared/types)
  - [ ] Create `scripts/verify-build.js` to verify build outputs exist (backend/dist, dashboard/.next, shared/dist)
  - [ ] Add `verify:workspace` script to root package.json
  - [ ] Add `postbuild` script that auto-runs verify-build.js
  - [ ] Document bypass mechanisms in README

- [ ] **Task 17: Enhance Git Hooks with Clear Error Messages** (OPS-001 Mitigation)
  - [ ] Update `.husky/pre-commit` with bypass instructions and clear error messages
  - [ ] Update `.husky/pre-push` with bypass instructions and clear error messages
  - [ ] Update `.husky/commit-msg` with clear formatting examples
  - [ ] Add "Emergency Bypass" section to README

- [ ] **Task 18: Configure Type Declaration Overrides** (TECH-002 Mitigation)
  - [ ] Create `backend/src/types/overrides.d.ts` with documented template for third-party type overrides
  - [ ] Create `shared/src/types/overrides.d.ts` if needed
  - [ ] Verify `skipLibCheck: true` is set in tsconfig.base.json
  - [ ] Ensure tsconfig.json includes these declaration files
  - [ ] Document pattern for handling type issues in README

- [ ] **Task 19: Verify ESLint/Prettier Integration** (TECH-003 Mitigation)
  - [ ] Add `validate` script that runs format:check, lint, typecheck
  - [ ] Verify eslint-config-prettier is last in extends array
  - [ ] Test format + lint on sample file to verify no conflicts
  - [ ] Update `.vscode/settings.json` with correct formatter precedence

- [ ] **Task 20: Verify Build and Test Workspace Resolution** (AC: 7, TECH-001)
  - [ ] Run `pnpm install` to install all dependencies
  - [ ] Run `pnpm build` with error propagation
  - [ ] Run `scripts/verify-build.js` to verify outputs
  - [ ] Run `scripts/verify-workspace.ts` to test cross-package imports
  - [ ] Run `pnpm validate` to verify lint/format/typecheck
  - [ ] Test all git hooks with sample commit
  - [ ] Verify workspace protocol in all package.json files

---

## Dev Notes

### Previous Story Insights
No previous story - this is Story 1.1.

### Risk Mitigation Strategies
[Source: QA Risk Assessment 1.1-risk-20251202.md]

**CRITICAL: The following architectural guidance addresses the HIGH and MEDIUM priority risks identified in QA review. These must be implemented to ensure a stable foundation.**

#### CRITICAL RISK: Monorepo Workspace Resolution (TECH-001) - Priority: CRITICAL (Score 9)
**Problem**: `pnpm` workspace resolution is powerful but can fail cryptically, causing broken cross-package imports (`@shared/`) and build failures that are hard to debug. This is the highest technical risk.

**Mitigation & Implementation**:
1. **Use Explicit Workspace Protocol**: Enforce the `workspace:*` protocol in all `package.json` files for internal dependencies. This ensures `pnpm` uses the local workspace package instead of a potentially mismatched version from the registry.
   * **Action**: In `backend/package.json` and `dashboard/package.json`, dependencies on `shared` must be:
     ```json
     "dependencies": {
       "@shared/types": "workspace:*"
     }
     ```
2. **Create a Verification Script**: Add a dedicated script to verify that cross-package imports resolve and execute correctly. This acts as a smoke test for the monorepo setup.
   * **Action**: Create `scripts/verify-workspace.ts`:
     ```typescript
     // scripts/verify-workspace.ts
     import { SOME_CONSTANT } from '@shared/constants';
     import { SomeType } from '@shared/types';

     console.log('âœ… Successfully imported SOME_CONSTANT:', SOME_CONSTANT);
     const testVar: SomeType = { id: '1', name: 'test' };
     console.log('âœ… Successfully typed with SomeType:', testVar);
     console.log('ðŸŽ‰ Workspace resolution is working correctly!');
     ```
   * **Action**: Add a `verify:workspace` script to the root `package.json`:
     ```json
     "scripts": {
       "verify:workspace": "tsx scripts/verify-workspace.ts"
     }
     ```
3. **Centralize CI Build Command**: Ensure CI uses a recursive, error-propagating build command.
   * **Action**: The root `build` script must be: `"build": "pnpm -r --workspace-concurrency=1 run build"`. The `--workspace-concurrency=1` flag ensures logs are sequential and readable.

#### HIGH RISK: Git Hooks Blocking Developer Workflow (OPS-001) - Priority: HIGH (Score 6)
**Problem**: Overly aggressive or slow Husky hooks can block commits/pushes during emergencies or tight deadlines, leading developers to bypass them entirely and defeat their purpose.

**Mitigation & Implementation**:
1. **Provide Clear Bypass Instructions**: Hooks must fail with informative messages that tell the developer *how* to bypass them.
   * **Action**: Add the following pattern to the top of every hook script (e.g., `.husky/pre-commit`):
     ```bash
     #!/usr/bin/env sh
     . "$(dirname -- "$0")/_/husky.sh"

     echo "ðŸ›¡ï¸ Running pre-commit checks..."
     echo "ðŸ’¡ TIP: To bypass, run 'git commit --no-verify'"

     # Example for pre-commit
     pnpm lint-staged || {
       echo "âŒ Pre-commit checks failed. Please fix the issues above."
       echo "ðŸ’¡ To bypass this check in an emergency, run: git commit --no-verify"
       exit 1
     }
     echo "âœ… Pre-commit checks passed."
     ```
2. **Optimize Hook Speed**: Use `lint-staged` to ensure hooks only operate on changed files, not the entire codebase. This is critical for keeping commit times fast.
   * **Action**: Add a `lint-staged` configuration to the root `package.json`:
     ```json
     "lint-staged": {
       "*.{ts,tsx}": [
         "eslint --fix",
         "prettier --write"
       ],
       "*.{js,jsx,json,md}": "prettier --write"
     }
     ```

#### MEDIUM RISK: Developer Environment Divergence (DEV-001) - Priority: HIGH (Score 6)
**Problem**: Developers using different Node.js or `pnpm` versions can cause subtle bugs, inconsistent behavior, and "works on my machine" issues.

**Mitigation & Implementation**:
1. **Enforce Engine Versions**: Use the `engines` field in the root `package.json` to specify exact Node and pnpm versions. This will cause `pnpm install` to fail if the versions don't match.
   * **Action**: Add to root `package.json`:
     ```json
     "engines": {
       "node": ">=24.11.1",
       "pnpm": ">=10.0.0"
     }
     ```
   * **Action**: To enforce this, create a `.npmrc` file in the root with `engine-strict=true`.
2. **VS Code Extension Recommendations**: While not enforceable, providing workspace recommendations nudges developers to install critical extensions (ESLint, Prettier).
   * **Action**: Create `.vscode/extensions.json`:
     ```json
     {
       "recommendations": [
         "dbaeumer.vscode-eslint",
         "esbenp.prettier-vscode",
         "bradlc.vscode-tailwindcss",
         "prisma.prisma",
         "vitest.explorer"
       ]
     }
     ```

#### HIGH RISK: Build & CI Scripts Failing Silently (OPS-002) - Priority: HIGH (Score 6)
**Problem**: Build failures within the monorepo can be hidden if the root script doesn't correctly propagate exit codes, leading to deployments of broken code.

**Mitigation & Implementation**:
1. **Create a Build Verification Script**: A post-build script should check that the expected artifacts were actually created.
   * **Action**: Create `scripts/verify-build.js`:
     ```javascript
     const fs = require('fs');
     const path = require('path');
     const requiredOutputs = [
       'backend/dist/index.js',
       'dashboard/.next/BUILD_ID',
       'shared/dist/index.js',
     ];
     console.log('ðŸ” Verifying build outputs...');
     const notFound = requiredOutputs.filter(
       (p) => !fs.existsSync(path.join(__dirname, '..', p))
     );
     if (notFound.length > 0) {
       console.error(`âŒ Build verification failed! Missing outputs:`, notFound);
       process.exit(1);
     }
     console.log('âœ… All build outputs found.');
     ```
   * **Action**: Add a `postbuild` script to the root `package.json` to run this automatically after every build.
     ```json
     "scripts": {
       "build": "pnpm -r --workspace-concurrency=1 run build",
       "postbuild": "node scripts/verify-build.js"
     }
     ```

#### MEDIUM RISK: TypeScript Strict Mode & 3rd-Party Types (TECH-002) - Priority: MEDIUM (Score 4)
**Problem**: The project's strict TypeScript settings can cause build failures when using third-party libraries that have poor or incorrect type definitions.

**Mitigation & Implementation**:
1. **Use Declaration Files for Overrides**: Create dedicated `.d.ts` files to override or augment problematic third-party types. This is cleaner than using `@ts-ignore`.
   * **Action**: Create `backend/src/types/overrides.d.ts`. Add a documented example for how a developer should handle this.
     ```typescript
     // backend/src/types/overrides.d.ts

     /*
      * This file contains TypeScript declaration overrides for third-party libraries.
      * Use this to fix incorrect or missing types from dependencies.
      *
      * Example for a hypothetical library 'some-lib':
      * declare module 'some-lib' {
      *   export interface ProblematicInterface {
      *     correctedProperty: string; // Was missing or wrong type
      *   }
      * }
     */
     ```
   * **Action**: Ensure `tsconfig.json` includes this file.

#### MEDIUM RISK: ESLint/Prettier Rule Conflicts (TECH-003) - Priority: MEDIUM (Score 4)
**Problem**: ESLint's formatting rules can conflict with Prettier, leading to infinite loops in format-on-save and CI failures.

**Mitigation & Implementation**:
1. **Use `eslint-config-prettier`**: This package disables all ESLint rules that are unnecessary or might conflict with Prettier.
   * **Action**: Ensure `eslint-config-prettier` is the **last** item in the `extends` array of `.eslintrc.js` to ensure it correctly overrides other configs.
     ```javascript
     // .eslintrc.js
     module.exports = {
       // ...
       extends: [
         'eslint:recommended',
         'plugin:@typescript-eslint/recommended',
         // ... other configs ...
         'prettier', // MUST BE LAST
       ],
     };
     ```
2. **Create a Validation Script**: A single script should run all format, lint, and type checks in the correct order.
   * **Action**: Add a `validate` script to the root `package.json`:
     ```json
     "scripts": {
       "validate": "pnpm format:check && pnpm lint && pnpm typecheck"
     }
     ```

**VS Code Settings** (.vscode/settings.json must include):
```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "eslint.validate": ["javascript", "javascriptreact", "typescript", "typescriptreact"]
}
```

#### MEDIUM RISK: Configuration Complexity & Brittleness (TECH-006) - Priority: MEDIUM (Score 4)
**Problem**: The project has numerous configuration files. A change in one place (e.g., a path in `tsconfig.json`) can break another (e.g., `vitest.config.ts`) without an obvious error.

**Mitigation & Implementation**:
1. **Centralize Path Aliases**: Define path aliases in `tsconfig.base.json` and ensure other tools (like Vitest) read from it to avoid duplication.
   * **Action**: Update `vitest.config.ts` to use `tsconfig-paths` to automatically read aliases from `tsconfig.json`.
     ```typescript
     // vitest.config.ts
     import { defineConfig } from 'vitest/config';
     import tsconfigPaths from 'vitest-tsconfig-paths';

     export default defineConfig({
       plugins: [tsconfigPaths()], // This plugin reads aliases from tsconfig
       test: {
         // ...
       },
     });
     ```
2. **Add Configuration Comments**: Add comments to all configuration files explaining *why* a setting is a certain way, especially if it's non-obvious or related to another file.
   * **Action**: Mandate that all non-trivial configuration options are commented. For example:
     ```json
     // tsconfig.base.json
     {
       "compilerOptions": {
         // Enables tools like Vitest to resolve '@/' paths
         "baseUrl": ".",
         "paths": {
           "@/*": ["./src/*"],
           "@shared/*": ["../shared/src/*"]
         }
       }
     }
     ```

### Project Structure
[Source: architecture.md#3-repository-structure]

The project uses a pnpm monorepo structure:
```
antone/
â”œâ”€â”€ backend/          # Hono API server + workers
â”œâ”€â”€ dashboard/        # Next.js 16 frontend
â”œâ”€â”€ shared/           # Shared types, constants, schemas
â”œâ”€â”€ database/         # Prisma schema and migrations
â”œâ”€â”€ docker/           # Docker compose files
â”œâ”€â”€ scripts/          # Utility scripts
â”œâ”€â”€ .husky/           # Git hooks
â”œâ”€â”€ .vscode/          # VS Code workspace settings
â”œâ”€â”€ tsconfig.base.json
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ vitest.config.ts
â””â”€â”€ package.json
```

### TypeScript Base Configuration
[Source: architecture.md#2-technology-stack - Coding Standards]

```json
{
  "compilerOptions": {
    "target": "ES2024",
    "lib": ["ES2024"],
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "strictBindCallApply": true,
    "strictPropertyInitialization": true,
    "noImplicitThis": true,
    "alwaysStrict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    "noImplicitOverride": true,
    "noPropertyAccessFromIndexSignature": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "removeComments": false,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "exclude": ["node_modules", "dist", "**/*.spec.ts", "**/*.test.ts"]
}
```

### ESLint Configuration
[Source: architecture.md#2-technology-stack - ESLint Configuration Standards]

Key rules to configure:
- `@typescript-eslint/explicit-function-return-type: error`
- `@typescript-eslint/no-explicit-any: error`
- `@typescript-eslint/no-floating-promises: error`
- `@typescript-eslint/await-thenable: error`
- `@typescript-eslint/no-misused-promises: error`
- `@typescript-eslint/prefer-nullish-coalescing: error`
- `@typescript-eslint/prefer-optional-chain: error`
- `import/order` with groups and alphabetize
- `security/detect-object-injection: warn`
- `security/detect-non-literal-regexp: warn`

### Prettier Configuration
[Source: architecture.md#2-technology-stack - Prettier Configuration Standards]

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "arrowParens": "always",
  "endOfLine": "lf",
  "bracketSpacing": true,
  "bracketSameLine": false,
  "quoteProps": "as-needed",
  "proseWrap": "preserve"
}
```

### Root package.json Dependencies
[Source: architecture.md#3.2-package-dependencies]

```json
{
  "name": "antone",
  "private": true,
  "packageManager": "pnpm@10.0.0",
  "engines": {
    "node": ">=24.11.0",
    "pnpm": ">=10.0.0"
  },
  "devDependencies": {
    "@types/node": "^24.11.0",
    "typescript": "^5.9.3",
    "eslint": "^9.15.0",
    "@typescript-eslint/eslint-plugin": "^8.17.0",
    "@typescript-eslint/parser": "^8.17.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-plugin-import": "^2.31.0",
    "eslint-plugin-security": "^3.0.1",
    "prettier": "^3.4.0",
    "husky": "^9.1.7",
    "lint-staged": "^15.2.11",
    "@commitlint/cli": "^19.6.1",
    "@commitlint/config-conventional": "^19.6.0"
  }
}
```

### Backend Dependencies
[Source: architecture.md#3.2-package-dependencies]

```json
{
  "dependencies": {
    "hono": "^4.6.0",
    "@hono/node-server": "^1.13.0",
    "@prisma/client": "^7.0.1",
    "twitter-api-v2": "^1.17.2",
    "snoowrap": "^1.23.0",
    "axios": "^1.7.9",
    "zod": "^3.24.1",
    "pino": "^9.5.0",
    "pino-pretty": "^12.0.0",
    "simple-statistics": "^7.8.3",
    "jstat": "^1.9.6",
    "seedrandom": "^3.0.5",
    "ioredis": "^5.4.2",
    "node-cron": "^3.0.3",
    "uuid": "^11.0.3",
    "dotenv": "^16.4.7"
  },
  "devDependencies": {
    "@types/uuid": "^10.0.0",
    "@types/node": "^24.11.0",
    "@types/simple-statistics": "^7.8.3",
    "@types/jstat": "^1.9.3",
    "vitest": "^2.1.8",
    "ts-node": "^10.9.2",
    "tsx": "^4.19.2",
    "prisma": "^7.0.1",
    "typescript": "^5.9.3"
  }
}
```

### Dashboard Dependencies
[Source: architecture.md#3.2-package-dependencies]

```json
{
  "dependencies": {
    "next": "^16.0.2",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "@tanstack/react-query": "^5.62.11",
    "recharts": "^2.15.0",
    "lucide-react": "^0.468.0",
    "clsx": "^2.1.1",
    "tailwind-merge": "^2.5.5",
    "date-fns": "^4.1.0",
    "socket.io-client": "^4.8.1"
  },
  "devDependencies": {
    "@types/react": "^19.0.2",
    "@types/react-dom": "^19.0.2",
    "tailwindcss": "^4.0.0",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.49",
    "typescript": "^5.9.3"
  }
}
```

### Git Hooks Configuration
[Source: architecture.md#3.3-development-tooling-configuration]

**Pre-commit (.husky/pre-commit):**
```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"
pnpm lint-staged
pnpm typecheck
```

**Pre-push (.husky/pre-push):**
```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"
pnpm test
pnpm build
```

### File Naming Conventions
[Source: architecture.md#2-technology-stack - File Naming Conventions]

- Backend services: `kebab-case.ts` (e.g., `decision-engine.ts`)
- Backend classes: `PascalCase.ts` (e.g., `DecisionEngine.ts`)
- Backend utilities: `kebab-case.ts` (e.g., `rate-limiter.ts`)
- Backend types: `kebab-case.types.ts` (e.g., `decision.types.ts`)
- Tests: `*.test.ts` or `*.spec.ts`
- Frontend components: `PascalCase.tsx` (e.g., `MetricCard.tsx`)
- Frontend pages: `kebab-case/page.tsx` (e.g., `kpis/page.tsx`)
- Frontend hooks: `use-kebab-case.ts` (e.g., `use-websocket.ts`)

---

## Testing

### Test File Location
[Source: architecture.md#13-testing-strategy]

- Backend unit tests: `backend/tests/unit/`
- Backend integration tests: `backend/tests/integration/`
- Dashboard tests: `dashboard/tests/` (for Story 1.1, minimal testing needed)

### Testing Standards
- Testing framework: **Vitest 2.1.x** (faster than Jest)
- Coverage provider: **v8**
- Coverage thresholds: 80% lines, 80% functions, 75% branches, 80% statements
- Test file patterns: `**/*.{test,spec}.{ts,tsx}`

### Story-Specific Testing Requirements
For Story 1.1, verify:
1. All packages build without errors: `pnpm build`
2. Linting passes: `pnpm lint`
3. Type checking passes: `pnpm typecheck`
4. Husky hooks are executable
5. pnpm workspace resolution works correctly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |
| 2024-12-02 | 1.1 | Architectural review: Added risk mitigation strategies for HIGH/MEDIUM risks (TECH-001, OPS-001, TECH-002, TECH-003, OPS-002). Added Tasks 16-20 for verification scripts, enhanced git hooks, type overrides, ESLint/Prettier validation, and comprehensive workspace testing. | Winston (Architect) |
| 2024-12-02 | 1.2 | **COMPREHENSIVE QA-DRIVEN UPDATE**: Integrated complete risk assessment (7 risks: 1 CRITICAL, 3 HIGH, 3 MEDIUM). Replaced all mitigation strategies with detailed, implementable code blocks from QA assessment 1.1-risk-20251202.md. Added DEV-001 (Environment Divergence) mitigation with .npmrc enforcement. Enhanced all verification scripts with emojis and clear messaging. Updated tasks to reference specific risk IDs. Added vitest-tsconfig-paths plugin for TECH-006 mitigation. Status: **NO-GO until all High/Critical mitigations implemented**. | Winston (Architect) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

No code is available for review as the story is in the "Draft" status. The story itself, however, serves as a high-quality blueprint for development, prescribing strict code quality, testing, and dependency management standards from the outset.

### Refactoring Performed

None. No code to refactor.

### Compliance Check

- Coding Standards: âœ“ (Prescribed in story)
- Project Structure: âœ“ (Prescribed in story)
- Testing Strategy: âœ“ (Prescribed in story)
- All ACs Met: âœ— (Not implemented)

### Improvements Checklist

- [ ] Implement all tasks as defined in the story.
- [ ] Verify all risk mitigations (TECH-001, OPS-001, DEV-001, etc.) are implemented correctly.
- [ ] Run all verification scripts (`verify-workspace.ts`, `verify-build.js`) upon completion.
- [ ] Ensure all git hooks are functional and provide clear output.

### Security Review

The story includes plans for security plugins (ESLint) and addresses dependency management, which are good proactive measures. No implementation to review.

### Performance Considerations

The story specifies high-performance tooling choices (Hono, Vitest, Turbopack, pnpm). No implementation to review.

### Files Modified During Review

None.

### Gate Status

Gate: CONCERNS â†’ `docs/qa/gates/1.1-project-setup-monorepo-structure.yml`
Risk profile: `docs/qa/assessments/1.1-risk-20251202.md`
NFR assessment: Not applicable for this foundational story.

### Recommended Status

âœ— **Changes Required** - The story is ready for a developer to *start* work, but it is not "Ready for Done". The status should be moved to "In Progress" once development begins. The final status depends on the successful implementation of all tasks and risk mitigations.
*To be filled by QA Agent*

