# Story 3.3: Reply Generator with DeepSeek Integration

## Status: Draft

## Story

**As a** the system,  
**I want** to generate contextually appropriate, screenshot-worthy replies by combining archetypes with DeepSeek-powered customization,  
**so that** each message feels personalized, naturally shareable, and compliant.

## Acceptance Criteria

1. Reply generator created at `@backend/generation/reply-generator.ts`
2. Function accepts: decision object, post content, author data, selected archetype, power_user flag, temporal_context
3. **DeepSeek R1 API integration** for content generation with screenshot-worthy enhancement
4. **Story-Worthy Content Enhancement**: Memorable hooks, quotable wisdom, visual structure, shareable positioning
5. **Dynamic Social Proof**: Fetch help count, rotate testimonials
6. **Confident Product Positioning**: Assertive CTAs, first-person advocacy, benefit-driven
7. Compliance validation run on generated reply
8. Platform formatting applied: Character limits enforced
9. **Power User Special Handling**: Extra polish with second DeepSeek pass
10. Reply written to `replies` table with all metadata
11. Processing time <3 seconds per reply
12. Self-confidence scoring: <0.85 triggers human review queue
13. Integration test: Generate 20 replies, verify variety, compliance, shareability
14. Dashboard shows generated replies with shareability score

---

## Tasks / Subtasks

- [ ] **Task 1: Create Reply Generator Module** (AC: 1, 2)
  - [ ] Create `backend/src/generation/reply-generator.ts`
  - [ ] Implement generateReply() function
  - [ ] Accept all required parameters
  - [ ] Return generated reply with metadata

- [ ] **Task 2: Implement DeepSeek Prompt Building** (AC: 3)
  - [ ] Load archetype template
  - [ ] Build comprehensive prompt with all context
  - [ ] Include screenshot-worthy instructions
  - [ ] Include compliance guidelines
  - [ ] Include platform personality

- [ ] **Task 3: Implement Story-Worthy Enhancement** (AC: 4)
  - [ ] Add memorable hook generation
  - [ ] Add quotable one-liner generation
  - [ ] Apply visual structure (line breaks, bullets)
  - [ ] Add shareable positioning

- [ ] **Task 4: Implement Dynamic Social Proof** (AC: 5)
  - [ ] Query help count from database
  - [ ] Rotate testimonials from approved list
  - [ ] Build signature with current count
  - [ ] Cache count (refresh hourly)

- [ ] **Task 5: Implement Confident Positioning** (AC: 6)
  - [ ] Use assertive CTAs ("Worth trying")
  - [ ] First-person advocacy phrases
  - [ ] Benefit-driven language
  - [ ] Integrate with archetype templates

- [ ] **Task 6: Implement Compliance Check** (AC: 7)
  - [ ] Call complianceValidator.validate()
  - [ ] If violations, regenerate with feedback
  - [ ] Max 2 regeneration attempts
  - [ ] Escalate to human if still failing

- [ ] **Task 7: Implement Platform Formatting** (AC: 8)
  - [ ] Twitter/Threads: ≤320 chars
  - [ ] Reddit: ≤500 chars
  - [ ] Truncate gracefully if needed
  - [ ] Preserve signature

- [ ] **Task 8: Implement Power User Handling** (AC: 9)
  - [ ] Detect power user flag
  - [ ] Run second DeepSeek pass for refinement
  - [ ] Adjust tone to more professional
  - [ ] Extra polish and precision

- [ ] **Task 9: Save Reply to Database** (AC: 10)
  - [ ] Create reply record in replies table
  - [ ] Link to decision via decision_id
  - [ ] Store archetype, platform, help_count
  - [ ] Set approval_status to PENDING

- [ ] **Task 10: Implement Confidence Scoring** (AC: 12)
  - [ ] Extract confidence from DeepSeek response
  - [ ] If <0.85, flag for human review
  - [ ] Log low confidence cases

- [ ] **Task 11: Write Integration Test** (AC: 13)
  - [ ] Generate 20 test replies
  - [ ] Verify archetype variety
  - [ ] Verify compliance (no violations)
  - [ ] Verify shareability elements present

---

## Dev Notes

### Previous Story Insights
- Story 2.1 complete (DeepSeek client)
- Story 2.10 complete (archetype selection)
- Story 3.1 complete (compliance validator)
- Story 3.2 complete (archetype templates)

### Reply Generator Implementation
[Source: architecture.md#7.2-core-domain-modules]

```typescript
// backend/src/generation/reply-generator.ts

import { Decision, Post, Author, Archetype, Platform } from '@prisma/client';
import { DeepSeekClient } from '../clients/deepseek';
import { complianceValidator } from '../compliance/validator';
import { prisma } from '../db';
import { logger } from '../utils/logger';
import archetypeTemplates from '../data/message-archetypes.json';
import { platformPersonality } from './platform-personality';

interface GeneratedReply {
  content: string;
  archetype: Archetype;
  confidence: number;
  helpCount: number;
  utmCode: string;
  shareabilityScore: number;
}

export class ReplyGenerator {
  private deepseek: DeepSeekClient;
  private helpCountCache: number = 0;
  private helpCountLastFetch: number = 0;

  constructor() {
    this.deepseek = new DeepSeekClient();
  }

  async generateReply(params: {
    decision: Decision;
    post: Post;
    author: Author;
    archetype: Archetype;
    isPowerUser: boolean;
    temporalContext: any;
  }): Promise<GeneratedReply> {
    const { decision, post, author, archetype, isPowerUser, temporalContext } = params;

    try {
      // Get archetype template
      const template = this.getTemplate(archetype);
      
      // Get platform personality
      const personality = platformPersonality[post.platform];
      
      // Get dynamic social proof
      const helpCount = await this.getHelpCount();
      
      // Build DeepSeek prompt
      const prompt = this.buildPrompt({
        post,
        author,
        archetype,
        template,
        personality,
        mode: decision.mode,
        isPowerUser,
        competitorDetected: decision.competitorDetected,
        temporalContext,
        helpCount,
      });

      // Generate with DeepSeek R1
      let generated = await this.deepseek.generate(prompt, {
        temperature: 0.7,
        maxTokens: 500,
      });

      // Power user extra polish
      if (isPowerUser && generated.confidence >= 0.85) {
        generated = await this.refineForPowerUser(generated.content, author);
      }

      // Compliance check
      const complianceResult = complianceValidator.validate(generated.content);
      
      if (!complianceResult.valid) {
        logger.warn('Compliance violation in generated reply', {
          violations: complianceResult.violations,
        });
        // Regenerate with compliance feedback
        generated = await this.regenerateWithFeedback(params, complianceResult.violations);
      }

      // Apply platform formatting
      const formatted = this.formatForPlatform(generated.content, post.platform, personality);

      // Add signature with social proof
      const withSignature = this.addSignature(formatted, helpCount);

      // Generate UTM code
      const utmCode = this.generateUtmCode(post.id);

      // Calculate shareability score
      const shareabilityScore = this.calculateShareability(withSignature);

      // Save to database
      const reply = await this.saveReply({
        decisionId: decision.id,
        content: withSignature,
        archetype,
        platform: post.platform,
        utmCode,
        helpCount,
        confidence: generated.confidence,
        isPowerUser,
      });

      return {
        content: withSignature,
        archetype,
        confidence: generated.confidence,
        helpCount,
        utmCode,
        shareabilityScore,
      };
    } catch (error) {
      logger.error('Reply generation failed', { error, postId: post.id });
      throw error;
    }
  }

  private buildPrompt(params: any): string {
    const { post, author, archetype, template, personality, mode, isPowerUser, 
            competitorDetected, temporalContext, helpCount } = params;

    return `
You are Antone, a helpful and empathetic social media assistant for Vita.

PLATFORM: ${personality.platform}
TONE: ${personality.tone}
CHARACTER LIMIT: ${personality.charLimit}

ORIGINAL POST:
"${post.content}"

AUTHOR CONTEXT:
- Handle: ${author.handle}
- Power User: ${isPowerUser ? 'YES - use premium tone' : 'No'}
- Relationship: ${author.relationshipScore > 0.6 ? 'Positive history' : 'New contact'}

MODE: ${mode}
ARCHETYPE: ${archetype}
TEMPLATE: ${JSON.stringify(template)}

TIME CONTEXT: ${temporalContext.phase}
${temporalContext.toneAdjustment ? `TONE ADJUSTMENT: ${temporalContext.toneAdjustment}` : ''}

${competitorDetected ? `
COMPETITOR MENTIONED: ${competitorDetected}
Use polite, educational positioning. Never attack the competitor.
Focus on Vita's transdermal delivery as differentiation.
` : ''}

SCREENSHOT-WORTHY REQUIREMENTS:
1. Open with a MEMORABLE HOOK (avoid generic openers like "Sorry to hear")
   - Examples: "Your liver is basically a bouncer dealing with way too many guests..."
   - "Hangovers are just your body sending you an invoice for last night"
2. Include a QUOTABLE ONE-LINER users want to screenshot
3. Visual structure: Use line breaks, 1-2 emojis max, bullet points
4. Make it SHAREABLE: "Save this for next time" positioning

Generate a reply that:
1. Opens with genuine empathy (MEMORABLE, not generic)
2. Provides actionable, practical value
3. ${mode === 'HELPFUL' ? 'Includes confident product mention with link' : 
   mode === 'ENGAGEMENT' ? 'NO product mention - pure value only' :
   'Soft, casual product mention if natural'}
4. Ends with signature: "—Antone (Vita) | Helped ${helpCount.toLocaleString()} people this month"
5. Is screenshot-worthy and shareable
6. Stays within ${personality.charLimit} characters

FORBIDDEN TERMS:
- "cure", "prevent", "treat", "clinically proven", "FDA approved", "guaranteed"
- Generic openers: "Sorry to hear", "I understand", "Hope you feel better"
- Pushy CTAs: "Buy now", "Don't miss out", "Limited time"

REPLY:`;
  }

  private async getHelpCount(): Promise<number> {
    // Cache for 1 hour
    const now = Date.now();
    if (now - this.helpCountLastFetch < 60 * 60 * 1000 && this.helpCountCache > 0) {
      return this.helpCountCache;
    }

    const count = await prisma.reply.count({
      where: {
        postedAt: {
          gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), // Last 30 days
        },
      },
    });

    this.helpCountCache = count;
    this.helpCountLastFetch = now;
    return count;
  }

  private addSignature(content: string, helpCount: number): string {
    return `${content}\n\n—Antone (Vita) | Helped ${helpCount.toLocaleString()} people this month`;
  }

  private generateUtmCode(postId: string): string {
    return `antone_${postId.substring(0, 8)}`;
  }

  private calculateShareability(content: string): number {
    let score = 0.5;

    // Has memorable hook
    if (/(liver is|body sending|future self)/i.test(content)) score += 0.15;
    
    // Has line breaks (visual structure)
    if ((content.match(/\n/g) || []).length >= 2) score += 0.10;
    
    // Has numbered list or bullets
    if (/[1-3]\.|•/.test(content)) score += 0.15;
    
    // Has emojis (1-2)
    const emojiCount = (content.match(/[\u{1F300}-\u{1F9FF}]/gu) || []).length;
    if (emojiCount >= 1 && emojiCount <= 2) score += 0.10;

    return Math.min(score, 1.0);
  }

  private formatForPlatform(content: string, platform: Platform, personality: any): string {
    if (content.length <= personality.charLimit) {
      return content;
    }

    // Truncate gracefully
    return content.substring(0, personality.charLimit - 3) + '...';
  }

  private async refineForPowerUser(content: string, author: Author): Promise<any> {
    const refinePrompt = `
Refine this reply for a power user (${author.followerCount.toLocaleString()} followers).
Make it more polished and professional while keeping the personality.

ORIGINAL:
${content}

REFINED (maintain all content, just polish the tone):`;

    return this.deepseek.generate(refinePrompt, { temperature: 0.5, maxTokens: 400 });
  }

  private async regenerateWithFeedback(params: any, violations: string[]): Promise<any> {
    const feedbackPrompt = `Previous attempt had compliance violations: ${violations.join(', ')}
    
Please regenerate avoiding these specific violations.
${this.buildPrompt(params)}`;

    return this.deepseek.generate(feedbackPrompt);
  }

  private getTemplate(archetype: Archetype): any {
    return archetypeTemplates.archetypes[archetype];
  }

  private async saveReply(data: any): Promise<any> {
    return prisma.reply.create({
      data: {
        decisionId: data.decisionId,
        content: data.content,
        archetype: data.archetype,
        platform: data.platform,
        utmCode: data.utmCode,
        helpCount: data.helpCount,
        approvalStatus: data.confidence >= 0.90 ? 'AUTO_APPROVED' : 'PENDING',
      },
    });
  }
}

// Export singleton
export const replyGenerator = new ReplyGenerator();
```

### File Structure
```
backend/src/
└── generation/
    ├── reply-generator.ts       # THIS STORY
    ├── archetype-selector.ts
    └── platform-personality.ts
```

---

## Testing

### Test File Location
- `backend/tests/unit/generation/reply-generator.test.ts`
- `backend/tests/integration/generation/reply-flow.test.ts`

### Testing Standards
- Mock DeepSeek client
- Mock compliance validator
- Test all archetypes
- Test power user handling

### Story-Specific Testing Requirements
1. 20 replies generated with variety
2. All replies pass compliance
3. Shareability score calculated correctly
4. Power users get refined replies
5. Character limits respected
6. Processing time <3s
7. Confidence <0.85 triggers review queue

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*







