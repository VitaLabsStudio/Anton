# Story 3.11: Competitive Defensive Positioning Replies

## Status: Draft

## Story

**As a** the system,  
**I want** to generate polite, educational replies when competitors are mentioned,  
**so that** Antone positions Vita's unique value without attacking competitors.

## Acceptance Criteria

1. Competitive reply generator at `@backend/generation/competitive-replies.ts`
2. Function triggered when Story 2.12 detects competitor mention
3. **Positioning Message Templates**:
   - vs. Rehydration products: "Those work via rehydration; Vita uses transdermal delivery..."
   - vs. Hangover pills: "Pills can be tough when stomach upset. Vita patches deliver through skin..."
   - vs. IV therapy: "IV works but costs $100-200. Vita patches deliver similar for fraction of cost..."
   - vs. Home remedies: "Traditional remedies lack science. Vita patches deliver research-backed ingredients..."
4. **Tone Guidelines**:
   - Never attack: "X doesn't work"
   - Always educate: "X works via [mechanism]; Vita uses [different]"
   - Acknowledge strengths: "Those are popular for good reason..."
5. **Rate Limiting**: Max 5 competitive replies per day per competitor
6. **Archetype Selection**: Prefer Problem-Solution Direct, Credibility-anchor
7. Competitive replies tagged: `{reply_type: "competitive_positioning"}`
8. Dashboard tracking: Competitive conversion rate
9. Unit tests validate polite tone and factual accuracy
10. Integration test: Simulate competitor mention, verify positioning reply

---

## Tasks / Subtasks

- [ ] **Task 1: Create Competitive Reply Generator** (AC: 1)
  - [ ] Create `backend/src/generation/competitive-replies.ts`
  - [ ] Implement generateCompetitiveReply()
  - [ ] Accept competitor context from detector

- [ ] **Task 2: Create Positioning Templates** (AC: 3)
  - [ ] Template for rehydration products
  - [ ] Template for hangover pills
  - [ ] Template for IV therapy
  - [ ] Template for home remedies
  - [ ] Store in message-archetypes.json

- [ ] **Task 3: Implement Tone Guidelines** (AC: 4)
  - [ ] Educational, not combative
  - [ ] Acknowledge competitor strengths
  - [ ] Focus on differentiation
  - [ ] Never attack

- [ ] **Task 4: Implement Rate Limiting** (AC: 5)
  - [ ] Track competitive replies per competitor
  - [ ] Max 5 per day
  - [ ] Store in Redis with daily reset
  - [ ] Alert if exceeded

- [ ] **Task 5: Integrate with Archetype Selector** (AC: 6)
  - [ ] Prefer PROBLEM_SOLUTION_DIRECT
  - [ ] Or CREDIBILITY_ANCHOR
  - [ ] Avoid HUMOR_LIGHT, STORYLET

- [ ] **Task 6: Tag Competitive Replies** (AC: 7)
  - [ ] Set reply_type to COMPETITIVE_POSITIONING
  - [ ] Store competitor name
  - [ ] Track for analytics

- [ ] **Task 7: Create Analytics API** (AC: 8)
  - [ ] Track competitive conversion rate
  - [ ] Compare to non-competitive
  - [ ] Dashboard visualization

- [ ] **Task 8: Write Unit Tests** (AC: 9)
  - [ ] Test all positioning templates
  - [ ] Verify polite tone
  - [ ] Verify no claims violations
  - [ ] Test rate limiting

- [ ] **Task 9: Write Integration Test** (AC: 10)
  - [ ] Simulate competitor mention
  - [ ] Verify positioning reply generated
  - [ ] Verify polite educational tone

---

## Dev Notes

### Competitive Reply Generator
```typescript
// backend/src/generation/competitive-replies.ts

import { DeepSeekClient } from '../clients/deepseek';
import { complianceValidator } from '../compliance/validator';
import { logger } from '../utils/logger';
import Redis from 'ioredis';

const redis = new Redis();

const POSITIONING_TEMPLATES = {
  REHYDRATION: `Those work via oral rehydration—solid approach. 

Vita uses transdermal delivery which bypasses your upset stomach and doesn't require water when you're nauseous. Different mechanisms for different needs.

Worth comparing: {{link}}

—Antone (Vita)`,
  
  HANGOVER_PILLS: `Pills can be effective, but they're tough when your stomach's already upset.

Vita patches deliver B-vitamins and nutrients through your skin—nothing to swallow or digest. Works when pills won't stay down.

Check it out: {{link}}

—Antone (Vita)`,
  
  IV_THERAPY: `IV therapy works well but requires an appointment and runs $100-200.

Vita patches deliver similar nutrients transdermally for a fraction of the cost, right when you need it. Convenient alternative worth knowing about.

Learn more: {{link}}

—Antone (Vita)`,
  
  HOME_REMEDY: `Traditional remedies have anecdotal support but limited peer-reviewed science.

Vita patches deliver research-backed ingredients (B-vitamins, glutathione precursors) transdermally. Here's the actual science: {{link}}

—Antone (Vita)`,
};

export class CompetitiveReplyGenerator {
  private deepseek: DeepSeekClient;

  constructor() {
    this.deepseek = new DeepSeekClient();
  }

  async generateCompetitiveReply(params: {
    post: any;
    competitor: string;
    competitorCategory: string;
    sentiment: string;
    satisfaction: string;
  }): Promise<string> {
    const { post, competitor, competitorCategory, sentiment, satisfaction } = params;

    // Check rate limit
    const canReply = await this.checkRateLimit(competitor);
    if (!canReply) {
      logger.warn('Competitive rate limit reached', { competitor });
      throw new Error('Rate limit reached for competitor');
    }

    // Get base template
    const template = POSITIONING_TEMPLATES[competitorCategory] || POSITIONING_TEMPLATES.REHYDRATION;

    // Customize with DeepSeek
    const prompt = this.buildCompetitivePrompt(post, competitor, template, sentiment, satisfaction);
    const generated = await this.deepseek.generate(prompt);

    // Compliance check
    const compliance = complianceValidator.validate(generated.content);
    if (!compliance.valid) {
      logger.warn('Competitive reply compliance violation', { violations: compliance.violations });
      // Use safe template fallback
      return template;
    }

    // Increment rate limit counter
    await this.incrementRateLimit(competitor);

    return generated.content;
  }

  private buildCompetitivePrompt(
    post: any,
    competitor: string,
    template: string,
    sentiment: string,
    satisfaction: string
  ): string {
    return `
Generate a polite, educational reply about Vita when ${competitor} is mentioned.

POST: "${post.content}"
COMPETITOR: ${competitor}
USER SENTIMENT: ${sentiment}
USER SATISFACTION: ${satisfaction}

TEMPLATE:
${template}

TONE REQUIREMENTS:
- Polite and educational (NEVER attack ${competitor})
- Acknowledge ${competitor} strengths: "Those are popular for good reason..."
- Focus on Vita's DIFFERENTIATION (transdermal delivery)
- Educational: "X works via [mechanism]; Vita uses [different mechanism]"

Generate the reply following the template structure.
REPLY:`;
  }

  private async checkRateLimit(competitor: string): Promise<boolean> {
    const key = `competitive_rate:${competitor}:${this.getDateKey()}`;
    const count = await redis.get(key);
    return !count || parseInt(count) < 5;
  }

  private async incrementRateLimit(competitor: string): Promise<void> {
    const key = `competitive_rate:${competitor}:${this.getDateKey()}`;
    await redis.incr(key);
    await redis.expire(key, 24 * 60 * 60); // 24 hour expiry
  }

  private getDateKey(): string {
    return new Date().toISOString().split('T')[0];
  }
}

export const competitiveReplyGenerator = new CompetitiveReplyGenerator();
```

### File Structure
```
backend/src/
└── generation/
    ├── reply-generator.ts
    ├── archetype-selector.ts
    ├── platform-personality.ts  # Story 3.10
    └── competitive-replies.ts   # THIS STORY
```

---

## Testing

### Test File Location
- `backend/tests/unit/generation/platform-personality.test.ts`
- `backend/tests/unit/generation/competitive-replies.test.ts`

### Testing Standards
- Test personality configs
- Test competitive templates
- Test rate limiting

### Story-Specific Testing Requirements
1. Platform personality configs complete
2. Twitter formatted ≤280 chars
3. Reddit formatted 300-500 chars
4. Threads includes hashtags
5. Competitive templates polite
6. No claims violations
7. Rate limit enforced (5/day)
8. Integration shows distinct personalities

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*

