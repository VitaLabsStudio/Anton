# Story 1.6: Threads API Authentication

## Status: Draft

## Story

**As** the system,  
**I want** to authenticate with Threads API (or Instagram Graph API as fallback),  
**so that** I can monitor threads and post replies on behalf of @antone_vita account.

## Acceptance Criteria

1. Meta Developer account created and Threads API access requested
2. Access token obtained and stored in `.env` file (development) or Docker secrets (production)
3. HTTP client module created at `@backend/platforms/threads/auth` (manual client if SDK unavailable)
4. Authentication module implements token refresh logic
5. Test endpoint `/api/threads/verify` successfully calls Threads API (user profile fetch)
6. **Rate limiting implemented**:
   - Token bucket algorithm: 200 requests/hour
   - Rate limiter class: `@backend/utils/rate-limiter.ts` (reuse from Story 1.4)
   - Integration: All API calls go through `rateLimiter.acquire('default')`
   - Monitoring: Request count tracked and logged
7. **Circuit breaker pattern** implemented for resilience:
   - Threshold: 5 consecutive failures → circuit opens
   - Timeout: 30 seconds (5 minutes if chronic failures)
   - Fail-fast: Reject immediately when OPEN
   - Class: `@backend/utils/circuit-breaker.ts` (reuse from Story 1.4)
8. Fallback implemented if Threads API unavailable (log warning, continue with X/Reddit)
9. Error responses documented and handled (401 Unauthorized, 429 Rate Limit, timeouts)

---

## Tasks / Subtasks

- [ ] **Task 1: Configure Rate Limiter for Threads** (AC: 6)
  - [ ] Add Threads bucket configuration to RateLimiter
  - [ ] Configure 200 requests/hour limit
  - [ ] Test rate limiter with Threads-specific timing

- [ ] **Task 2: Create Threads Auth Module** (AC: 3, 4)
  - [ ] Create `backend/src/platforms/threads/auth.ts`
  - [ ] Load access token from environment variables
  - [ ] Implement token validation check
  - [ ] Implement token refresh logic (if long-lived token)
  - [ ] Export authenticated axios instance

- [ ] **Task 3: Create Threads Client Class** (AC: 3, 6, 7)
  - [ ] Create `backend/src/platforms/threads/client.ts`
  - [ ] Use axios for HTTP requests (no official SDK)
  - [ ] Integrate RateLimiter for all operations
  - [ ] Integrate CircuitBreaker for resilience
  - [ ] Implement `search(query)` method
  - [ ] Implement `reply(threadId, content)` method
  - [ ] Implement `verifyCredentials()` method
  - [ ] Add comprehensive error handling

- [ ] **Task 4: Implement Fallback Logic** (AC: 8)
  - [ ] Create `isAvailable()` method
  - [ ] Log warning when Threads unavailable
  - [ ] System continues with Twitter/Reddit only
  - [ ] Dashboard shows Threads status

- [ ] **Task 5: Create Verification Endpoint** (AC: 5)
  - [ ] Create `backend/src/api/routes/threads.ts`
  - [ ] Implement `GET /api/threads/verify` endpoint
  - [ ] Return profile info and availability status
  - [ ] Log rate limit information

- [ ] **Task 6: Add to Router** (AC: 5)
  - [ ] Register threads routes in main Hono app
  - [ ] Add authentication middleware

- [ ] **Task 7: Update Environment Template** (AC: 2)
  - [ ] Add Threads access token to `.env.example`
  - [ ] Document Meta Developer setup
  - [ ] Note fallback behavior

- [ ] **Task 8: Handle Errors** (AC: 9)
  - [ ] Handle 401 Unauthorized (token expired)
  - [ ] Handle 429 Rate Limit (queue and retry)
  - [ ] Handle timeouts (30s default)
  - [ ] Log all errors with context

- [ ] **Task 9: Write Unit Tests** (AC: all)
  - [ ] Test Threads client with mocked axios
  - [ ] Test rate limiter with Threads config
  - [ ] Test fallback behavior
  - [ ] Test error handling

---

## Dev Notes

### Previous Story Insights
- Story 1.4 and 1.5 should be complete (provides RateLimiter and CircuitBreaker utilities)
- Threads API may not have official SDK - use axios
- Fallback is critical since Threads API is newest

### Threads Client Implementation
[Source: architecture.md#9.1-platform-api-clients]

```typescript
// backend/src/platforms/threads/client.ts

import axios, { AxiosInstance } from 'axios';
import { RateLimiter } from '../../utils/rate-limiter';
import { CircuitBreaker } from '../../utils/circuit-breaker';
import { logger } from '../../utils/logger';

export class ThreadsClient {
  private client: AxiosInstance;
  private rateLimiter: RateLimiter;
  private circuitBreaker: CircuitBreaker;
  private available: boolean = true;

  constructor() {
    this.client = axios.create({
      baseURL: 'https://graph.threads.net/v1.0',
      timeout: 30000,
      headers: {
        'Authorization': `Bearer ${process.env.THREADS_ACCESS_TOKEN}`,
        'Content-Type': 'application/json',
      },
    });

    // 200 requests/hour
    this.rateLimiter = new RateLimiter({
      default: { max: 200, windowMs: 60 * 60 * 1000 },
    });

    this.circuitBreaker = new CircuitBreaker({
      threshold: 5,
      timeout: 30000,
    });
  }

  async search(query: string): Promise<Thread[]> {
    if (!this.available) {
      logger.warn('Threads API unavailable, skipping search');
      return [];
    }

    await this.rateLimiter.acquire('default');
    
    return this.circuitBreaker.execute(async () => {
      const response = await this.client.get('/threads/search', {
        params: { q: query, limit: 50 },
      });
      return response.data.data || [];
    });
  }

  async reply(threadId: string, content: string): Promise<string> {
    if (!this.available) {
      throw new Error('Threads API unavailable');
    }

    await this.rateLimiter.acquire('default');
    
    return this.circuitBreaker.execute(async () => {
      const response = await this.client.post(`/threads/${threadId}/replies`, {
        text: content,
      });
      return response.data.id;
    });
  }

  async verifyCredentials(): Promise<{ valid: boolean; username: string }> {
    try {
      const response = await this.client.get('/me', {
        params: { fields: 'id,username,threads_profile_picture_url' },
      });
      this.available = true;
      return {
        valid: true,
        username: response.data.username,
      };
    } catch (error) {
      logger.error('Threads credential verification failed', { error });
      this.available = false;
      return { valid: false, username: '' };
    }
  }

  isAvailable(): boolean {
    return this.available;
  }
}
```

### Threads Auth Module
```typescript
// backend/src/platforms/threads/auth.ts

import axios from 'axios';
import { logger } from '../../utils/logger';

export interface ThreadsAuthConfig {
  accessToken: string;
  tokenExpiresAt?: Date;
}

export function createThreadsClient(config: ThreadsAuthConfig) {
  if (!config.accessToken) {
    logger.warn('Threads access token not configured, API will be unavailable');
    return null;
  }

  return axios.create({
    baseURL: 'https://graph.threads.net/v1.0',
    timeout: 30000,
    headers: {
      'Authorization': `Bearer ${config.accessToken}`,
      'Content-Type': 'application/json',
    },
  });
}

// Token refresh for long-lived tokens
export async function refreshThreadsToken(accessToken: string): Promise<string> {
  try {
    const response = await axios.get('https://graph.threads.net/refresh_access_token', {
      params: {
        grant_type: 'th_refresh_token',
        access_token: accessToken,
      },
    });
    return response.data.access_token;
  } catch (error) {
    logger.error('Failed to refresh Threads token', { error });
    throw error;
  }
}
```

### Environment Variables
```bash
# Threads API Credentials
THREADS_ACCESS_TOKEN=your_access_token

# Note: Threads uses Meta/Instagram Graph API authentication
# Token must be obtained via Meta Developer Console
# Long-lived tokens last 60 days and can be refreshed
```

### Error Handling
[Source: architecture.md#9.2-integration-failure-matrix]

| Error | Detection | Handling |
|-------|-----------|----------|
| API unavailable | Connection timeout | Retry 3x, then circuit breaker |
| 401 Unauthorized | HTTP 401 | Refresh token, alert if persistent |
| 429 Rate Limit | HTTP 429 | Queue with backoff |
| API not configured | Missing token | Fallback to Twitter/Reddit only |

### File Structure
```
backend/src/
├── platforms/
│   ├── twitter/
│   │   ├── auth.ts
│   │   └── client.ts
│   ├── reddit/
│   │   ├── auth.ts
│   │   └── client.ts
│   └── threads/
│       ├── auth.ts              # Authentication module
│       └── client.ts            # ThreadsClient class
└── api/
    └── routes/
        ├── twitter.ts
        ├── reddit.ts
        └── threads.ts           # Threads verification endpoint
```

### Fallback Behavior
When Threads API is unavailable:
1. Log warning at startup and each scan cycle
2. Skip Threads in stream monitoring
3. Dashboard shows "Threads: Unavailable"
4. Continue normal operation with Twitter and Reddit
5. Retry Threads verification every 5 minutes

---

## Testing

### Test File Location
- `backend/tests/unit/platforms/threads/client.test.ts`
- `backend/tests/integration/api/threads.test.ts`

### Testing Standards
- Mock axios responses
- Test rate limiter with Threads timing (200/hour)
- Test fallback when unavailable
- Test token refresh logic

### Story-Specific Testing Requirements
1. Verify credentials returns username
2. Fallback works when API unavailable
3. Rate limiter enforces 200 req/hour
4. Circuit breaker works with Threads client
5. `/api/threads/verify` returns availability status

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*

