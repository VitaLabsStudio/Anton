# Story 3.5: Platform Posting Service - Reddit & Threads

## Status: Draft

## Story

**As a** the system,  
**I want** to post approved replies to Reddit and Threads,  
**so that** u/antone_vita and @antone_vita can engage across all target platforms.

## Acceptance Criteria

1. Reddit posting service at `@backend/platforms/reddit/poster.ts`:
   - Post comment as reply to submission or comment
   - Rate limiting (60 requests per minute)
   - Subreddit-specific rules enforced (no links if restricted)
   - Error handling (removed by automod, user deleted post)
2. Threads posting service at `@backend/platforms/threads/poster.ts`:
   - Post reply via Threads API
   - Rate limiting (200 requests per hour)
   - Character limit enforcement (500 chars)
   - Error handling (user blocked, thread unavailable)
3. Both services update `replies` table with platform-specific post IDs
4. Posted replies logged with initial metrics
5. Integration tests post to staging accounts
6. Platform failures degrade gracefully

---

## Tasks / Subtasks

- [ ] **Task 1: Create Reddit Poster Module** (AC: 1)
  - [ ] Create `backend/src/platforms/reddit/poster.ts`
  - [ ] Implement postReply(replyId) function
  - [ ] Fetch reply and original post
  - [ ] Call Reddit API to post comment

- [ ] **Task 2: Implement Reddit Rate Limiting** (AC: 1)
  - [ ] Reuse RateLimiter (60 req/min)
  - [ ] Queue if limit reached

- [ ] **Task 3: Implement Subreddit Rules** (AC: 1)
  - [ ] Check subreddit for link restrictions
  - [ ] Remove links if not allowed
  - [ ] Log rule enforcement

- [ ] **Task 4: Create Threads Poster Module** (AC: 2)
  - [ ] Create `backend/src/platforms/threads/poster.ts`
  - [ ] Implement postReply(replyId) function
  - [ ] Use ThreadsClient from Story 1.6

- [ ] **Task 5: Implement Error Handling** (AC: 1, 2, 6)
  - [ ] Handle automod removal
  - [ ] Handle deleted posts
  - [ ] Handle user blocks
  - [ ] Degrade gracefully
  - [ ] Retry transient errors

- [ ] **Task 6: Update Reply Metadata** (AC: 3, 4)
  - [ ] Set platform_post_id
  - [ ] Set posted_at
  - [ ] Store initial metrics

- [ ] **Task 7: Write Integration Tests** (AC: 5)
  - [ ] Test Reddit posting to staging
  - [ ] Test Threads posting to staging
  - [ ] Verify visibility

---

## Dev Notes

### Reddit Poster Implementation
```typescript
// backend/src/platforms/reddit/poster.ts

import { RedditClient } from './client';
import { prisma } from '../../db';
import { logger } from '../../utils/logger';

export class RedditPoster {
  private client: RedditClient;
  private restrictedSubreddits = ['stopdrinking', 'alcoholism']; // No product links

  constructor() {
    this.client = new RedditClient();
  }

  async postReply(replyId: string): Promise<{ success: boolean; commentId?: string }> {
    try {
      const reply = await prisma.reply.findUnique({
        where: { id: replyId },
        include: {
          decision: {
            include: { post: true },
          },
        },
      });

      if (!reply || reply.approvalStatus !== 'APPROVED') {
        throw new Error('Reply not approved');
      }

      // Check subreddit rules
      const subreddit = this.extractSubreddit(reply.decision.post.content);
      let content = reply.content;
      
      if (this.restrictedSubreddits.includes(subreddit)) {
        content = this.removeLinks(content);
        logger.info('Removed links for restricted subreddit', { subreddit });
      }

      // Add UTM link
      content = this.addUtmLink(content, reply.utmCode);

      // Post to Reddit
      const commentId = await this.client.comment(
        reply.decision.post.platformPostId,
        content
      );

      // Update database
      await prisma.reply.update({
        where: { id: replyId },
        data: {
          platformPostId: commentId,
          postedAt: new Date(),
          metricsJson: { upvotes: 0, replies: 0 },
        },
      });

      logger.info('Reply posted to Reddit', { replyId, commentId });
      return { success: true, commentId };
    } catch (error: any) {
      logger.error('Failed to post Reddit reply', { error, replyId });
      return { success: false };
    }
  }

  private extractSubreddit(content: string): string {
    const match = content.match(/r\/(\w+)/);
    return match ? match[1].toLowerCase() : '';
  }

  private removeLinks(content: string): string {
    return content.replace(/https?:\/\/[^\s]+/g, '');
  }

  private addUtmLink(content: string, utmCode: string): string {
    const vitaLink = `https://vita.com?utm_source=antone&utm_content=${utmCode}`;
    return content.replace(/{{link}}/g, vitaLink);
  }
}

export const redditPoster = new RedditPoster();
```

### Threads Poster Implementation
```typescript
// backend/src/platforms/threads/poster.ts

import { ThreadsClient } from './client';
import { prisma } from '../../db';
import { logger } from '../../utils/logger';

export class ThreadsPoster {
  private client: ThreadsClient;

  constructor() {
    this.client = new ThreadsClient();
  }

  async postReply(replyId: string): Promise<{ success: boolean; threadId?: string }> {
    try {
      const reply = await prisma.reply.findUnique({
        where: { id: replyId },
        include: {
          decision: {
            include: { post: true },
          },
        },
      });

      if (!reply || reply.approvalStatus !== 'APPROVED') {
        throw new Error('Reply not approved');
      }

      // Enforce character limit (500 chars)
      let content = reply.content;
      if (content.length > 500) {
        content = content.substring(0, 497) + '...';
      }

      // Add UTM link
      content = this.addUtmLink(content, reply.utmCode);

      // Post to Threads
      const threadId = await this.client.reply(
        reply.decision.post.platformPostId,
        content
      );

      // Update database
      await prisma.reply.update({
        where: { id: replyId },
        data: {
          platformPostId: threadId,
          postedAt: new Date(),
          metricsJson: { hearts: 0, replies: 0 },
        },
      });

      logger.info('Reply posted to Threads', { replyId, threadId });
      return { success: true, threadId };
    } catch (error: any) {
      logger.error('Failed to post Threads reply', { error, replyId });
      
      // Graceful degradation
      if (!this.client.isAvailable()) {
        logger.warn('Threads unavailable, skipping post');
      }
      
      return { success: false };
    }
  }

  private addUtmLink(content: string, utmCode: string): string {
    const vitaLink = `https://vita.com?utm_source=antone&utm_content=${utmCode}`;
    return content.replace(/{{link}}/g, vitaLink);
  }
}

export const threadsPoster = new ThreadsPoster();
```

### File Structure
```
backend/src/
└── platforms/
    ├── twitter/
    │   └── poster.ts            # Story 3.4
    ├── reddit/
    │   └── poster.ts            # THIS STORY
    └── threads/
        └── poster.ts            # THIS STORY
```

---

## Testing

### Test File Location
- `backend/tests/unit/platforms/reddit/poster.test.ts`
- `backend/tests/unit/platforms/threads/poster.test.ts`
- `backend/tests/integration/platforms/posting.test.ts`

### Testing Standards
- Mock platform APIs
- Test error scenarios
- Test subreddit rules

### Story-Specific Testing Requirements
1. Reddit posts successfully
2. Threads posts successfully
3. Subreddit link restrictions enforced
4. Character limits enforced
5. Metadata updated correctly
6. Graceful degradation works

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*







