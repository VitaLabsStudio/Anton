# Story 2.9: Temporal Intelligence Engine

## Status: Draft

## Story

**As a** the decision engine,  
**I want** to adjust monitoring intensity and engagement strategies based on time-of-day and calendar patterns,  
**so that** Antone engages users during peak need windows and maximizes response effectiveness.

## Acceptance Criteria

1. Module created at `@backend/analysis/temporal-intelligence.ts`
2. **Peak Suffering Window Detection**:
   - Sunday 6-11am: 3× monitoring frequency (poll every 5 min vs 15 min)
   - Saturday-Sunday mornings: Priority queue processing (process these posts first)
3. **Thursday Prevention Campaign**:
   - Thursday 5-9pm: Proactive search for "weekend plans", "going out tonight" posts
   - Deploy prevention-focused archetypes
   - Lower SSS threshold (0.40 instead of 0.55) for prevention content
4. **Holiday Targeting Calendar**:
   - Pre-configured dates: New Year's Day, St. Patrick's Day, July 4th, Thanksgiving Eve, Halloween
   - 2 days before holiday: Prevention content boosted
   - Holiday morning: Maximum monitoring (5× normal frequency)
5. **Time-of-Day Archetype Adjustment**:
   - Late night (10pm-2am): More empathetic, less promotional tone
   - Morning (6-11am): More urgent, actionable advice (Checklist, Coach)
   - Afternoon (2-6pm): Reflective, educational content (Credibility-anchor)
6. Temporal context stored in decision JSON: `{temporal_context: "sunday_peak", monitoring_multiplier: 3.0}`
7. Dashboard shows temporal performance: CTR by hour-of-day, day-of-week heatmap
8. Unit tests validate time-based adjustments trigger correctly
9. Configuration file for holiday calendar at `@backend/config/temporal-calendar.json`

---

## Tasks / Subtasks

- [ ] **Task 1: Create Temporal Intelligence Module** (AC: 1)
  - [ ] Create `backend/src/analysis/temporal-intelligence.ts`
  - [ ] Implement getTemporalContext() function
  - [ ] Return context object with multiplier and phase

- [ ] **Task 2: Implement Peak Window Detection** (AC: 2)
  - [ ] Detect Sunday 6-11am (3× frequency)
  - [ ] Detect Saturday 6-11am (2× frequency)
  - [ ] Return monitoring multiplier
  - [ ] Flag posts in peak windows for priority

- [ ] **Task 3: Implement Thursday Prevention** (AC: 3)
  - [ ] Detect Thursday 5-9pm
  - [ ] Lower SSS threshold to 0.40
  - [ ] Boost prevention archetypes
  - [ ] Search for "going out", "weekend plans" keywords

- [ ] **Task 4: Create Holiday Calendar** (AC: 4, 9)
  - [ ] Create `backend/src/config/temporal-calendar.json`
  - [ ] Add major drinking holidays
  - [ ] Define pre-holiday prevention window (2 days before)
  - [ ] Define holiday morning boost (5× frequency)

- [ ] **Task 5: Implement Time-of-Day Adjustments** (AC: 5)
  - [ ] Late night (10pm-2am): Set tone = "empathetic"
  - [ ] Morning (6-11am): Prefer Checklist, Coach archetypes
  - [ ] Afternoon (2-6pm): Prefer Credibility-anchor
  - [ ] Return archetype preferences

- [ ] **Task 6: Store Temporal Context** (AC: 6)
  - [ ] Include in decision.temporalContext JSON
  - [ ] Store monitoring multiplier
  - [ ] Store time phase (peak, prevention, holiday, normal)

- [ ] **Task 7: Create Analytics API** (AC: 7)
  - [ ] Create endpoint GET /api/analytics/temporal
  - [ ] Return CTR by hour of day
  - [ ] Return engagement by day of week
  - [ ] Format for heatmap visualization

- [ ] **Task 8: Write Unit Tests** (AC: 8)
  - [ ] Test peak window detection
  - [ ] Test holiday detection
  - [ ] Test time-of-day preferences
  - [ ] Test Thursday prevention

---

## Dev Notes

### Previous Story Insights
- Story 1.7 complete (temporal multiplier in StreamMonitor)
- Story 2.5 complete (decision engine needs temporal context)

### Temporal Intelligence Implementation
```typescript
// backend/src/analysis/temporal-intelligence.ts

import holidays from '../config/temporal-calendar.json';
import { logger } from '../utils/logger';

interface TemporalContext {
  phase: 'peak_suffering' | 'prevention' | 'holiday' | 'normal';
  monitoringMultiplier: number;
  archetypePreferences: string[];
  toneAdjustment: string | null;
  sssThresholdAdjustment: number;
  isPriority: boolean;
}

export function getTemporalContext(): TemporalContext {
  const now = new Date();
  const hour = now.getHours();
  const day = now.getDay(); // 0 = Sunday
  const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD

  // Check for holiday
  const holidayContext = checkHoliday(dateStr);
  if (holidayContext) {
    return holidayContext;
  }

  // Peak suffering windows
  if (day === 0 && hour >= 6 && hour < 11) {
    return {
      phase: 'peak_suffering',
      monitoringMultiplier: 3.0,
      archetypePreferences: ['CHECKLIST', 'COACH', 'PROBLEM_SOLUTION_DIRECT'],
      toneAdjustment: 'urgent_actionable',
      sssThresholdAdjustment: 0,
      isPriority: true,
    };
  }

  if (day === 6 && hour >= 6 && hour < 11) {
    return {
      phase: 'peak_suffering',
      monitoringMultiplier: 2.0,
      archetypePreferences: ['CHECKLIST', 'COACH'],
      toneAdjustment: 'urgent_actionable',
      sssThresholdAdjustment: 0,
      isPriority: true,
    };
  }

  // Thursday prevention campaign
  if (day === 4 && hour >= 17 && hour < 21) {
    return {
      phase: 'prevention',
      monitoringMultiplier: 1.5,
      archetypePreferences: ['COACH', 'CREDIBILITY_ANCHOR'],
      toneAdjustment: 'preventive_educational',
      sssThresholdAdjustment: -0.15, // Lower threshold to 0.40
      isPriority: false,
    };
  }

  // Late night empathetic tone
  if (hour >= 22 || hour < 2) {
    return {
      phase: 'normal',
      monitoringMultiplier: 1.0,
      archetypePreferences: ['HUMOR_LIGHT', 'STORYLET', 'COACH'],
      toneAdjustment: 'empathetic_less_promotional',
      sssThresholdAdjustment: 0,
      isPriority: false,
    };
  }

  // Morning actionable
  if (hour >= 6 && hour < 12) {
    return {
      phase: 'normal',
      monitoringMultiplier: 1.0,
      archetypePreferences: ['CHECKLIST', 'COACH', 'PROBLEM_SOLUTION_DIRECT'],
      toneAdjustment: 'urgent_actionable',
      sssThresholdAdjustment: 0,
      isPriority: false,
    };
  }

  // Afternoon educational
  if (hour >= 14 && hour < 18) {
    return {
      phase: 'normal',
      monitoringMultiplier: 1.0,
      archetypePreferences: ['CREDIBILITY_ANCHOR', 'MYTHBUST', 'COACH'],
      toneAdjustment: 'reflective_educational',
      sssThresholdAdjustment: 0,
      isPriority: false,
    };
  }

  // Default
  return {
    phase: 'normal',
    monitoringMultiplier: 1.0,
    archetypePreferences: [],
    toneAdjustment: null,
    sssThresholdAdjustment: 0,
    isPriority: false,
  };
}

function checkHoliday(dateStr: string): TemporalContext | null {
  const holidayData = holidays.holidays as any[];
  
  for (const holiday of holidayData) {
    // Holiday morning (5× boost)
    if (dateStr === holiday.date) {
      return {
        phase: 'holiday',
        monitoringMultiplier: 5.0,
        archetypePreferences: ['CHECKLIST', 'COACH'],
        toneAdjustment: 'urgent_actionable',
        sssThresholdAdjustment: 0,
        isPriority: true,
      };
    }

    // 2 days before (prevention boost)
    const twoDaysBefore = new Date(holiday.date);
    twoDaysBefore.setDate(twoDaysBefore.getDate() - 2);
    if (dateStr === twoDaysBefore.toISOString().split('T')[0]) {
      return {
        phase: 'prevention',
        monitoringMultiplier: 1.5,
        archetypePreferences: ['COACH', 'CREDIBILITY_ANCHOR'],
        toneAdjustment: 'preventive_educational',
        sssThresholdAdjustment: -0.15,
        isPriority: false,
      };
    }
  }

  return null;
}
```

### Holiday Calendar Configuration
```json
// backend/src/config/temporal-calendar.json
{
  "version": "1.0",
  "holidays": [
    {
      "name": "New Year's Day",
      "date": "2025-01-01",
      "category": "major_drinking",
      "monitoringBoost": 5.0
    },
    {
      "name": "St. Patrick's Day",
      "date": "2025-03-17",
      "category": "major_drinking",
      "monitoringBoost": 5.0
    },
    {
      "name": "July 4th",
      "date": "2025-07-04",
      "category": "major_drinking",
      "monitoringBoost": 5.0
    },
    {
      "name": "Halloween",
      "date": "2025-10-31",
      "category": "major_drinking",
      "monitoringBoost": 4.0
    },
    {
      "name": "Thanksgiving Eve",
      "date": "2025-11-26",
      "category": "major_drinking",
      "monitoringBoost": 4.0
    },
    {
      "name": "Christmas Eve",
      "date": "2025-12-24",
      "category": "moderate_drinking",
      "monitoringBoost": 3.0
    },
    {
      "name": "New Year's Eve",
      "date": "2025-12-31",
      "category": "major_drinking",
      "monitoringBoost": 5.0
    }
  ]
}
```

### File Structure
```
backend/src/
├── config/
│   └── temporal-calendar.json   # Holiday configuration
├── analysis/
│   └── temporal-intelligence.ts # THIS STORY
└── api/
    └── routes/
        └── analytics.ts         # Temporal analytics API
```

---

## Testing

### Test File Location
- `backend/tests/unit/analysis/temporal-intelligence.test.ts`

### Testing Standards
- Mock Date object for time testing
- Test all time windows
- Test holiday detection

### Story-Specific Testing Requirements
1. Sunday 6-11am returns 3× multiplier
2. Saturday 6-11am returns 2× multiplier
3. Thursday 5-9pm triggers prevention
4. Holiday morning returns 5× multiplier
5. 2 days before holiday triggers prevention
6. Time-of-day preferences set correctly
7. Late night sets empathetic tone

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record
*To be filled by Dev Agent*

---

## QA Results

### Review Date: 2025-12-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Temporal logic is clear. Calendar configuration separation is good practice.

### Improvements Checklist

- [ ] **Timezone Handling:** Ensure `getTemporalContext` uses the correct timezone (Server vs User vs Target Audience). Currently assumes Server Time. If target audience is global, this might need refinement (e.g., UTC or derived from post location if available).

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Gate Status

Gate: PASS → docs/qa/gates/2.9-temporal-intelligence.yml

### Recommended Status

[✓ Ready for Implementation]

