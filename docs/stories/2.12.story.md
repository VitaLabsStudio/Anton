# Story 2.12: Competitive Intelligence Detector

## Status: Draft

## Story

**As a** the decision engine,  
**I want** to detect mentions of competing products in posts and trigger defensive positioning strategies,  
**so that** Antone educates users about Vita's unique value proposition when competitors are discussed.

## Acceptance Criteria

1. Module created at `@backend/analysis/competitive-detector.ts`
2. **Competitor Product Library** seeded in `competitors` database table (also available at `@backend/data/competitors.json`):
   - Rehydration brands: LiquidIV, Drip Drop, Pedialyte, Gatorade, Nuun
   - Hangover pills: ZBiotics, Flyby, AfterDrink, Cheers, DHM Detox
   - IV therapy: The I.V. Doc, Revive, HydroMed
   - Home remedies tracked: "hair of the dog", activated charcoal, pickle juice
3. Competitor detection in post text using fuzzy matching (handles typos, variations)
4. **Competitive Context Analysis**:
   - Positive mention: "LiquidIV works great for me" → Soft positioning
   - Question: "Does Drip Drop actually work?" → Educational comparison
   - Negative mention: "ZBiotics didn't help" → Strong positioning opportunity
5. **Defensive Positioning Strategy**:
   - Tone: Polite, educational (never attack competitors)
   - Message template: "Those work via [mechanism]; Vita uses transdermal delivery which bypasses upset stomach"
   - Differentiation focus: Transdermal vs oral, convenience, science-backed
6. Competitive posts flagged in decision: `{competitor_detected: "LiquidIV", positioning_opportunity: "high"}`
7. Mode adjustment: Competitive posts trigger **Hybrid** or **Helpful** mode (never pure Engagement)
8. Preferred archetype: **Problem-Solution Direct** or **Credibility-anchor**
9. Rate limiting: Max 5 competitive replies per day per competitor (avoid appearing obsessive)
10. Dashboard tracking: Competitor share of voice, Vita mention rate, competitive conversion opportunities
11. Unit tests validate competitor detection across 50+ mention variations
12. Market intelligence logged: Which competitors are most discussed? What complaints?

---

## Tasks / Subtasks

- [ ] **Task 1: Create Competitors Configuration** (AC: 2)
  - [ ] Create `backend/src/data/competitors.json`
  - [ ] Add all rehydration brands
  - [ ] Add all hangover pill brands
  - [ ] Add IV therapy services
  - [ ] Add home remedies
  - [ ] Include brand keywords and variations

- [ ] **Task 2: Seed Competitors Database** (AC: 2)
  - [ ] Create seed script for competitors table
  - [ ] Populate from competitors.json
  - [ ] Include category, mechanism, price point
  - [ ] Run seed on database initialization

- [ ] **Task 3: Create Competitive Detector Module** (AC: 1, 3)
  - [ ] Create `backend/src/analysis/competitive-detector.ts`
  - [ ] Implement detectCompetitor(content) function
  - [ ] Fuzzy matching for brand names
  - [ ] Handle typos and variations
  - [ ] Return competitor name and confidence

- [ ] **Task 4: Implement Context Analysis** (AC: 4)
  - [ ] Detect positive mentions (sentiment analysis)
  - [ ] Detect questions about competitors
  - [ ] Detect negative mentions (complaints)
  - [ ] Return positioning opportunity score

- [ ] **Task 5: Implement Mode Adjustment** (AC: 7)
  - [ ] Competitive posts → HYBRID or HELPFUL
  - [ ] Never use ENGAGEMENT for competitive posts
  - [ ] Integrate with decision engine

- [ ] **Task 6: Implement Archetype Preference** (AC: 8)
  - [ ] Prefer PROBLEM_SOLUTION_DIRECT
  - [ ] Or CREDIBILITY_ANCHOR
  - [ ] Integrate with archetype selector

- [ ] **Task 7: Implement Rate Limiting** (AC: 9)
  - [ ] Track competitive replies per competitor per day
  - [ ] Max 5 per competitor
  - [ ] Store in Redis with daily reset

- [ ] **Task 8: Create Market Intelligence Logging** (AC: 12)
  - [ ] Log all competitor mentions
  - [ ] Save to competitive_mentions table
  - [ ] Track sentiment and satisfaction
  - [ ] Track positioning opportunities

- [ ] **Task 9: Create Dashboard API** (AC: 10)
  - [ ] Endpoint GET /api/competitive/mentions
  - [ ] Return competitor share of voice
  - [ ] Return sentiment breakdown
  - [ ] Return conversion opportunities

- [ ] **Task 10: Write Unit Tests** (AC: 11)
  - [ ] Test 50+ competitor mention variations
  - [ ] Test fuzzy matching
  - [ ] Test sentiment detection
  - [ ] Test rate limiting

---

## Dev Notes

### Previous Story Insights
- Story 1.3 complete (competitors and competitive_mentions tables)
- Story 2.5 complete (decision engine integration)

### Competitive Detector Implementation
```typescript
// backend/src/analysis/competitive-detector.ts

import { prisma } from '../db';
import { logger } from '../utils/logger';
import competitors from '../data/competitors.json';

interface CompetitorResult {
  detected: boolean;
  name: string | null;
  category: string | null;
  sentiment: 'POSITIVE' | 'NEUTRAL' | 'NEGATIVE';
  satisfaction: 'SATISFIED' | 'UNSATISFIED' | 'QUESTIONING';
  opportunityScore: number; // 0-1, higher = better opportunity
  confidence: number;
}

export async function detectCompetitor(content: string): Promise<CompetitorResult> {
  const lowerContent = content.toLowerCase();

  // Check each competitor
  for (const competitor of competitors.competitors) {
    for (const keyword of competitor.brandKeywords) {
      if (fuzzyMatch(lowerContent, keyword.toLowerCase())) {
        // Competitor detected
        const sentiment = analyzeSentiment(content, keyword);
        const satisfaction = analyzeSatisfaction(content);
        const opportunity = calculateOpportunity(sentiment, satisfaction);

        logger.info('Competitor detected', {
          competitor: competitor.name,
          category: competitor.category,
          sentiment,
          satisfaction,
          opportunity,
        });

        return {
          detected: true,
          name: competitor.name,
          category: competitor.category,
          sentiment,
          satisfaction,
          opportunityScore: opportunity,
          confidence: 0.90,
        };
      }
    }
  }

  // No competitor detected
  return {
    detected: false,
    name: null,
    category: null,
    sentiment: 'NEUTRAL',
    satisfaction: 'SATISFIED',
    opportunityScore: 0,
    confidence: 1.0,
  };
}

function fuzzyMatch(text: string, keyword: string): boolean {
  // Handle variations: "liquid iv", "liquidiv", "liquid-iv"
  const normalized = keyword.replace(/[\s-]/g, '');
  const pattern = new RegExp(normalized, 'i');
  const textNormalized = text.replace(/[\s-]/g, '');
  return pattern.test(textNormalized);
}

function analyzeSentiment(content: string, brand: string): 'POSITIVE' | 'NEUTRAL' | 'NEGATIVE' {
  // Positive indicators
  const positive = /(works?|great|love|amazing|best|helped|recommend)/i;
  if (positive.test(content)) {
    return 'POSITIVE';
  }

  // Negative indicators
  const negative = /(didn't work|useless|waste|scam|disappointed|failed)/i;
  if (negative.test(content)) {
    return 'NEGATIVE';
  }

  return 'NEUTRAL';
}

function analyzeSatisfaction(content: string): 'SATISFIED' | 'UNSATISFIED' | 'QUESTIONING' {
  // Questioning
  if (/\?/.test(content) && /(does|is|will|should|work)/i.test(content)) {
    return 'QUESTIONING';
  }

  // Unsatisfied
  if (/(didn't help|still feel|not working|waste of money)/i.test(content)) {
    return 'UNSATISFIED';
  }

  // Satisfied
  if (/(worked|helped|feel better|recommend)/i.test(content)) {
    return 'SATISFIED';
  }

  return 'QUESTIONING';
}

function calculateOpportunity(
  sentiment: string,
  satisfaction: string
): number {
  // Higher score = better positioning opportunity
  if (satisfaction === 'UNSATISFIED') return 0.9;
  if (satisfaction === 'QUESTIONING') return 0.7;
  if (sentiment === 'NEGATIVE') return 0.8;
  if (sentiment === 'NEUTRAL') return 0.5;
  if (sentiment === 'POSITIVE') return 0.3; // Soft positioning only
  return 0.5;
}

// Save competitive mention
export async function saveCompetitiveMention(
  postId: string,
  result: CompetitorResult
): Promise<void> {
  if (!result.detected) return;

  const competitor = await prisma.competitor.findFirst({
    where: { name: result.name! },
  });

  if (!competitor) {
    logger.warn('Competitor not in database', { name: result.name });
    return;
  }

  await prisma.competitiveMention.create({
    data: {
      postId,
      competitorId: competitor.id,
      sentiment: result.sentiment,
      satisfaction: result.satisfaction,
      opportunityScore: result.opportunityScore,
      replied: false,
    },
  });
}
```

### Competitors Configuration
```json
// backend/src/data/competitors.json
{
  "version": "1.0",
  "competitors": [
    {
      "name": "LiquidIV",
      "category": "REHYDRATION",
      "primaryMechanism": "Oral electrolyte drink mix",
      "pricePoint": "MID",
      "brandKeywords": ["liquid iv", "liquidiv", "liquid-iv"]
    },
    {
      "name": "Drip Drop",
      "category": "REHYDRATION",
      "primaryMechanism": "Medical-grade oral rehydration",
      "pricePoint": "MID",
      "brandKeywords": ["drip drop", "dripdrop", "drip-drop"]
    },
    {
      "name": "Pedialyte",
      "category": "REHYDRATION",
      "primaryMechanism": "Pediatric electrolyte solution",
      "pricePoint": "LOW",
      "brandKeywords": ["pedialyte"]
    },
    {
      "name": "ZBiotics",
      "category": "HANGOVER_PILLS",
      "primaryMechanism": "Probiotic enzyme pre-drinking",
      "pricePoint": "HIGH",
      "brandKeywords": ["zbiotics", "z-biotics"]
    },
    {
      "name": "Flyby",
      "category": "HANGOVER_PILLS",
      "primaryMechanism": "Vitamin/herb capsules",
      "pricePoint": "MID",
      "brandKeywords": ["flyby", "flyby hangover"]
    },
    {
      "name": "AfterDrink",
      "category": "HANGOVER_PILLS",
      "primaryMechanism": "DHM supplement",
      "pricePoint": "MID",
      "brandKeywords": ["afterdrink", "after drink"]
    }
  ]
}
```

### Defensive Positioning Template
[Source: epic-2]

```
Those work via [mechanism]; Vita uses transdermal delivery which bypasses your upset stomach and doesn't require water when you're nauseous. Worth checking out if oral solutions aren't helping.

—Antone (Vita) | Helped 1,247 people this month
https://vita.com?utm_source=antone&utm_content=reply_abc123
```

### File Structure
```
backend/src/
├── data/
│   └── competitors.json         # Competitor database
├── analysis/
│   └── competitive-detector.ts  # THIS STORY
└── api/
    └── routes/
        └── competitive.ts       # Competitive intelligence API
```

---

## Testing

### Test File Location
- `backend/tests/unit/analysis/competitive-detector.test.ts`

### Testing Standards
- Test fuzzy matching variations
- Test sentiment analysis
- Test opportunity scoring

### Story-Specific Testing Requirements
1. 50+ brand variations detected
2. Fuzzy matching handles typos
3. Sentiment classified correctly
4. Satisfaction classified correctly
5. Opportunity score calculated correctly
6. Rate limiting prevents spam (max 5/day)
7. Competitive mentions saved to database

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record
*To be filled by Dev Agent*

---

## QA Results

### Review Date: 2025-12-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Competitive detection and defensive strategy are well defined.

### Improvements Checklist

- [ ] **Rate Limit Behavior:** If rate limit (5/day) is reached, ensure `opportunityScore` is set to 0 to prevent the Decision Engine from triggering a competitive response, or handle this explicitly in the Decision Engine.
- [ ] **Fuzzy Matching Performance:** Regex for every competitor keyword might be slow if list grows. For now (small list), it's fine.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Gate Status

Gate: PASS → docs/qa/gates/2.12-competitive-detector.yml

### Recommended Status

[✓ Ready for Implementation]

