# Story 1.8: Health Check & Monitoring Endpoint

## Status: Draft

## Story

**As a** SRE/operator,  
**I want** a low-overhead, cached health check endpoint that validates system components and data pipeline integrity,  
**so that** I can monitor status without degrading system performance or exposing sensitive info to the public.

## Acceptance Criteria

1. **Endpoints**:
   - `GET /health`: Public. Returns JSON `{ "status": "ok" }`. Fast (<10ms).
   - `GET /health/detailed`: Protected (Auth Required + IP Whitelist). Returns full component status.
2. **Performance (PERF-001)**:
   - Detailed checks are **decoupled from requests**.
   - `HealthCheckService` runs checks in background (every 60s).
   - Endpoint serves cached result.
3. **Security (SEC-001)**:
   - Detailed endpoint requires valid **Authentication**.
   - Detailed endpoint implements **IP Whitelisting** (allow internal monitoring IPs only).
   - No sensitive info (DB connection strings, etc.) in response.
4. **Worker Health (TECH-001)**:
   - Uses "Heartbeat" logic: Checks if `posts_processed_count` > 0 in last X minutes, not just process existence.
5. **Pipeline Health (TECH-002)**:
   - Checks **Data Pipeline Integrity** (e.g., "Rows added to `posts` table in last hour?").
   - **NO** complex ML training metrics (accuracy/volatility) in this endpoint.
6. **Component Checks**:
   - Database (latency).
   - Twitter/Reddit/Threads (Auth validity).
   - Worker (Heartbeat/Queue depth).

---

## Tasks / Subtasks

- [ ] **Task 1: Create Health Check Service (Cached)** (AC: 2)
  - [ ] Create `backend/src/services/health-check.ts`.
  - [ ] Implement `HealthCheckService` with `setInterval` (60s) for background refreshes.
  - [ ] Implement `getHealth()` that returns cached `lastResult`.
  - [ ] Handle first-run (await check if cache empty).

- [ ] **Task 2: Implement Component Checks** (AC: 6)
  - [ ] **Database**: Simple `SELECT 1` latency check.
  - [ ] **Platforms**: Verify credentials (Twitter, Reddit, Threads).
  - [ ] **Worker**: Check `worker_heartbeats` table (or Redis) for recent activity.
  - [ ] **Pipeline**: Check `prisma.post.count` > prev_count (or checks for recent created_at).

- [ ] **Task 3: Create Public Endpoint** (AC: 1)
  - [ ] Create `backend/src/api/routes/health.ts`.
  - [ ] `GET /health` -> 200 OK `{ status: 'ok' }`.

- [ ] **Task 4: Create Detailed Endpoint (Protected)** (AC: 1, 3)
  - [ ] `GET /health/detailed` -> `authMiddleware`.
  - [ ] **Add IP Whitelist Middleware**: Rejects requests from non-whitelisted IPs (configurable via ENV).
  - [ ] Return cached detailed JSON.
  - [ ] Ensure 503 status if overall health is 'unhealthy'.

- [ ] **Task 5: Instrument Worker for Heartbeat** (AC: 4)
  - [ ] Update `stream-monitor.ts` to update a heartbeat timestamp/counter in DB/Redis on every batch.

- [ ] **Task 6: Unit Tests**
  - [ ] Test caching logic (ensure checks don't run on every call).
  - [ ] Test Auth protection and IP Whitelisting on detailed endpoint.

---

## Dev Notes

### Risk Mitigation Strategies
[Source: QA Risk Assessment 1.8-risk-20251202.md]

#### HIGH RISK: System Degradation from Live Checks (PERF-001)
**Solution**: **Background Refresh / Caching Pattern**.
```typescript
export class HealthCheckService {
  private lastResult: HealthCheckResult | null = null;
  constructor() {
    setInterval(() => this.runChecks(), 60000); // 60s cache
  }
  async getHealth() { return this.lastResult || await this.runChecks(); }
}
```

#### HIGH RISK: Information Leakage (SEC-001)
**Solution**: strict separation.
- Public: `status: ok` only.
- Detailed: Behind Auth + IP Whitelist.

#### HIGH RISK: False Negative Worker Health (TECH-001)
**Solution**: Heartbeat with Activity.
Worker must report: "I processed 5 items at 10:00am".
Health check: "If time is 10:15am and last activity was 10:00am -> Unhealthy".

#### HIGH RISK: Over-Complex Learning Metrics (TECH-002)
**Solution**: Simplify. Check **Data Pipeline Integrity** only.
- Are new posts being saved?
- Are learning events being logged?
(Save complex ML analysis for offline dashboards).

---

## QA Results
*To be filled by QA Agent*
