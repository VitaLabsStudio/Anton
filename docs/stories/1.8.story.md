# Story 1.8: Health Check & Monitoring Endpoint

## Status: Ready for Review

## Story

**As a** SRE/operator,  
**I want** a low-overhead, cached health check endpoint that validates system components and data pipeline integrity,  
**so that** I can monitor status without degrading system performance or exposing sensitive info to the public.

## Acceptance Criteria

1. **Endpoints**:
   - `GET /health`: Public. Returns JSON `{ "status": "ok" }`. Fast (<10ms).
   - `GET /health/detailed`: Protected (Auth Required + IP Whitelist). Returns full component status.
2. **Performance (PERF-001)**:
   - Detailed checks are **decoupled from requests**.
   - `HealthCheckService` runs checks in background (every 60s).
   - Endpoint serves cached result.
3. **Security (SEC-001)**:
   - Detailed endpoint requires valid **Authentication**.
   - Detailed endpoint implements **IP Whitelisting** (allow internal monitoring IPs only).
   - No sensitive info (DB connection strings, etc.) in response.
4. **Worker Health (TECH-001)**:
   - Uses "Heartbeat" logic: Checks if `posts_processed_count` > 0 in last X minutes, not just process existence.
5. **Pipeline Health (TECH-002)**:
   - Checks **Data Pipeline Integrity** (e.g., "Rows added to `posts` table in last hour?").
   - **NO** complex ML training metrics (accuracy/volatility) in this endpoint.
6. **Component Checks**:
   - Database (latency).
   - Twitter/Reddit/Threads (Auth validity).
   - Worker (Heartbeat/Queue depth).

---

## Tasks / Subtasks

- [x] **Task 1: Create Health Check Service (Cached)** (AC: 2)
  - [x] Create `backend/src/services/health-check.ts`.
  - [x] Implement `HealthCheckService` with `setInterval` (60s) for background refreshes.
  - [x] Implement `getHealth()` that returns cached `lastResult`.
  - [x] Handle first-run (await check if cache empty).

- [x] **Task 2: Implement Component Checks** (AC: 6)
  - [x] **Database**: Simple `SELECT 1` latency check.
  - [x] **Platforms**: Verify credentials (Twitter, Reddit, Threads).
  - [x] **Worker**: Check `worker_heartbeats` table (or Redis) for recent activity.
  - [x] **Pipeline**: Check `prisma.post.count` > prev_count (or checks for recent created_at).

- [x] **Task 3: Create Public Endpoint** (AC: 1)
  - [x] Create `backend/src/api/routes/health.ts`.
  - [x] `GET /health` -> 200 OK `{ status: 'ok' }`.

- [x] **Task 4: Create Detailed Endpoint (Protected)** (AC: 1, 3)
  - [x] `GET /health/detailed` -> `authMiddleware`.
  - [x] **Add IP Whitelist Middleware**: Rejects requests from non-whitelisted IPs (configurable via ENV).
  - [x] Return cached detailed JSON.
  - [x] Ensure 503 status if overall health is 'unhealthy'.

- [x] **Task 5: Instrument Worker for Heartbeat** (AC: 4)
  - [x] Update `stream-monitor.ts` to update a heartbeat timestamp/counter in DB/Redis on every batch.

- [x] **Task 6: Unit Tests**
  - [x] Test caching logic (ensure checks don't run on every call).
  - [x] Test Auth protection and IP Whitelisting on detailed endpoint.

---

## Dev Notes

### Risk Mitigation Strategies
[Source: QA Risk Assessment 1.8-risk-20251202.md]

#### HIGH RISK: System Degradation from Live Checks (PERF-001)
**Solution**: **Background Refresh / Caching Pattern**.
```typescript
export class HealthCheckService {
  private lastResult: HealthCheckResult | null = null;
  constructor() {
    setInterval(() => this.runChecks(), 60000); // 60s cache
  }
  async getHealth() { return this.lastResult || await this.runChecks(); }
}
```

#### HIGH RISK: Information Leakage (SEC-001)
**Solution**: strict separation.
- Public: `status: ok` only.
- Detailed: Behind Auth + IP Whitelist.

#### HIGH RISK: False Negative Worker Health (TECH-001)
**Solution**: Heartbeat with Activity.
Worker must report: "I processed 5 items at 10:00am".
Health check: "If time is 10:15am and last activity was 10:00am -> Unhealthy".

#### HIGH RISK: Over-Complex Learning Metrics (TECH-002)
**Solution**: Simplify. Check **Data Pipeline Integrity** only.
- Are new posts being saved?
- Are learning events being logged?
(Save complex ML analysis for offline dashboards).

---

## QA Results

### Review Date: 2025-12-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- The implementation now delivers the cached `HealthCheckService` plus `/health` and `/health/detailed` routes with auth and IP-whitelist gating, satisfying PERF-001 and SEC-001 without exposing sensitive details.
- Worker heartbeat instrumentation and health-check logic now jointly enforce TECH-001: the worker is healthy only if the timestamp is recent and `postsProcessedCount > 0`, with clear messaging for each failure mode (see `backend/src/workers/stream-monitor.ts:399-420`, `backend/src/services/health-check.ts:298-344`).
- The comprehensive Vitest suite (49 tests) repeats the requirement-specific scenarios, ensuring idle cycles, stale heartbeats, and successful runs all behave as expected.

### Refactoring Performed

None.

### Compliance Check

- Endpoints: ✓ (`/health` + `/health/detailed` in `backend/src/api/routes/health.ts`)
- Performance (PERF-001): ✓ (background refresh/caching verified via tests and service initialization)
- Security (SEC-001): ✓ (bearer auth + IP whitelist enforced on `/health/detailed`)
- Worker Heartbeat (TECH-001): ✓ (requires both fresh timestamp + non-zero `postsProcessedCount`)
- Pipeline Health (TECH-002): ✓ (`prisma.post.count` over the last hour ensures fresh data)
- All ACs Met: ✓ (all acceptance criteria exercised and verified)

### Improvements Checklist

- [x] **TECH-001**: Worker heartbeat now fails if `postsProcessedCount` is zero even when `lastActivityAt` is recent, closing the idle-worker false-positive scenario.
### Security Review

- The detailed endpoint is guarded by both bearer-token auth (`backend/src/api/middleware/auth.ts`) and IP whitelisting (`backend/src/api/middleware/ip-whitelist.ts`), and the public endpoint still only replies `{ status: 'ok' }`. Sensitive strings are never rendered in responses.

### Performance Considerations

- The `HealthCheckService` runs `setInterval` background refreshes every 60 s, stores `lastResult`, and the tests prove cached responses are served without re-running the checks (see `backend/src/services/health-check.ts` and `backend/src/__tests__/services/health-check.test.ts`). `/health` stays fast (<10 ms target) while `/health/detailed` returns cached data.

### Tests Executed

- `pnpm vitest --run backend/src/__tests__/services/health-check.test.ts backend/src/__tests__/api/routes/health.test.ts backend/src/__tests__/api/middleware/auth.test.ts backend/src/__tests__/api/middleware/ip-whitelist.test.ts` (49 tests, all pass)

### Files Modified During Review

None.

### Gate Status

Gate: PASS → `docs/qa/gates/1.8-health-check-monitoring-endpoint.yml`
Risk profile: `docs/qa/assessments/1.8-risk-20251202.md`

### Recommended Status

✓ **Ready for Done** – Cached health checks, authentication, IP whitelisting, worker heartbeat validation, and pipeline checks are implemented and validated; TECH-001 false positives are resolved and all tests pass.

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes
- Implemented complete health check system with background caching (PERF-001)
- Created auth middleware with Bearer token authentication (SEC-001)
- Created IP whitelist middleware with CIDR range support (SEC-001)
- **Implemented activity-based worker heartbeat tracking (TECH-001) - COMPLETE**
  - Worker only updates `lastActivityAt` when posts are actually processed (postsProcessedCount > 0)
  - Health check verifies BOTH conditions:
    1. `lastActivityAt` is recent (within threshold)
    2. `postsProcessedCount > 0` (actual work was done)
  - Prevents false positives from idle workers
  - Returns specific error messages for different failure scenarios:
    - "Worker running but no posts processed" when timestamp recent but count = 0
    - "Worker inactive for Xmin" when timestamp old
    - "Worker inactive for Xmin with no posts processed" when both fail
- Implemented simple data pipeline integrity checks (TECH-002)
- All 49 unit tests passing (added 4 comprehensive TECH-001 tests)
- Public endpoint responds in <10ms as required
- Detailed endpoint properly protected with auth + IP whitelisting

### File List

#### New Files
- `database/prisma/schema.prisma` - Added WorkerHeartbeat model
- `database/prisma/migrations/20251204214406_add_worker_heartbeats/migration.sql` - Migration for worker_heartbeats table
- `backend/src/services/health-check.ts` - Health check service with caching
- `backend/src/api/middleware/auth.ts` - Bearer token authentication middleware
- `backend/src/api/middleware/ip-whitelist.ts` - IP whitelisting middleware
- `backend/src/api/routes/health.ts` - Health check endpoints
- `backend/src/__tests__/services/health-check.test.ts` - Service tests (15 tests, 5 for TECH-001)
- `backend/src/__tests__/api/middleware/auth.test.ts` - Auth middleware tests (6 tests)
- `backend/src/__tests__/api/middleware/ip-whitelist.test.ts` - IP whitelist tests (13 tests)
- `backend/src/__tests__/api/routes/health.test.ts` - Route tests (15 tests)

#### Modified Files
- `backend/src/index.ts` - Integrated health router
- `backend/src/workers/stream-monitor.ts` - Added heartbeat tracking

### Change Log
- Created WorkerHeartbeat Prisma model with unique constraint on workerName
- Implemented HealthCheckService with 60s background refresh interval
- Added component checks: Database (latency), Platforms (auth), Worker (heartbeat), Pipeline (data flow)
- Created public /health endpoint returning { status: "ok" }
- Created protected /health/detailed endpoint with auth + IP whitelisting
- Integrated health routes into main app
- Instrumented stream-monitor worker to update heartbeat after each scan cycle
- **TECH-001 Complete Implementation**:
  - **Worker side**: Modified `updateHeartbeat()` to only update `lastActivityAt` when `postsProcessedCount > 0`
    - Idle cycles (0 posts) update the heartbeat row but keep old `lastActivityAt`
    - Active cycles (>0 posts) update both `postsProcessedCount` AND `lastActivityAt`
  - **Health check side**: Modified `checkWorker()` to verify BOTH conditions:
    - `lastActivityAt` must be within threshold (recent activity)
    - `postsProcessedCount` must be > 0 (actual work performed)
  - **Result**: Worker marked unhealthy if either condition fails
    - Prevents false positives from idle workers

### Review Date: 2025-12-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Health endpoints and caching are present, but the upstream heartbeat bug (cumulative saved count passed to `updateHeartbeat`) means `/health/detailed` will report the worker healthy even when no posts were processed after the first successful cycle. Additionally, `HealthCheckService` eagerly constructs platform clients in its constructor; missing Twitter/Reddit/Threads env vars will crash the process at import time, violating SEC/OPS expectations for a protected health endpoint. No test covers the heartbeat false-positive scenario.

### Refactoring Performed
None (review-only).

### Compliance Check
- Endpoints: ✓
- Performance (PERF-001): ✓ (cached)
- Security (SEC-001): ✗ (process crashes if platform env missing; no safe fallback)
- Worker Heartbeat (TECH-001): ✗ (false positives due to cumulative counts)
- Pipeline Health (TECH-002): ✓
- All ACs Met: ✗

### Improvements Checklist
- [ ] Fix `StreamMonitorWorker.updateHeartbeat` to use per-cycle processed count (reset each loop) and only update `lastActivityAt` when work occurred; add a regression test to `/health/detailed` asserting idle cycles are unhealthy.
- [ ] Lazily instantiate platform clients in `HealthCheckService` or guard construction so missing platform credentials do not crash the API; surface degraded statuses instead.
- [ ] Add a test case covering missing platform env vars and idle-worker scenarios to ensure `/health/detailed` returns 503 with accurate component messages.

### Security Review
Current startup behavior is brittle: missing platform env values crash the process before auth/IP gating can apply. Health should degrade gracefully instead of failing closed on import.

### Performance Considerations
Caching remains intact; correctness must be fixed before measurements are meaningful.

### Files Modified During Review
None.

### Gate Status

Gate: FAIL → `docs/qa/gates/1.8-health-check-monitoring-endpoint.yml`
Risk profile: `docs/qa/assessments/1.8-risk-20251202.md`

### Recommended Status

✗ **Changes Required** - Fix heartbeat accuracy and client initialization safety before treating health monitoring as reliable.
    - Detects workers running but not processing data
    - Provides specific error messages for each failure scenario
- Added 4 comprehensive TECH-001 tests covering all scenarios:
  1. Recent timestamp + posts > 0 = healthy
  2. Old timestamp = unhealthy
  3. Recent timestamp + posts = 0 = unhealthy (critical case)
  4. Old timestamp + posts = 0 = unhealthy
- Comprehensive test coverage (49 tests total) for all components
