# Story 2.8: Decision Audit & Logging

## Status: Draft

## Story

**As a** product manager,  
**I want** complete audit trails of all decisions with signal breakdowns,  
**so that** I can analyze bot behavior, debug incorrect decisions, and support learning improvements.

## Acceptance Criteria

1. All decisions stored in `decisions` table with JSON columns for signal details:
   - `signals_json`: {sss: 0.87, ars: 0.45, evs: 2.3, trs: 0.92}
   - `mode`: "helpful" | "engagement" | "hybrid" | "disengaged"
   - `safety_flags`: ["none"] or ["death_mention"]
2. **Structured logging** (Pino) for all decision steps:
   - Format: JSON with level, timestamp, service, version
   - Request tracing: All logs include unique `request_id` propagated through all services
   - Log levels: DEBUG (dev only), INFO (normal), WARN (safety triggers), ERROR (failures)
   - Redaction: API keys, tokens, user PII automatically redacted
   - Transport: stdout for Docker capture with rotation
3. Log levels: INFO (decision made), WARN (safety trigger), ERROR (processing failure)
4. Dashboard endpoint `/api/decisions/:id` returns full decision detail including post text
5. Decision retention: 90 days in database, then archived to volume storage
6. Searchable by platform, mode, date range, author
7. Sample queries: "Show all decisions with SSS > 0.9 that selected Disengaged mode" (for debugging)

---

## Tasks / Subtasks

- [ ] **Task 1: Enhance Logger Configuration** (AC: 2)
  - [ ] Update `backend/src/utils/logger.ts`
  - [ ] Add request_id propagation
  - [ ] Configure redaction for sensitive fields
  - [ ] Add service and version to base context
  - [ ] Configure transport (pino-pretty for dev, JSON for prod)

- [ ] **Task 2: Add Decision Logging** (AC: 3)
  - [ ] Log at INFO level when decision made
  - [ ] Include all signal scores in log
  - [ ] Log mode and archetype selection
  - [ ] Log segment used for weights

- [ ] **Task 3: Add Safety Logging** (AC: 3)
  - [ ] Log at WARN level when safety triggered
  - [ ] Include safety flags and reasoning
  - [ ] Include post excerpt (first 100 chars)

- [ ] **Task 4: Create Decision Detail API** (AC: 4)
  - [ ] Enhance `backend/src/api/routes/decisions.ts`
  - [ ] Implement GET /api/decisions/:id
  - [ ] Include post content
  - [ ] Include author info
  - [ ] Include full signal breakdown

- [ ] **Task 5: Implement Search Filters** (AC: 6, 7)
  - [ ] Add query params to GET /api/decisions
  - [ ] Filter by platform
  - [ ] Filter by mode
  - [ ] Filter by date range
  - [ ] Filter by author
  - [ ] Support complex queries (SSS > 0.9 AND mode = DISENGAGED)

- [ ] **Task 6: Implement Data Archiving** (AC: 5)
  - [ ] Create `scripts/archive-decisions.ts`
  - [ ] Query decisions older than 90 days
  - [ ] Export to compressed JSON
  - [ ] Delete from active database
  - [ ] Schedule with cron (monthly)

- [ ] **Task 7: Write Unit Tests**
  - [ ] Test logger redaction
  - [ ] Test decision API filters
  - [ ] Test archiving logic

---

## Dev Notes

### Previous Story Insights
- Story 1.1 complete (Pino logger configured)
- Story 2.5 complete (decisions table structure)

### Structured Logging Configuration
[Source: architecture.md#12-observability-monitoring]

```typescript
// backend/src/utils/logger.ts

import pino from 'pino';

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: process.env.NODE_ENV === 'development'
    ? { target: 'pino-pretty' }
    : undefined,
  formatters: {
    level: (label) => ({ level: label }),
  },
  base: {
    service: 'antone',
    version: process.env.npm_package_version || '1.0.0',
  },
  redact: [
    'req.headers.authorization',
    'password',
    'apiKey',
    'accessToken',
    'refreshToken',
    'TWITTER_API_KEY',
    'TWITTER_API_SECRET',
    'REDDIT_CLIENT_SECRET',
    'DEEPSEEK_API_KEY',
  ],
});

// Request ID middleware
export function requestIdMiddleware(req: any, res: any, next: any): void {
  const requestId = req.headers['x-request-id'] || crypto.randomUUID();
  req.requestId = requestId;
  req.log = logger.child({ requestId });
  next();
}
```

### Decision Logging Examples
```typescript
// INFO level - decision made
logger.info('Decision created', {
  postId: 'post-123',
  mode: 'HELPFUL',
  compositeScore: 0.87,
  sssScore: 0.92,
  arsScore: 0.65,
  evsScore: 1.2,
  trsScore: 1.0,
  segmentUsed: 'TWITTER_MORNING',
});

// WARN level - safety triggered
logger.warn('Safety protocol triggered', {
  postId: 'post-456',
  flags: ['DEATH_HARM'],
  distressProbability: 0.85,
  content: 'I want to die from this hangover',
});

// ERROR level - processing failed
logger.error('Decision engine failed', {
  postId: 'post-789',
  error: error.message,
  stack: error.stack,
  attemptNumber: 2,
});
```

### Decisions API Endpoints
```typescript
// backend/src/api/routes/decisions.ts

import { Hono } from 'hono';
import { prisma } from '../../db';
import { authMiddleware } from '../middleware/auth';

const decisions = new Hono();

// Get all decisions with filters
decisions.get('/', authMiddleware, async (c) => {
  const platform = c.req.query('platform');
  const mode = c.req.query('mode');
  const startDate = c.req.query('startDate');
  const endDate = c.req.query('endDate');
  const limit = parseInt(c.req.query('limit') || '50');

  const where: any = {};
  if (platform) where.post = { platform };
  if (mode) where.mode = mode;
  if (startDate || endDate) {
    where.createdAt = {};
    if (startDate) where.createdAt.gte = new Date(startDate);
    if (endDate) where.createdAt.lte = new Date(endDate);
  }

  const results = await prisma.decision.findMany({
    where,
    include: {
      post: {
        include: { author: true },
      },
    },
    orderBy: { createdAt: 'desc' },
    take: limit,
  });

  return c.json({ decisions: results, count: results.length });
});

// Get single decision detail
decisions.get('/:id', authMiddleware, async (c) => {
  const id = c.req.param('id');

  const decision = await prisma.decision.findUnique({
    where: { id },
    include: {
      post: {
        include: { author: true },
      },
      replies: true,
    },
  });

  if (!decision) {
    return c.json({ error: 'Decision not found' }, 404);
  }

  return c.json({ decision });
});

export { decisions };
```

### File Structure
```
backend/src/
├── utils/
│   └── logger.ts                # Enhanced with redaction
├── api/
│   └── routes/
│       └── decisions.ts         # Decision APIs
└── scripts/
    └── archive-decisions.ts     # Archiving script
```

---

## Testing

### Test File Location
- `backend/tests/unit/utils/logger.test.ts`
- `backend/tests/integration/api/decisions.test.ts`

### Testing Standards
- Test logger redaction
- Test API filters
- Mock database queries

### Story-Specific Testing Requirements
1. Logger redacts sensitive fields
2. Request ID propagates through calls
3. Decision API filters work correctly
4. Decision detail includes all context
5. Archiving moves old decisions
6. Complex queries work (SSS > 0.9 AND mode = DISENGAGED)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record
*To be filled by Dev Agent*

---

## QA Results

### Review Date: 2025-12-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Comprehensive logging and auditing plan.

### Improvements Checklist

- [ ] **GDPR/Privacy:** Ensure archiving script (`scripts/archive-decisions.ts`) respects any data deletion requests (if applicable).

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Gate Status

Gate: PASS → docs/qa/gates/2.8-decision-audit.yml

### Recommended Status

[✓ Ready for Implementation]

