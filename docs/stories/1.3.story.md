# Story 1.3: PostgreSQL Database Schema & Migrations

## Status: Draft

## Story

**As a** developer,  
**I want** a PostgreSQL database schema with Prisma ORM and migration system,  
**so that** Relationship Memory, post queue, audit logs, and advanced learning system data can be persisted reliably.

## Acceptance Criteria

1. Prisma initialized with PostgreSQL provider and schema file
2. Database schema defined for ALL required tables:
   
   **Core Tables:**
   - `authors` (id, platform, platform_id, handle, display_name, follower_count, is_verified, is_power_user, power_tier, archetype_tags, relationship_score, interaction_history, first_seen_at, last_seen_at, created_at, updated_at)
   - `posts` (id, platform, platform_post_id, author_id, content, detected_at, processed_at, keyword_matches, keyword_categories, spam_filtered, raw_metrics, error_count, error_message, created_at, updated_at)
   - `decisions` (id, post_id, sss_score, ars_score, evs_score, trs_score, composite_score, mode, archetype, safety_flags, signals_json, temporal_context, competitor_detected, is_power_user, experiment_id, experiment_variant, is_randomized_experiment, predicted_mode, created_at)
   - `replies` (id, decision_id, content, archetype, platform, platform_post_id, utm_code, help_count, approval_status, approved_by, approved_at, posted_at, metrics_json, deleted_at, delete_reason, reply_type, created_at, updated_at)
   
   **Competitive Intelligence Tables:**
   - `competitors` (id, name, category, primary_mechanism, price_point, brand_keywords, created_at, updated_at)
   - `competitive_mentions` (id, post_id, competitor_id, sentiment, satisfaction, opportunity_score, replied, created_at)
   
   **Community & Advocacy Tables:**
   - `community_champions` (id, author_id, tier, engagement_count, dm_sent_at, dm_response, sample_sent, converted, advocate_status, created_at, updated_at)
   
   **Analytics Tables:**
   - `kpi_metrics` (id, date, platform, metric_type, metric_name, value, created_at)
   
   **Human Oversight Tables:**
   - `escalations` (id, post_id, decision_id, reply_id, reason, priority, status, assigned_to, resolved_by, resolution_notes, created_at, resolved_at)
   
   **Audit & Compliance Tables:**
   - `audit_logs` (id, entity_type, entity_id, action, actor, details_json, created_at)
   
   **Experiments & A/B Testing Tables:**
   - `experiments` (id, name, description, variant_a, variant_b, metric, traffic_split, status, start_date, end_date, results_json, winner, created_at, updated_at)

3. **Advanced Learning System Tables**:
   - `weight_adjustment_logs` (id, date, action, reason, valid_segments, total_segments, sample_sizes, old_weights, new_weights, predicted_improvement, created_at)
   - `learning_events` (id, date, adjustment_type, adjustment, predicted_improvement, baseline_performance, actual_improvement, accuracy, evaluated_at, created_at)
   - `randomized_experiments` (id, decision_id, predicted_mode, actual_mode, predicted_outcome, actual_outcome, created_at)
   - `segmented_weights` (id, segment_type, segment_key, sss_weight, ars_weight, evs_weight, trs_weight, sample_size, performance, updated_at, created_at)

4. Migration created with `prisma migrate dev`
5. Seed script created with sample data for development
6. Prisma Client generated and types available via `@shared/db`
7. Database connection tested with simple query in `/health` endpoint
8. All migrations run successfully on staging environment

9. **Database Indexes and Constraints** created for performance and data integrity:
   
   **Unique Constraints:**
   - `authors`: (platform, platform_id)
   - `posts`: (platform, platform_post_id)
   - `kpi_metrics`: (date, platform, metric_type, metric_name)
   - `segmented_weights`: (segment_type, segment_key)
   - `community_champions`: (author_id)
   
   **Performance Indexes:**
   - `decisions.created_at`, `decisions.experiment_variant`, `decisions.is_randomized_experiment`, `decisions.mode`, `decisions.composite_score`
   - `replies.posted_at`, `replies.approval_status`, `replies.platform + posted_at`
   - `weight_adjustment_logs.date`
   - `authors.is_power_user`, `authors.platform + handle`
   - `posts.processed_at`, `posts.platform + detected_at`
   - `escalations.status + priority`, `escalations.created_at`

10. **Prisma Enums** defined for type safety (Platform, OperationalMode, Archetype, PowerTier, ApprovalStatus, ReplyType, etc.)

11. **Data Validation Schemas** defined using Zod

12. **Database Migration Strategy** established

13. **Data Retention Policy** configuration documented

---

## Tasks / Subtasks

- [ ] **Task 1: Initialize Prisma in Database Package** (AC: 1)
  - [ ] Run `pnpm add prisma @prisma/client` in database package
  - [ ] Run `npx prisma init` to create schema.prisma
  - [ ] Configure PostgreSQL datasource with DATABASE_URL
  - [ ] Configure Prisma client generator

- [ ] **Task 2: Define Prisma Enums** (AC: 10)
  - [ ] Define Platform enum (TWITTER, REDDIT, THREADS)
  - [ ] Define OperationalMode enum (HELPFUL, ENGAGEMENT, HYBRID, DISENGAGED)
  - [ ] Define Archetype enum (8 values)
  - [ ] Define PowerTier enum (MICRO, MACRO, MEGA)
  - [ ] Define ApprovalStatus enum
  - [ ] Define ReplyType enum
  - [ ] Define CompetitorCategory, PricePoint, Sentiment, UserSatisfaction enums
  - [ ] Define ChampionTier, DmResponseStatus, AdvocateStatus enums
  - [ ] Define ExperimentStatus, KpiType enums
  - [ ] Define EscalationReason, EscalationPriority, EscalationStatus enums

- [ ] **Task 3: Define Core Entity Models** (AC: 2)
  - [ ] Create Author model with all fields and indexes
  - [ ] Create Post model with all fields and relations
  - [ ] Create Decision model with all fields and relations
  - [ ] Create Reply model with all fields and relations

- [ ] **Task 4: Define Competitive Intelligence Models** (AC: 2)
  - [ ] Create Competitor model
  - [ ] Create CompetitiveMention model with relations

- [ ] **Task 5: Define Community & Advocacy Models** (AC: 2)
  - [ ] Create CommunityChampion model with author relation

- [ ] **Task 6: Define Experiments & Learning Models** (AC: 2, 3)
  - [ ] Create Experiment model
  - [ ] Create WeightAdjustmentLog model
  - [ ] Create LearningEvent model
  - [ ] Create RandomizedExperiment model
  - [ ] Create SegmentedWeight model

- [ ] **Task 7: Define Analytics & Oversight Models** (AC: 2)
  - [ ] Create KpiMetric model with unique constraint
  - [ ] Create Escalation model with relations
  - [ ] Create AuditLog model

- [ ] **Task 8: Add Indexes and Constraints** (AC: 9)
  - [ ] Add unique constraints per specification
  - [ ] Add performance indexes per specification
  - [ ] Verify index naming conventions

- [ ] **Task 9: Create Initial Migration** (AC: 4)
  - [ ] Run `npx prisma migrate dev --name init`
  - [ ] Verify migration files created
  - [ ] Test migration on local database

- [ ] **Task 10: Create Seed Script** (AC: 5)
  - [ ] Create `database/prisma/seed.ts`
  - [ ] Add sample authors (5 per platform)
  - [ ] Add sample posts with keyword matches
  - [ ] Add sample decisions and replies
  - [ ] Add sample experiments
  - [ ] Configure seed script in package.json

- [ ] **Task 11: Generate Prisma Client** (AC: 6)
  - [ ] Run `npx prisma generate`
  - [ ] Export client from shared package
  - [ ] Create type exports for all models

- [ ] **Task 12: Create Zod Validation Schemas** (AC: 11)
  - [ ] Create `shared/src/schemas/post.ts` with PostContentSchema
  - [ ] Create `shared/src/schemas/reply.ts` with ReplyContentSchema
  - [ ] Create `shared/src/schemas/author.ts` with AuthorSchema
  - [ ] Create score validation schemas (0.0-1.0 range)

- [ ] **Task 13: Test Database Connection** (AC: 7)
  - [ ] Create simple connection test script
  - [ ] Verify Prisma client connects to PostgreSQL
  - [ ] Test basic CRUD operations

- [ ] **Task 14: Document Migration Strategy** (AC: 12, 13)
  - [ ] Document migration workflow in README
  - [ ] Document rollback procedures
  - [ ] Document data retention policies

---

## Dev Notes

### Previous Story Insights
- Story 1.1 must be complete (monorepo structure)
- Story 1.2 must be complete (Docker with PostgreSQL running)

### Prisma Schema
[Source: architecture.md#5.2-prisma-schema]

The full Prisma schema is extensive. Key models include:

```prisma
// database/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Platform {
  TWITTER
  REDDIT
  THREADS
}

enum OperationalMode {
  HELPFUL
  ENGAGEMENT
  HYBRID
  DISENGAGED
}

enum Archetype {
  CHECKLIST
  MYTHBUST
  COACH
  STORYLET
  HUMOR_LIGHT
  CREDIBILITY_ANCHOR
  CONFIDENT_RECOMMENDER
  PROBLEM_SOLUTION_DIRECT
}

// ... (see full enum list in architecture.md#5.2)

// ============================================
// CORE ENTITIES
// ============================================

model Author {
  id                String   @id @default(uuid())
  platform          Platform
  platformId        String   @map("platform_id")
  handle            String
  displayName       String?  @map("display_name")
  followerCount     Int      @default(0) @map("follower_count")
  isVerified        Boolean  @default(false) @map("is_verified")
  isPowerUser       Boolean  @default(false) @map("is_power_user")
  powerTier         PowerTier? @map("power_tier")
  archetypeTags     String[] @map("archetype_tags")
  relationshipScore Float    @default(0.5) @map("relationship_score")
  interactionHistory Json    @default("[]") @map("interaction_history")
  firstSeenAt       DateTime @default(now()) @map("first_seen_at")
  lastSeenAt        DateTime @default(now()) @map("last_seen_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  posts             Post[]
  champions         CommunityChampion[]

  @@unique([platform, platformId])
  @@index([platform, handle])
  @@index([isPowerUser])
  @@map("authors")
}

// ... (see full schema in architecture.md#5.2)
```

### Zod Validation Schemas
[Source: architecture.md#5.4-data-validation-rules]

```typescript
// shared/src/schemas/post.ts
import { z } from 'zod';

export const PostContentSchema = z.object({
  content: z.string()
    .min(1, 'Post content cannot be empty')
    .max(5000, 'Post content exceeds maximum length'),
  platform: z.enum(['TWITTER', 'REDDIT', 'THREADS']),
  platformPostId: z.string()
    .min(1)
    .max(100)
    .regex(/^[a-zA-Z0-9_-]+$/, 'Invalid post ID format'),
  authorHandle: z.string()
    .min(1)
    .max(50)
    .regex(/^[a-zA-Z0-9_]+$/, 'Invalid handle format'),
  keywordMatches: z.array(z.string())
    .min(1, 'Must match at least one keyword')
    .max(50, 'Too many keyword matches'),
});

export const ReplyContentSchema = z.object({
  content: z.string()
    .min(10, 'Reply too short')
    .max(1000, 'Reply exceeds maximum length')
    .refine(
      (val) => val.includes('—Antone (Vita)'),
      'Reply must include signature'
    )
    .refine(
      (val) => !/(cure|prevent|treat|clinically proven)/i.test(val),
      'Reply contains prohibited medical claims'
    ),
  utmCode: z.string()
    .regex(/^[a-z0-9_-]+$/, 'Invalid UTM code'),
});
```

### Data Retention Policy
[Source: architecture.md#5.5-data-retention-policy]

| Data Type | Retention | Archive Strategy |
|-----------|-----------|------------------|
| Posts | 90 days | Archive to JSON files |
| Decisions | 90 days | Archive with posts |
| Replies | Indefinite | Permanent audit trail |
| Authors | Indefinite | Permanent relationship memory |
| KPI Metrics | 2 years | Archive to CSV quarterly |
| Audit Logs | 3 years | Compressed JSON yearly |

### Migration Safety Rules
[Source: architecture.md#5.6-schema-migration-strategy]

- Never delete columns in production (deprecate + hide in code)
- Always add columns as nullable initially
- Use `@default` for non-nullable columns when adding
- Separate data migrations from schema migrations
- Document breaking changes in migration notes
- Always backup database before production migrations

### File Structure
```
database/
├── prisma/
│   ├── schema.prisma          # Full database schema
│   ├── migrations/            # Migration history
│   └── seed.ts                # Seed data script
├── package.json
└── tsconfig.json

shared/
└── src/
    └── schemas/
        ├── post.ts            # Post validation
        ├── reply.ts           # Reply validation
        └── author.ts          # Author validation
```

---

## Testing

### Test File Location
- Database tests: `database/tests/`
- Schema validation tests: `shared/tests/schemas/`

### Testing Standards
- Test all unique constraints
- Test all validation rules
- Test seed script execution
- Test migration up/down

### Story-Specific Testing Requirements
1. Verify `prisma migrate dev` runs successfully
2. Verify `prisma db seed` populates data
3. Verify Prisma Client types are generated
4. Test Zod schemas reject invalid data

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*

