# Story 1.5: Reddit API Authentication

## Status: Draft

## Story

**As** the system,  
**I want** to authenticate with Reddit API using OAuth 2.0,  
**so that** I can monitor subreddits and post comments on behalf of u/antone_vita account.

## Acceptance Criteria

1. Reddit Developer account created and script app registered
2. OAuth credentials (Client ID, Client Secret, Refresh Token) stored in `.env` file (development) or Docker secrets (production)
3. `snoowrap` SDK installed and configured
4. Authentication module created at `@backend/platforms/reddit/auth`
5. API client initialized with user agent and proper credentials
6. Test endpoint `/api/reddit/verify` successfully fetches u/antone_vita profile
7. Subreddit access tested (e.g., r/hangover read permission)
8. **Rate limiting implemented and logged**:
   - Token bucket algorithm: 60 requests/min
   - Rate limiter class: `@backend/utils/rate-limiter.ts` (reuse from Story 1.4)
   - Integration: All API calls go through `rateLimiter.acquire('default')`
   - Monitoring: Rate limit headers from Reddit API logged
   - Handling: Exceeded limit triggers exponential backoff (1min base delay)
9. **Circuit breaker pattern** implemented (same as Twitter):
   - Threshold: 5 consecutive failures → circuit opens
   - Timeout: 30 seconds, fail-fast when OPEN
   - Class: `@backend/utils/circuit-breaker.ts` (reuse from Story 1.4)

---

## Tasks / Subtasks

- [ ] **Task 1: Configure Rate Limiter for Reddit** (AC: 8)
  - [ ] Add Reddit bucket configuration to RateLimiter
  - [ ] Configure 60 requests/minute limit
  - [ ] Test rate limiter with Reddit-specific timing

- [ ] **Task 2: Create Reddit Auth Module** (AC: 4)
  - [ ] Create `backend/src/platforms/reddit/auth.ts`
  - [ ] Initialize Snoowrap client with OAuth credentials
  - [ ] Configure user agent: `Antone/1.0.0 (by /u/antone_vita)`
  - [ ] Load credentials from environment variables
  - [ ] Validate all required credentials present
  - [ ] Export authenticated client instance

- [ ] **Task 3: Create Reddit Client Class** (AC: 3, 5, 8, 9)
  - [ ] Create `backend/src/platforms/reddit/client.ts`
  - [ ] Integrate RateLimiter for all operations
  - [ ] Integrate CircuitBreaker for resilience
  - [ ] Implement `searchSubreddits(subreddits, query)` method
  - [ ] Implement `comment(submissionId, content)` method
  - [ ] Implement `getKarma()` method for karma tracking
  - [ ] Implement `verifyCredentials()` method
  - [ ] Add comprehensive error handling

- [ ] **Task 4: Create Verification Endpoint** (AC: 6, 7)
  - [ ] Create `backend/src/api/routes/reddit.ts`
  - [ ] Implement `GET /api/reddit/verify` endpoint
  - [ ] Return profile info and karma score
  - [ ] Test subreddit access permissions
  - [ ] Log rate limit information

- [ ] **Task 5: Add to Router** (AC: 6)
  - [ ] Register reddit routes in main Hono app
  - [ ] Add authentication middleware (optional for verify)

- [ ] **Task 6: Update Environment Template** (AC: 2)
  - [ ] Add Reddit credentials to `.env.example`
  - [ ] Add documentation for obtaining credentials
  - [ ] Document OAuth flow for refresh token

- [ ] **Task 7: Write Unit Tests** (AC: all)
  - [ ] Test Reddit client with mocked Snoowrap
  - [ ] Test rate limiter with Reddit config
  - [ ] Test karma retrieval
  - [ ] Test subreddit search

---

## Dev Notes

### Previous Story Insights
- Story 1.4 must be complete (provides RateLimiter and CircuitBreaker utilities)
- Reuse the same utility classes from 1.4

### Reddit Client Implementation
[Source: architecture.md#9.1-platform-api-clients]

```typescript
// backend/src/platforms/reddit/client.ts

import Snoowrap from 'snoowrap';
import { RateLimiter } from '../../utils/rate-limiter';
import { CircuitBreaker } from '../../utils/circuit-breaker';
import { logger } from '../../utils/logger';

export class RedditClient {
  private client: Snoowrap;
  private rateLimiter: RateLimiter;
  private circuitBreaker: CircuitBreaker;

  constructor() {
    this.client = new Snoowrap({
      userAgent: 'Antone/1.0.0 (by /u/antone_vita)',
      clientId: process.env.REDDIT_CLIENT_ID!,
      clientSecret: process.env.REDDIT_CLIENT_SECRET!,
      refreshToken: process.env.REDDIT_REFRESH_TOKEN!,
    });

    // 60 requests/min
    this.rateLimiter = new RateLimiter({
      default: { max: 60, windowMs: 60 * 1000 },
    });

    this.circuitBreaker = new CircuitBreaker({
      threshold: 5,
      timeout: 30000,
    });
  }

  async searchSubreddits(subreddits: string[], query: string): Promise<Submission[]> {
    await this.rateLimiter.acquire('default');
    
    return this.circuitBreaker.execute(async () => {
      const results: Submission[] = [];
      
      for (const sub of subreddits) {
        const posts = await this.client
          .getSubreddit(sub)
          .search({ query, time: 'day', sort: 'new' });
        results.push(...posts);
      }

      return results;
    });
  }

  async comment(submissionId: string, content: string): Promise<string> {
    await this.rateLimiter.acquire('default');
    
    return this.circuitBreaker.execute(async () => {
      const submission = await this.client.getSubmission(submissionId);
      const comment = await submission.reply(content);
      return comment.id;
    });
  }

  async getKarma(): Promise<number> {
    await this.rateLimiter.acquire('default');
    
    return this.circuitBreaker.execute(async () => {
      const me = await this.client.getMe();
      return me.comment_karma + me.link_karma;
    });
  }

  async verifyCredentials(): Promise<{ valid: boolean; karma: number; username: string }> {
    try {
      const me = await this.client.getMe();
      return {
        valid: true,
        karma: me.comment_karma + me.link_karma,
        username: me.name,
      };
    } catch (error) {
      logger.error('Reddit credential verification failed', { error });
      return { valid: false, karma: 0, username: '' };
    }
  }
}
```

### Reddit Auth Module
```typescript
// backend/src/platforms/reddit/auth.ts

import Snoowrap from 'snoowrap';
import { logger } from '../../utils/logger';

export function createRedditClient(): Snoowrap {
  const requiredEnvVars = [
    'REDDIT_CLIENT_ID',
    'REDDIT_CLIENT_SECRET',
    'REDDIT_REFRESH_TOKEN',
  ];

  for (const envVar of requiredEnvVars) {
    if (!process.env[envVar]) {
      throw new Error(`Missing required environment variable: ${envVar}`);
    }
  }

  logger.info('Initializing Reddit client');

  return new Snoowrap({
    userAgent: 'Antone/1.0.0 (by /u/antone_vita)',
    clientId: process.env.REDDIT_CLIENT_ID!,
    clientSecret: process.env.REDDIT_CLIENT_SECRET!,
    refreshToken: process.env.REDDIT_REFRESH_TOKEN!,
  });
}
```

### Environment Variables
```bash
# Reddit API Credentials
REDDIT_CLIENT_ID=your_client_id
REDDIT_CLIENT_SECRET=your_client_secret
REDDIT_REFRESH_TOKEN=your_refresh_token
```

### How to Obtain Reddit Credentials
1. Go to https://www.reddit.com/prefs/apps
2. Click "create another app..."
3. Select "script" type
4. Set redirect URI to http://localhost:8080
5. Copy Client ID (under app name) and Client Secret
6. Use OAuth flow to obtain refresh token

### File Structure
```
backend/src/
├── platforms/
│   ├── twitter/
│   │   ├── auth.ts
│   │   └── client.ts
│   └── reddit/
│       ├── auth.ts              # Authentication module
│       └── client.ts            # RedditClient class
└── api/
    └── routes/
        ├── twitter.ts
        └── reddit.ts            # Reddit verification endpoint
```

### Error Handling
[Source: architecture.md#9.2-integration-failure-matrix]

| Error | Detection | Handling |
|-------|-----------|----------|
| Rate limit exceeded | HTTP 429 | Queue with exponential backoff (1min base) |
| Comment removed by mod | Post success, later 404 | Log removal, update safety KPIs |
| Subreddit banned | 403 response | Remove from monitoring list |
| Authentication failed | 401 response | Alert critical, refresh token |

---

## Testing

### Test File Location
- `backend/tests/unit/platforms/reddit/client.test.ts`
- `backend/tests/integration/api/reddit.test.ts`

### Testing Standards
- Mock Snoowrap responses
- Test rate limiter with Reddit timing
- Test karma retrieval
- Test subreddit search pagination

### Story-Specific Testing Requirements
1. Verify credentials returns username and karma
2. Subreddit search returns submissions
3. Rate limiter enforces 60 req/min
4. Circuit breaker works with Reddit client
5. `/api/reddit/verify` returns correct data

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*

