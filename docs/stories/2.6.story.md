# Story 2.6: Primary Safety Protocol

## Status: Draft

## Story

**As a** the decision engine,  
**I want** to detect sensitive topics and immediately force Disengaged Mode,  
**so that** the bot never engages with posts about death, addiction recovery, medical emergencies, or minors.

## Acceptance Criteria

1. Module created at `@backend/analysis/safety-protocol.ts`
2. Keyword detection for sensitive topics:
   - Death/harm: "suicide", "kill myself", "die", "funeral"
   - Addiction: "AA meeting", "recovery", "relapse", "sober"
   - Medical: "ER", "hospital", "chest pain", "seizure"
   - Minors: "high school", "college freshman", "underage"
   - Pregnancy: "pregnant", "breastfeeding"
3. Distress Probability calculation using sentiment analysis + author history
4. Safety flags added to decision object: `safety_flags: ["death_mention"]`
5. Any safety flag present → Mode forced to **Disengaged**, override all other signals
6. Decision logged with safety_reason for audit
7. Unit tests with 40+ sensitive examples trigger disengage (100% accuracy required)
8. False positives (hyperbole) logged for refinement but still disengage (conservative default)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Safety Protocol Module** (AC: 1, 4, 5)
  - [ ] Create `backend/src/analysis/safety-protocol.ts`
  - [ ] Implement `checkSafetyProtocol(content, author)` function
  - [ ] Return safety result with flags and shouldDisengage boolean
  - [ ] Include reasoning for audit trail

- [ ] **Task 2: Implement Keyword Detection** (AC: 2)
  - [ ] Death/harm keywords: suicide, kill myself, die, funeral, harm, end it
  - [ ] Addiction keywords: AA, recovery, relapse, sober, sobriety, rehab
  - [ ] Medical keywords: ER, hospital, ambulance, chest pain, seizure, emergency
  - [ ] Minors keywords: high school, freshman, underage, teenager
  - [ ] Pregnancy keywords: pregnant, breastfeeding, nursing
  - [ ] Use case-insensitive matching

- [ ] **Task 3: Implement Distress Probability** (AC: 3)
  - [ ] Analyze sentiment score (negative sentiment + keywords = higher distress)
  - [ ] Check author history for prior distress signals
  - [ ] Calculate probability 0.0-1.0
  - [ ] Flag if probability > 0.6

- [ ] **Task 4: Implement Safety Override Logic** (AC: 5)
  - [ ] Any flag present → shouldDisengage = true
  - [ ] Decision engine must respect this override
  - [ ] Log override action with context

- [ ] **Task 5: Implement Audit Logging** (AC: 6, 8)
  - [ ] Log all safety triggers
  - [ ] Include full context (post content, flags, reasoning)
  - [ ] Flag false positives for review
  - [ ] Track safety trigger rate

- [ ] **Task 6: Write Unit Tests** (AC: 7)
  - [ ] Test 40+ sensitive examples
  - [ ] Test death/harm keywords
  - [ ] Test addiction keywords
  - [ ] Test medical emergency keywords
  - [ ] Test minors keywords
  - [ ] Test pregnancy keywords
  - [ ] Verify 100% trigger rate (conservative)
  - [ ] Test hyperbole cases (still disengage)

---

## Dev Notes

### Previous Story Insights
- This module is called early in decision flow (Story 2.5)
- Acts as a gate before any engagement decisions
- Conservative approach: better false positive than false negative

### Safety Protocol Implementation
```typescript
// backend/src/analysis/safety-protocol.ts

import { Author } from '@prisma/client';
import { logger } from '../utils/logger';

interface SafetyResult {
  shouldDisengage: boolean;
  flags: string[];
  distressProbability: number;
  reasoning: string;
}

const SAFETY_KEYWORDS = {
  death_harm: [
    /\bsuicide\b/i,
    /\bkill myself\b/i,
    /\bdie\b/i,
    /\bfuneral\b/i,
    /\bending it all\b/i,
    /\bcan't go on\b/i,
    /\bharm myself\b/i,
    /\bnot worth living\b/i,
  ],
  addiction: [
    /\bAA meeting\b/i,
    /\brecovery\b/i,
    /\brelapse\b/i,
    /\bsober\b/i,
    /\bsobriety\b/i,
    /\brehab\b/i,
    /\b12 steps?\b/i,
  ],
  medical: [
    /\bER\b/i,
    /\bhospital\b/i,
    /\bambulance\b/i,
    /\bchest pain\b/i,
    /\bseizure\b/i,
    /\bemergency room\b/i,
    /\bcalling 911\b/i,
    /\bmedical emergency\b/i,
  ],
  minors: [
    /\bhigh school\b/i,
    /\bcollege freshman\b/i,
    /\bunderage\b/i,
    /\bteenager\b/i,
    /\b17 year old\b/i,
    /\b16 year old\b/i,
  ],
  pregnancy: [
    /\bpregnant\b/i,
    /\bbreastfeeding\b/i,
    /\bnursing\b/i,
    /\bexpecting\b/i,
  ],
};

export async function checkSafetyProtocol(
  content: string,
  author?: Author
): Promise<SafetyResult> {
  const flags: string[] = [];
  const reasons: string[] = [];

  // Check each category
  for (const [category, patterns] of Object.entries(SAFETY_KEYWORDS)) {
    for (const pattern of patterns) {
      if (pattern.test(content)) {
        flags.push(category.toUpperCase());
        reasons.push(`Detected ${category} keyword: ${pattern.source}`);
        break; // One flag per category
      }
    }
  }

  // Calculate distress probability
  const distress = calculateDistressProbability(content, author, flags);

  // Determine if should disengage
  const shouldDisengage = flags.length > 0 || distress > 0.6;

  const result: SafetyResult = {
    shouldDisengage,
    flags,
    distressProbability: distress,
    reasoning: reasons.join('; ') || 'No safety concerns detected',
  };

  // Log if safety triggered
  if (shouldDisengage) {
    logger.warn('Safety protocol triggered', {
      flags,
      distress,
      content: content.substring(0, 100), // First 100 chars
      authorId: author?.id,
    });
  }

  return result;
}

function calculateDistressProbability(
  content: string,
  author: Author | undefined,
  flags: string[]
): number {
  let probability = 0.0;

  // Base probability from flags
  if (flags.length > 0) {
    probability += 0.5;
  }

  // Increase if multiple sensitive keywords
  if (flags.length > 1) {
    probability += 0.2;
  }

  // Sentiment analysis indicators
  const negativeIntensifiers = [
    /\bcan't\b/i,
    /\bwon't\b/i,
    /\bhelp me\b/i,
    /\bplease\b/i,
    /\bdesperate\b/i,
  ];

  let intensifierCount = 0;
  for (const pattern of negativeIntensifiers) {
    if (pattern.test(content)) {
      intensifierCount++;
    }
  }

  probability += Math.min(intensifierCount * 0.1, 0.3);

  // Check author history for prior distress (if available)
  if (author && author.interactionHistory) {
    const history = author.interactionHistory as any[];
    const hasPriorDistress = history.some((event: any) => 
      event.type === 'safety_concern'
    );
    if (hasPriorDistress) {
      probability += 0.2;
    }
  }

  // Cap at 1.0
  return Math.min(probability, 1.0);
}

// Helper to check for specific categories
export function hasSafetyFlag(result: SafetyResult, category: string): boolean {
  return result.flags.includes(category.toUpperCase());
}
```

### Safety Categories and Examples

**Death/Harm (100% disengage):**
- "I want to kill myself"
- "Not worth living anymore"
- "Funeral tomorrow"
- "Thinking about ending it all"

**Addiction Recovery (100% disengage):**
- "Going to my first AA meeting"
- "3 months sober today"
- "Afraid I'll relapse"
- "Recovery is hard"

**Medical Emergency (100% disengage):**
- "Chest pain won't stop"
- "Called 911"
- "In the ER now"
- "Having a seizure"

**Minors (100% disengage):**
- "High school party last night"
- "College freshman here"
- "I'm 17 and..."
- "Underage drinking"

**Pregnancy (100% disengage):**
- "I'm pregnant and..."
- "Breastfeeding mom"
- "Expecting in 3 months"

### False Positives (Conservative Approach)
Even hyperbole triggers disengagement:
- "I'm dying from this hangover" → Still disengage (contains "dying")
- "Kill me now" → Still disengage (contains "kill")
- "This is killing me" → Still disengage

**Rationale**: Better to miss an engagement opportunity than risk harm.

### Audit Trail
[Source: architecture.md#7.2-core-domain-modules]

All safety triggers logged:
```json
{
  "level": "WARN",
  "message": "Safety protocol triggered",
  "timestamp": "2025-12-01T10:30:00Z",
  "flags": ["DEATH_HARM"],
  "distressProbability": 0.75,
  "content": "I can't take this anymore, want to die",
  "authorId": "author-123",
  "postId": "post-456"
}
```

### File Structure
```
backend/src/
└── analysis/
    ├── signal-1-linguistic.ts
    ├── signal-2-author.ts
    ├── signal-3-velocity.ts
    ├── signal-4-semantic.ts
    ├── safety-protocol.ts       # THIS STORY
    └── decision-engine.ts
```

---

## Testing

### Test File Location
- `backend/tests/unit/analysis/safety-protocol.test.ts`

### Testing Standards
- Test all keyword categories
- 100% accuracy required (no misses allowed)
- Test false positives (hyperbole)
- Test distress probability calculation

### Story-Specific Testing Requirements
1. All 40+ sensitive examples trigger disengage
2. Each category tested separately
3. Multiple flags increase distress probability
4. Author history affects probability
5. Conservative approach: hyperbole still triggers
6. Logging works for all triggers

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*

