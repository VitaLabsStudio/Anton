# Story 3.6: Manual Approval Dashboard Integration

## Status: Draft

## Story

**As a** human operator,  
**I want** a streamlined approval interface integrated into the Master Dashboard,  
**so that** I can efficiently review, edit, and approve replies while seeing their predicted impact.

## Acceptance Criteria

1. **Approval Queue Widget** integrated into Mission Control (View 1):
   - Shows pending count badge
   - Quick-preview of top 3 pending replies
2. **Dedicated Review View** at `/dashboard/approvals`:
   - Split screen: Post context (left) vs Generated reply (right)
   - "Why this reply?" explanation box
   - Predicted KPI impact display
3. **Action Interface**:
   - Approve: One-click publish
   - Edit: Inline text editor with character count
   - Reject: Dropdown for reason
   - Regenerate: Request new draft
4. **Bulk Actions**: "Approve all high-confidence (>90%)" button
5. **Mobile-friendly** review mode
6. **Audit Trail**: All human edits logged
7. **Safety Warnings**: Highlight phrases that triggered safety flags
8. **Real-time status**: Updates when another operator approves

---

## Tasks / Subtasks

- [ ] **Task 1: Create Approvals API** (AC: 1, 2)
  - [ ] Create `backend/src/api/routes/approvals.ts`
  - [ ] Implement GET /api/approvals/pending
  - [ ] Implement POST /api/approvals/:id/approve
  - [ ] Implement POST /api/approvals/:id/reject
  - [ ] Implement PUT /api/approvals/:id/edit
  - [ ] Implement POST /api/approvals/:id/regenerate

- [ ] **Task 2: Create Approval Queue Widget** (AC: 1)
  - [ ] Create `dashboard/src/components/approval/ApprovalQueueWidget.tsx`
  - [ ] Show pending count badge
  - [ ] Quick preview top 3
  - [ ] Link to full review view

- [ ] **Task 3: Create Approvals Page** (AC: 2)
  - [ ] Create `dashboard/src/app/approvals/page.tsx`
  - [ ] Split screen layout
  - [ ] Post context on left
  - [ ] Generated reply on right
  - [ ] "Why this reply?" section

- [ ] **Task 4: Create Action Buttons** (AC: 3)
  - [ ] Approve button with confirmation
  - [ ] Edit button with inline editor
  - [ ] Reject button with reason dropdown
  - [ ] Regenerate button with instruction input

- [ ] **Task 5: Implement Bulk Actions** (AC: 4)
  - [ ] "Approve all >90% confidence" button
  - [ ] Batch approval API endpoint
  - [ ] Confirmation modal

- [ ] **Task 6: Implement Mobile View** (AC: 5)
  - [ ] Responsive design
  - [ ] Stack layout on mobile
  - [ ] Touch-friendly buttons

- [ ] **Task 7: Implement Audit Trail** (AC: 6)
  - [ ] Log all edits to audit_logs table
  - [ ] Track who approved/rejected
  - [ ] Track edit history

- [ ] **Task 8: Add Safety Warnings** (AC: 7)
  - [ ] Highlight safety flag keywords
  - [ ] Show warning badge
  - [ ] Display safety reasoning

- [ ] **Task 9: Implement Real-time Updates** (AC: 8)
  - [ ] WebSocket for status changes
  - [ ] Update UI when reply approved
  - [ ] Show "Already approved by X" message

---

## Dev Notes

### Approvals API
```typescript
// backend/src/api/routes/approvals.ts

import { Hono } from 'hono';
import { prisma } from '../../db';
import { authMiddleware } from '../middleware/auth';
import { twitterPoster } from '../../platforms/twitter/poster';
import { redditPoster } from '../../platforms/reddit/poster';
import { threadsPoster } from '../../platforms/threads/poster';

const approvals = new Hono();

// Get pending approvals
approvals.get('/pending', authMiddleware, async (c) => {
  const replies = await prisma.reply.findMany({
    where: { approvalStatus: 'PENDING' },
    include: {
      decision: {
        include: {
          post: {
            include: { author: true },
          },
        },
      },
    },
    orderBy: { createdAt: 'desc' },
  });

  return c.json({ replies, count: replies.length });
});

// Approve and post
approvals.post('/:id/approve', authMiddleware, async (c) => {
  const id = c.req.param('id');
  const user = c.get('user');

  const reply = await prisma.reply.update({
    where: { id },
    data: {
      approvalStatus: 'APPROVED',
      approvedBy: user.id,
      approvedAt: new Date(),
    },
    include: { decision: { include: { post: true } } },
  });

  // Post to platform
  let posted = false;
  switch (reply.platform) {
    case 'TWITTER':
      const twitterResult = await twitterPoster.postReply(id);
      posted = twitterResult.success;
      break;
    case 'REDDIT':
      const redditResult = await redditPoster.postReply(id);
      posted = redditResult.success;
      break;
    case 'THREADS':
      const threadsResult = await threadsPoster.postReply(id);
      posted = threadsResult.success;
      break;
  }

  // Log to audit trail
  await prisma.auditLog.create({
    data: {
      entityType: 'reply',
      entityId: id,
      action: 'approve',
      actor: user.id,
      detailsJson: { posted },
    },
  });

  return c.json({ success: true, reply, posted });
});

// Edit reply
approvals.put('/:id/edit', authMiddleware, async (c) => {
  const id = c.req.param('id');
  const { content } = await c.req.json();
  const user = c.get('user');

  const reply = await prisma.reply.update({
    where: { id },
    data: { content },
  });

  // Log edit
  await prisma.auditLog.create({
    data: {
      entityType: 'reply',
      entityId: id,
      action: 'edit',
      actor: user.id,
      detailsJson: { originalContent: reply.content, newContent: content },
    },
  });

  return c.json({ success: true, reply });
});

// Reject reply
approvals.post('/:id/reject', authMiddleware, async (c) => {
  const id = c.req.param('id');
  const { reason } = await c.req.json();
  const user = c.get('user');

  await prisma.reply.update({
    where: { id },
    data: { approvalStatus: 'REJECTED' },
  });

  await prisma.auditLog.create({
    data: {
      entityType: 'reply',
      entityId: id,
      action: 'reject',
      actor: user.id,
      detailsJson: { reason },
    },
  });

  return c.json({ success: true });
});

export { approvals };
```

### File Structure
```
backend/src/
└── api/
    └── routes/
        └── approvals.ts         # THIS STORY

dashboard/src/
├── app/
│   └── approvals/
│       └── page.tsx             # THIS STORY
└── components/
    └── approval/
        ├── ApprovalCard.tsx     # THIS STORY
        ├── EditModal.tsx        # THIS STORY
        └── BulkActions.tsx      # THIS STORY
```

---

## Testing

### Test File Location
- `dashboard/tests/components/approval.test.tsx`
- `backend/tests/integration/api/approvals.test.ts`

### Testing Standards
- Test all approval actions
- Test UI components
- Test real-time updates

### Story-Specific Testing Requirements
1. Pending count displays correctly
2. Approve action posts to platform
3. Edit saves changes
4. Reject removes from queue
5. Bulk approve works
6. Mobile view responsive
7. Audit trail captures all actions

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*













