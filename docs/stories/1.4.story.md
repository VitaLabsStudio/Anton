# Story 1.4: Twitter/X API Authentication

## Status: Draft

## Story

**As** the system,  
**I want** to authenticate with Twitter API v2 using OAuth 2.0,  
**so that** I can monitor tweets and post replies on behalf of @antone_vita account.

## Acceptance Criteria

1. Twitter Developer account created and app registered
2. OAuth 2.0 credentials stored in `.env` file (development) or Docker secrets (production):
   - TWITTER_API_KEY
   - TWITTER_API_SECRET
   - TWITTER_ACCESS_TOKEN
   - TWITTER_ACCESS_SECRET
   - TWITTER_BEARER_TOKEN
   Note: Self-hosted deployment does NOT use Fly.io
3. `twitter-api-v2` SDK installed and configured
4. Authentication module created at `@backend/platforms/twitter/auth`
5. API client initialized with proper credentials and error handling
6. Test endpoint `/api/twitter/verify` successfully calls Twitter API (verify credentials)
7. Rate limit headers logged for monitoring
8. **Rate limiting implemented and logged**:
   - Token bucket algorithm: 900 reads/15min, 300 writes/15min
   - Rate limiter class: `@backend/utils/rate-limiter.ts`
   - Integration: All API calls go through `rateLimiter.acquire('read'|'write')`
   - Monitoring: Rate limit headers logged for analysis
   - Handling: Approaching limit (>80%) triggers warning, exceeded triggers queue with retry after reset window
9. **Circuit breaker pattern** implemented for resilience:
   - Threshold: 5 consecutive failures → circuit opens
   - Timeout: 30 seconds (test recovery with half-open state)
   - Metrics: Track circuit state changes (CLOSED → OPEN → HALF_OPEN)
   - Fail-fast: When OPEN, reject immediately without calling API
   - Class: `@backend/utils/circuit-breaker.ts`
10. Authentication errors handled gracefully with retry logic (max 3 retries, exponential backoff)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Rate Limiter Utility** (AC: 8)
  - [ ] Create `backend/src/utils/rate-limiter.ts`
  - [ ] Implement token bucket algorithm
  - [ ] Support multiple bucket types (read, write, default)
  - [ ] Implement `acquire(type)` method that waits if limit reached
  - [ ] Add warning logging at 80% capacity
  - [ ] Export RateLimiter class

- [ ] **Task 2: Create Circuit Breaker Utility** (AC: 9)
  - [ ] Create `backend/src/utils/circuit-breaker.ts`
  - [ ] Implement states: CLOSED, OPEN, HALF_OPEN
  - [ ] Configure threshold (5 failures) and timeout (30s)
  - [ ] Implement `execute(fn)` method wrapping API calls
  - [ ] Add state change logging and metrics
  - [ ] Export CircuitBreaker class

- [ ] **Task 3: Create Twitter Auth Module** (AC: 4, 5)
  - [ ] Create `backend/src/platforms/twitter/auth.ts`
  - [ ] Initialize TwitterApi client from twitter-api-v2
  - [ ] Load credentials from environment variables
  - [ ] Validate all required credentials present
  - [ ] Export authenticated client instance

- [ ] **Task 4: Create Twitter Client Class** (AC: 3, 5, 8, 9)
  - [ ] Create `backend/src/platforms/twitter/client.ts`
  - [ ] Integrate RateLimiter for read/write operations
  - [ ] Integrate CircuitBreaker for resilience
  - [ ] Implement `search(query, options)` method
  - [ ] Implement `reply(tweetId, content)` method
  - [ ] Implement `verifyCredentials()` method
  - [ ] Add comprehensive error handling

- [ ] **Task 5: Implement Retry Logic** (AC: 10)
  - [ ] Create retry wrapper with exponential backoff
  - [ ] Configure max 3 retries
  - [ ] Backoff: 1s → 2s → 4s
  - [ ] Add jitter (±20%) to prevent thundering herd
  - [ ] Only retry on transient errors (5xx, network)

- [ ] **Task 6: Create Verification Endpoint** (AC: 6, 7)
  - [ ] Create `backend/src/api/routes/twitter.ts`
  - [ ] Implement `GET /api/twitter/verify` endpoint
  - [ ] Call `verifyCredentials()` method
  - [ ] Return auth status and rate limit info
  - [ ] Log rate limit headers

- [ ] **Task 7: Add to Router** (AC: 6)
  - [ ] Register twitter routes in main Hono app
  - [ ] Add authentication middleware (optional for verify)

- [ ] **Task 8: Update Environment Template** (AC: 2)
  - [ ] Add Twitter credentials to `.env.example`
  - [ ] Add documentation comments for each variable
  - [ ] Document how to obtain credentials

- [ ] **Task 9: Write Unit Tests** (AC: all)
  - [ ] Test rate limiter behavior
  - [ ] Test circuit breaker state transitions
  - [ ] Test Twitter client with mocked API
  - [ ] Test retry logic

---

## Dev Notes

### Previous Story Insights
- Story 1.1-1.3 must be complete
- Requires backend server running (from 1.2)
- Requires database for future logging (from 1.3)

### Twitter Client Implementation
[Source: architecture.md#9.1-platform-api-clients]

```typescript
// backend/src/platforms/twitter/client.ts

import { TwitterApi } from 'twitter-api-v2';
import { RateLimiter } from '../../utils/rate-limiter';
import { CircuitBreaker } from '../../utils/circuit-breaker';
import { logger } from '../../utils/logger';

export class TwitterClient {
  private client: TwitterApi;
  private rateLimiter: RateLimiter;
  private circuitBreaker: CircuitBreaker;

  constructor() {
    this.client = new TwitterApi({
      appKey: process.env.TWITTER_API_KEY!,
      appSecret: process.env.TWITTER_API_SECRET!,
      accessToken: process.env.TWITTER_ACCESS_TOKEN!,
      accessSecret: process.env.TWITTER_ACCESS_SECRET!,
    });

    // 300 posts/15min, 900 reads/15min
    this.rateLimiter = new RateLimiter({
      read: { max: 900, windowMs: 15 * 60 * 1000 },
      write: { max: 300, windowMs: 15 * 60 * 1000 },
    });

    this.circuitBreaker = new CircuitBreaker({
      threshold: 5,
      timeout: 30000,
    });
  }

  async search(query: string, options: SearchOptions): Promise<Tweet[]> {
    await this.rateLimiter.acquire('read');
    
    return this.circuitBreaker.execute(async () => {
      const result = await this.client.v2.search(query, {
        max_results: options.maxResults,
        since_id: options.sinceId,
        'tweet.fields': ['created_at', 'public_metrics', 'author_id'],
        'user.fields': ['verified', 'public_metrics'],
        expansions: ['author_id'],
      });

      return result.data.data || [];
    });
  }

  async reply(tweetId: string, content: string): Promise<string> {
    await this.rateLimiter.acquire('write');
    
    return this.circuitBreaker.execute(async () => {
      const result = await this.client.v2.reply(content, tweetId);
      return result.data.id;
    });
  }

  async verifyCredentials(): Promise<boolean> {
    try {
      await this.client.v2.me();
      return true;
    } catch (error) {
      logger.error('Twitter credential verification failed', { error });
      return false;
    }
  }
}
```

### Rate Limiter Implementation
[Source: architecture.md#9.1-platform-api-clients]

```typescript
// backend/src/utils/rate-limiter.ts

interface BucketConfig {
  max: number;
  windowMs: number;
}

export class RateLimiter {
  private buckets: Map<string, { tokens: number; lastRefill: number }>;
  private config: Record<string, BucketConfig>;

  constructor(config: Record<string, BucketConfig>) {
    this.config = config;
    this.buckets = new Map();
  }

  async acquire(type: string): Promise<void> {
    const config = this.config[type];
    if (!config) throw new Error(`Unknown bucket type: ${type}`);

    // Refill tokens based on time elapsed
    const bucket = this.getBucket(type, config);
    
    // Check capacity warning at 80%
    if (bucket.tokens <= config.max * 0.2) {
      logger.warn(`Rate limit warning: ${type} at ${bucket.tokens}/${config.max}`);
    }

    // Wait if no tokens available
    if (bucket.tokens <= 0) {
      const waitMs = config.windowMs - (Date.now() - bucket.lastRefill);
      logger.info(`Rate limit reached, waiting ${waitMs}ms`);
      await this.sleep(waitMs);
      bucket.tokens = config.max;
      bucket.lastRefill = Date.now();
    }

    bucket.tokens--;
  }

  private getBucket(type: string, config: BucketConfig) {
    if (!this.buckets.has(type)) {
      this.buckets.set(type, { tokens: config.max, lastRefill: Date.now() });
    }
    return this.buckets.get(type)!;
  }

  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### Circuit Breaker Implementation
[Source: architecture.md#9.2-integration-failure-matrix]

```typescript
// backend/src/utils/circuit-breaker.ts

type CircuitState = 'CLOSED' | 'OPEN' | 'HALF_OPEN';

interface CircuitBreakerConfig {
  threshold: number;  // failures before opening
  timeout: number;    // ms before trying half-open
}

export class CircuitBreaker {
  private state: CircuitState = 'CLOSED';
  private failures: number = 0;
  private lastFailure: number = 0;
  private config: CircuitBreakerConfig;

  constructor(config: CircuitBreakerConfig) {
    this.config = config;
  }

  async execute<T>(fn: () => Promise<T>): Promise<T> {
    if (this.state === 'OPEN') {
      if (Date.now() - this.lastFailure > this.config.timeout) {
        this.state = 'HALF_OPEN';
        logger.info('Circuit breaker entering HALF_OPEN state');
      } else {
        throw new Error('Circuit breaker is OPEN');
      }
    }

    try {
      const result = await fn();
      this.onSuccess();
      return result;
    } catch (error) {
      this.onFailure();
      throw error;
    }
  }

  private onSuccess(): void {
    this.failures = 0;
    if (this.state === 'HALF_OPEN') {
      this.state = 'CLOSED';
      logger.info('Circuit breaker CLOSED after successful recovery');
    }
  }

  private onFailure(): void {
    this.failures++;
    this.lastFailure = Date.now();
    
    if (this.failures >= this.config.threshold) {
      this.state = 'OPEN';
      logger.error(`Circuit breaker OPEN after ${this.failures} failures`);
    }
  }

  getState(): CircuitState {
    return this.state;
  }
}
```

### Environment Variables
```bash
# Twitter API Credentials
TWITTER_API_KEY=your_api_key
TWITTER_API_SECRET=your_api_secret
TWITTER_ACCESS_TOKEN=your_access_token
TWITTER_ACCESS_SECRET=your_access_secret
TWITTER_BEARER_TOKEN=your_bearer_token
```

### File Structure
```
backend/src/
├── platforms/
│   └── twitter/
│       ├── auth.ts              # Authentication module
│       └── client.ts            # TwitterClient class
├── utils/
│   ├── rate-limiter.ts          # Token bucket rate limiter
│   └── circuit-breaker.ts       # Circuit breaker pattern
└── api/
    └── routes/
        └── twitter.ts           # Twitter verification endpoint
```

---

## Testing

### Test File Location
- `backend/tests/unit/utils/rate-limiter.test.ts`
- `backend/tests/unit/utils/circuit-breaker.test.ts`
- `backend/tests/unit/platforms/twitter/client.test.ts`

### Testing Standards
- Mock Twitter API responses
- Test rate limiter token depletion and refill
- Test circuit breaker state transitions
- Test retry logic with simulated failures

### Story-Specific Testing Requirements
1. Rate limiter blocks when tokens exhausted
2. Circuit breaker opens after 5 failures
3. Circuit breaker recovers in half-open state
4. Retry logic respects max attempts
5. `/api/twitter/verify` returns correct status

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results
*To be filled by QA Agent*

